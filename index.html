<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Math</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            color: #ffffff;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #00bfff, #0080ff);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #ff00ff, #00ffff);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .app-title h1 {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .app-title p {
            font-size: 12px;
            opacity: 0.9;
        }

        .header-icons {
            display: flex;
            gap: 15px;
            font-size: 24px;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Progress Line */
        .progress-line {
            height: 4px;
            background: linear-gradient(90deg, #00bfff, #0080ff);
            margin-bottom: 20px;
        }

        /* Headings */
        h2 {
            color: #00bfff;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .section-header {
            color: #00bfff;
            font-size: 18px;
            font-weight: bold;
            margin: 30px 0 15px 0;
            padding-left: 12px;
            border-left: 4px solid #00bfff;
        }

        /* Stats Cards */
        .stats-card {
            background: #1c2128;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            background: #0d1117;
            padding: 15px 10px;
            border-radius: 12px;
        }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00bfff;
        }

        .stat-label {
            font-size: 11px;
            color: #8b949e;
            margin-top: 5px;
        }

        /* Summary List */
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 18px;
            margin: 10px 0;
            background: #0d1117;
            border-radius: 10px;
        }

        .summary-item span:last-child {
            font-weight: bold;
        }

        /* Daily Quiz Card */
        .daily-quiz {
            background: linear-gradient(135deg, rgba(255, 77, 109, 0.2), rgba(255, 149, 0, 0.2));
            border: 2px solid #ff4d6d;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .daily-quiz-left h3 {
            color: #ff4d6d;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .daily-quiz-left p {
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .daily-quiz-date {
            background: rgba(0, 191, 255, 0.3);
            color: #00bfff;
            padding: 5px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
        }

        .daily-quiz-right {
            text-align: center;
        }

        .not-attempted {
            color: #ff4d6d;
            font-size: 12px;
            font-weight: bold;
        }

        /* Action Cards */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-card {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-radius: 16px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .action-card:hover {
            transform: translateY(-5px);
        }

        .action-card:first-child {
            background: linear-gradient(135deg, #a89af0, #9b87f5);
        }

        .action-card:last-child {
            background: linear-gradient(135deg, #ff6b9d, #ff4d6d);
        }

        .action-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .action-card p {
            font-size: 13px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .btn-start {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-start:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Topics Grid */
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .topic-card {
            background: #1c2128;
            border-radius: 14px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .topic-card:hover {
            border-color: #00bfff;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 191, 255, 0.3);
        }

        .topic-icon {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border-radius: 10px;
            background: #0d1117;
        }

        .topic-name {
            font-weight: 500;
            font-size: 15px;
        }

        /* Date Range Selector */
        .date-selector {
            background: #1c2128;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .date-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .date-btn {
            background: #0d1117;
            border: 2px solid transparent;
            color: white;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .date-btn.active {
            background: #00bfff;
            color: #0d1117;
            font-weight: bold;
        }

        .date-btn:hover:not(.active) {
            border-color: #00bfff;
        }

        .date-range-display {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: #8b949e;
        }

        .date-range-display span {
            color: white;
            font-weight: bold;
        }

        .select-date-btn {
            background: #00bfff;
            color: #0d1117;
            border: none;
            padding: 14px;
            border-radius: 10px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            font-size: 15px;
        }

        /* Error Practice Section Styles */
        .error-sections-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .error-section-card {
            background: #1c2128;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
        }

        .error-section-card:hover {
            transform: translateY(-3px);
            border-color: #ff4d6d;
            box-shadow: 0 4px 12px rgba(255, 77, 109, 0.3);
        }

        .error-section-card.has-errors {
            border-color: rgba(255, 77, 109, 0.5);
        }

        .error-section-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .error-section-name {
            font-size: 15px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .error-count {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .error-count-badge {
            background: linear-gradient(135deg, #ff4d6d, #ff9500);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .error-accuracy {
            font-size: 12px;
            color: #8b949e;
            margin-top: 5px;
        }

        .error-detail-item {
            background: #0d1117;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 3px solid #f44336;
        }

        .error-question {
            font-size: 15px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .error-answers {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 13px;
            margin-top: 8px;
        }

        .user-answer {
            color: #f44336;
            padding: 4px 10px;
            background: rgba(244, 67, 54, 0.2);
            border-radius: 6px;
        }

        .correct-answer {
            color: #4caf50;
            padding: 4px 10px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 6px;
        }

        .arrow {
            color: #8b949e;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Account Section */
        .account-section {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .account-header {
            text-align: center;
            padding: 30px 20px;
            background: #1c2128;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .profile-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 4px solid #00bfff;
            position: relative;
            cursor: pointer;
        }

        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-photo:hover::after {
            content: 'ðŸ“·';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .profile-email {
            font-size: 14px;
            color: #8b949e;
        }

        .edit-profile-btn {
            background: #00bfff;
            color: #0d1117;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .edit-profile-btn:hover {
            background: #00a8e6;
            transform: scale(1.05);
        }

        .account-stats-summary {
            background: #1c2128;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .account-stats-title {
            font-size: 16px;
            font-weight: bold;
            color: #00bfff;
            margin-bottom: 15px;
        }

        .account-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .account-stat-box {
            background: #0d1117;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .account-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00bfff;
        }

        .account-stat-label {
            font-size: 11px;
            color: #8b949e;
            margin-top: 5px;
        }

        .account-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #00bfff;
            margin: 25px 0 15px 0;
            padding-left: 12px;
            border-left: 4px solid #00bfff;
        }

        .account-menu {
            background: #1c2128;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .account-menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            border-bottom: 1px solid #30363d;
            cursor: pointer;
            transition: background 0.2s;
        }

        .account-menu-item:last-child {
            border-bottom: none;
        }

        .account-menu-item:hover {
            background: #252d38;
        }

        .account-menu-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .account-menu-icon {
            font-size: 24px;
        }

        .account-menu-text {
            display: flex;
            flex-direction: column;
        }

        .account-menu-label {
            font-size: 15px;
            font-weight: 500;
            color: #ffffff;
        }

        .account-menu-desc {
            font-size: 12px;
            color: #8b949e;
            margin-top: 2px;
        }

        .account-menu-arrow {
            color: #8b949e;
            font-size: 18px;
        }

        .sign-out-btn {
            background: transparent;
            border: 2px solid #ff4d6d;
            color: #ff4d6d;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .sign-out-btn:hover {
            background: #ff4d6d;
            color: white;
        }

        .account-version {
            text-align: center;
            color: #8b949e;
            font-size: 12px;
            margin-top: 30px;
            padding-bottom: 20px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #30363d;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #00bfff;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        /* Info item (keeping original) */

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-content {
            background: #2d3748;
            padding: 30px 25px;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 600px;
            animation: slideUpModal 0.3s ease;
        }

        @keyframes slideUpModal {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-title {
            color: #00bfff;
            font-size: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .range-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            color: #8b949e;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .input-group input, .input-group select {
            background: transparent;
            border: 2px solid #4a5568;
            border-radius: 12px;
            color: white;
            font-size: 24px;
            padding: 15px;
            text-align: center;
        }

        .input-group select {
            cursor: pointer;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #00bfff;
        }

        .input-group select option {
            background: #2d3748;
            color: white;
        }

        .divider {
            border-top: 2px dashed #4a5568;
            margin: 25px 0;
        }

        .questions-selector label, .digits-selector label {
            color: white;
            font-size: 16px;
            display: block;
            margin-bottom: 25px;
        }

        .digits-selector {
            margin-bottom: 20px;
        }

        .digits-dropdown {
            display: flex;
            justify-content: flex-end;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        #questions-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #4a5568;
            border-radius: 10px;
            outline: none;
        }

        #questions-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #00bfff;
            border-radius: 50%;
            cursor: pointer;
        }

        #questions-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #00bfff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            color: white;
            font-size: 20px;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-btn {
            padding: 16px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background: white;
            color: #2d3748;
        }

        .modal-btn-start {
            background: #00bfff;
            color: #0d1117;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        /* Quiz Top Bar */
        .quiz-top-bar {
            background: #4a5568;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(255,255,255,0.2);
        }

        .quiz-title {
            color: #c4c4c4;
            font-size: 18px;
            font-weight: normal;
        }

        .submit-btn {
            background: #00ff9f;
            border: 2px solid #00ff9f;
            color: #0d1117;
            padding: 10px 25px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 255, 159, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(0, 255, 159, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 16px rgba(0, 255, 159, 0.6);
                transform: scale(1.05);
            }
        }

        .submit-btn:hover {
            background: #00e88e;
            transform: scale(1.08);
            box-shadow: 0 4px 16px rgba(0, 255, 159, 0.6);
        }

        /* Score Bar */
        .score-bar {
            background: #3a4556;
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .score-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
        }

        .correct-icon {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .wrong-icon {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .timer-icon {
            background: rgba(33, 150, 243, 0.3);
            color: #2196f3;
            font-size: 18px;
        }

        .score-count {
            color: #8b949e;
            font-size: 16px;
            font-weight: normal;
            min-width: 60px;
        }

        /* Question Progress Indicator */
        .question-progress-bar {
            background: #1c2128;
            padding: 10px 20px 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #30363d;
        }

        .progress-label {
            font-size: 13px;
            color: #8b949e;
            min-width: 80px;
            white-space: nowrap;
            font-weight: 600;
        }

        .progress-track {
            flex: 1;
            height: 8px;
            background: #30363d;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00bfff, #0080ff);
            border-radius: 4px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-pct {
            font-size: 13px;
            color: #00bfff;
            font-weight: bold;
            min-width: 38px;
            text-align: right;
        }

        /* BODMAS Expert Badge */
        .topic-card.expert-card {
            border: 2px solid rgba(255, 149, 0, 0.4);
            background: linear-gradient(135deg, #1c2128, #1e1a2e);
            position: relative;
            overflow: hidden;
        }

        .topic-card.expert-card::before {
            content: 'EXPERT';
            position: absolute;
            top: 6px;
            right: -12px;
            background: linear-gradient(135deg, #ff9500, #ff4d6d);
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 20px 2px 8px;
            transform: rotate(15deg);
            letter-spacing: 0.5px;
        }

        .topic-card.expert-card:hover {
            border-color: #ff9500;
            box-shadow: 0 5px 20px rgba(255, 149, 0, 0.3);
        }

        /* BODMAS Question Display - slightly smaller to fit longer expressions */
        .question-display.bodmas-q {
            font-size: 28px;
            line-height: 1.4;
            padding: 0 10px;
        }

        @media (max-width: 600px) {
            .question-display.bodmas-q {
                font-size: 22px;
            }
        }

        /* Quiz Content */
        .quiz-content {
            padding: 15px 20px 10px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .question-display {
            font-size: 42px;
            font-weight: bold;
            color: white;
            margin: 10px 0 15px 0;
            text-align: center;
        }

        .answer-display {
            font-size: 42px;
            color: #00bfff;
            margin: 5px auto 10px auto;
            min-height: 50px;
            width: 100%;
            max-width: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            letter-spacing: 6px;
            padding: 10px 20px;
            background: rgba(0, 191, 255, 0.1);
            border: 2px dashed rgba(0, 191, 255, 0.3);
            border-radius: 12px;
        }

        .answer-display span {
            display: inline-block;
        }

        .answer-input {
            background: rgba(0, 191, 255, 0.1);
            border: 2px solid #00bfff;
            color: white;
            font-size: 32px;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            display: block;
        }

        .answer-input:focus {
            outline: none;
            border-color: #ff00ff;
        }

        /* Multiple Choice Grid */
        .answer-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 500px;
            margin: 5px auto;
            padding: 0 20px;
        }

        .option-btn {
            background: #2d3748;
            border: 3px solid #3a4556;
            color: white;
            padding: 25px 20px;
            border-radius: 16px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .option-btn:hover {
            border-color: #00bfff;
            background: #3a4556;
        }

        .option-btn.selected {
            border-color: #00bfff;
            background: rgba(0, 191, 255, 0.15);
        }

        .option-btn.correct {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.2);
        }

        .option-btn.incorrect {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .option-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .option-btn.selected.submitting {
            border-color: #00ff9f;
            background: rgba(0, 255, 159, 0.2);
            animation: selectedPulse 0.5s ease-in-out;
        }

        @keyframes selectedPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* BGMI-Style Animations */
        @keyframes bgmiGradientFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 400% 50%; }
        }

        @keyframes levelPulse {
            0%, 100% { 
                transform: scale(1); 
                filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
            }
            50% { 
                transform: scale(1.05); 
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.9));
            }
        }

        @keyframes countdownPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
            }
            50% { 
                transform: scale(1.05); 
                opacity: 0.8;
            }
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        @keyframes badgeUnlock {
            0% { 
                transform: scale(0.5) rotate(-180deg); 
                opacity: 0;
            }
            50% { 
                transform: scale(1.2) rotate(10deg); 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1;
            }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Achievement stat hover effects */
        .achievement-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 191, 255, 0.3);
            border-color: #00bfff !important;
        }

        /* Badge unlock effect */
        .reward-badge.unlocked {
            animation: badgeUnlock 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            filter: grayscale(0%) !important;
            opacity: 1 !important;
        }

        .reward-badge:hover {
            transform: scale(1.1) rotate(5deg);
        }

        /* Number Pad */
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 380px;
            width: 100%;
            margin: 5px auto;
            padding: 0 20px;
            position: relative;
            z-index: 10;
        }

        .number-pad-btn {
            background: #2d3748;
            border: none;
            color: white;
            font-size: 30px;
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .number-pad-btn:hover {
            background: #3a4556;
        }

        .number-pad-btn:active {
            transform: scale(0.95);
        }

        .number-pad-btn.zero {
            grid-column: 2;
        }

        .number-pad-btn.backspace {
            background: #ff4d6d;
            font-size: 28px;
        }

        .number-pad-btn.submit-tick {
            background: #00ff9f;
            color: #0d1117;
            font-size: 32px;
            font-weight: bold;
        }

        .number-pad-btn.submit-tick:hover {
            background: #00e88e;
        }

        .input-mode-selector {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .mode-btn {
            background: #2d3748;
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #00bfff;
            box-shadow: 0 4px 12px rgba(0, 191, 255, 0.4);
        }

        .mode-btn:active {
            transform: scale(0.95);
        }

        .feedback {
            margin-top: 10px;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }

        .feedback.correct {
            background: rgba(0, 255, 159, 0.2);
            border: 2px solid #00ff9f;
            color: #00ff9f;
            display: block;
        }

        .feedback.incorrect {
            background: rgba(255, 77, 109, 0.2);
            border: 2px solid #ff4d6d;
            color: #ff4d6d;
            display: block;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1c2128;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 10px 0;
            border-top: 1px solid #30363d;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: #8b949e;
            transition: color 0.2s;
            padding: 8px;
            border: none;
            background: none;
            font-family: inherit;
        }

        .nav-item:hover {
            color: #00bfff;
        }

        .nav-item.active {
            color: #00bfff;
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        /* Results */
        .results-container {
            background: #1c2128;
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
        }

        .results-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: #00bfff;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .btn {
            background: #00bfff;
            color: #0d1117;
            border: none;
            padding: 14px 35px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 191, 255, 0.4);
        }

        .btn-secondary {
            background: #30363d;
            color: white;
        }

        /* Session History Styles */
        .history-item {
            background: #1c2128;
            border-left: 4px solid #00bfff;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: #252d38;
        }

        .history-item.correct {
            border-left-color: #4caf50;
        }

        .history-item.incorrect {
            border-left-color: #f44336;
        }

        .history-question {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
        }

        .history-details {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 14px;
        }

        .history-answer {
            color: #8b949e;
        }

        .history-time {
            color: #00bfff;
            font-weight: bold;
        }

        .history-rating {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }

        /* ===== TABLE SELECTION SCREEN ===== */
        .table-hero {
            background: #FFE566;
            border-radius: 0 0 28px 28px;
            padding: 48px 20px 36px;
            text-align: center;
            margin: -20px -20px 20px;
            position: relative;
        }
        .table-hero {
            background: #FFE566;
            border-radius: 0 0 28px 28px;
            padding: 0 0 28px 0;
            margin: -20px -20px 20px;
        }
        .table-hero-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 16px 0;
        }
        .table-back-btn {
            background: rgba(0,0,0,0.1);
            border: none;
            font-size: 22px;
            color: #333;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }
        .table-hero-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin: 0;
            text-align: center;
            flex: 1;
        }
        .table-hero-spacer {
            min-width: 48px;
        }
        .table-config-card {
            background: #d4b3e8;
            border-radius: 18px;
            padding: 20px 22px;
            margin-bottom: 16px;
        }
        .table-config-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .table-config-label {
            color: #333;
            font-size: 16px;
            font-weight: 500;
            flex-shrink: 0;
        }
        .table-config-sep {
            color: #333;
            font-size: 16px;
        }
        .table-config-to {
            color: #333;
            font-size: 14px;
            flex-shrink: 0;
        }
        .table-num-input {
            width: 62px;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 10px 6px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            text-align: center;
            outline: none;
            -moz-appearance: textfield;
        }
        .table-num-input::-webkit-outer-spin-button,
        .table-num-input::-webkit-inner-spin-button { -webkit-appearance: none; }

        .table-type-card {
            border-radius: 18px;
            padding: 12px 18px 14px;
            margin-bottom: 14px;
            cursor: pointer;
            transition: transform 0.15s;
        }
        .table-type-card:active { transform: scale(0.97); }
        .table-type-preview {
            background: rgba(255,255,255,0.55);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: #222;
            margin-bottom: 10px;
        }
        .table-chart-preview {
            background: rgba(255,255,255,0.55);
            border-radius: 12px;
            padding: 14px 16px;
            text-align: center;
            font-size: 17px;
            font-weight: bold;
            color: #222;
            margin-bottom: 10px;
            line-height: 1.8;
        }
        .table-type-label {
            text-align: center;
            font-size: 15px;
            color: #444;
        }
        .table-type-pink   { background: #f48fb1; }
        .table-type-green  { background: #a5d6a7; }
        .table-type-blue   { background: #b3e5fc; }
        .table-type-yellow { background: #fff9c4; }

        /* ===== TABLES CHART FULL SCREEN ===== */
        #table-chart-section {
            background: #1a1a2e;
            min-height: 100vh;
            padding: 0;
        }
        .table-chart-screen {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .table-chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #16213e;
            padding: 18px 20px;
            border-bottom: 1px solid #0f3460;
        }
        .table-chart-back {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(255,255,255,0.2);
        }
        .table-chart-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        .table-chart-range-bar {
            background: #0f3460;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #88ccff;
            letter-spacing: 0.5px;
        }
        .table-chart-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 30px;
        }
        /* Each table block */
        .tbl-block {
            background: #16213e;
            border-radius: 14px;
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid #0f3460;
        }
        .tbl-block-title {
            background: #0f3460;
            padding: 10px 18px;
            font-size: 17px;
            font-weight: bold;
            color: #FFE566;
            letter-spacing: 0.5px;
        }
        .tbl-block-rows {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        .tbl-row {
            padding: 10px 18px;
            font-size: 16px;
            color: #e0e0e0;
            border-bottom: 1px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tbl-row:nth-child(odd) { background: rgba(255,255,255,0.03); }
        .tbl-row-eq {
            font-weight: bold;
            color: #00bfff;
        }

        /* ===== RESULT SCREEN ===== */
        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .result-back-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: rgba(255,255,255,0.2);
        }

        .result-header-title {
            font-size: 20px;
            font-weight: bold;
        }

        .result-card {
            background: #1c2128;
            border-radius: 20px;
            padding: 20px;
            margin: 0 4px 12px;
        }

        .result-progress-bar {
            display: flex;
            height: 14px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 22px;
        }

        .result-progress-correct {
            background: #4caf50;
            transition: width 0.6s ease;
        }

        .result-progress-wrong {
            background: #f44336;
            flex: 1;
            transition: width 0.6s ease;
        }

        .result-stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 18px;
        }

        .result-stat {
            text-align: center;
        }

        .result-stat-value {
            font-size: 28px;
            font-weight: bold;
            line-height: 1.1;
        }

        .correct-val { color: #4caf50; }
        .wrong-val   { color: #f44336; }
        .skipped-val { color: #8b949e; }
        .accuracy-val { color: #00bfff; }

        .result-stat-label {
            font-size: 12px;
            color: #8b949e;
            margin-top: 4px;
        }

        .result-divider {
            border-top: 1px solid #30363d;
            margin: 14px 0;
        }

        .result-score-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .result-score-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-score-icon {
            font-size: 28px;
        }

        .result-score-value {
            font-size: 22px;
            font-weight: bold;
        }

        .result-score-label {
            font-size: 12px;
            color: #8b949e;
            margin-top: 2px;
        }

        .result-practise-btn {
            width: 100%;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
            letter-spacing: 0.5px;
            transition: background 0.2s;
        }

        .result-practise-btn:hover {
            background: #1976d2;
        }

        /* Question Row */
        .result-question-row {
            display: flex;
            align-items: center;
            background: #f0fff4;
            border-radius: 0;
            padding: 14px 16px;
            margin-bottom: 1px;
            gap: 12px;
            color: #1a1a1a;
        }

        .result-question-row.wrong-row {
            background: #fff0f0;
        }

        .result-q-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .result-q-icon.correct-icon {
            background: #4caf50;
            color: white;
        }

        .result-q-icon.wrong-icon {
            background: #f44336;
            color: white;
        }

        .result-q-content {
            flex: 1;
            font-size: 15px;
        }

        .result-q-time {
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }

        .result-q-answer-wrong {
            color: #f44336;
            font-weight: bold;
        }

        .result-q-answer-correct {
            color: #4caf50;
            font-weight: bold;
        }

        #results-section {
            background: #0d1117;
            min-height: 100vh;
            padding-bottom: 30px;
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 15px;
            }
            
            .question-display {
                font-size: 32px;
            }

            .answer-display {
                font-size: 32px;
            }

            .option-btn {
                font-size: 26px;
                padding: 22px 15px;
            }

            .number-pad-btn {
                font-size: 26px;
                padding: 16px;
            }
        }

        /* ===== TRIGONOMETRY SECTION ===== */
        .trig-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 0 28px 28px;
            padding: 0 0 28px 0;
            margin: -20px -20px 20px;
        }
        .trig-hero-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 16px 0;
        }
        .trig-hero-title {
            font-size: 22px;
            font-weight: bold;
            color: white;
            text-align: center;
            flex: 1;
        }
        .trig-hero-subtitle {
            text-align: center;
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            padding: 8px 16px 0;
        }
        .trig-category-card {
            border-radius: 18px;
            padding: 16px 18px 18px;
            margin-bottom: 14px;
            cursor: pointer;
            transition: transform 0.15s;
            border: 2px solid transparent;
        }
        .trig-category-card:active { transform: scale(0.97); }
        .trig-category-card:hover { border-color: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .trig-cat-preview {
            background: rgba(255,255,255,0.55);
            border-radius: 12px;
            padding: 14px 16px;
            text-align: center;
            font-size: 17px;
            font-weight: bold;
            color: #222;
            margin-bottom: 10px;
            line-height: 1.7;
        }
        .trig-cat-label {
            text-align: center;
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }
        .trig-cat-desc {
            text-align: center;
            font-size: 12px;
            color: #555;
            margin-top: 3px;
        }
        .trig-color-1 { background: #b3d9f7; }
        .trig-color-2 { background: #b5e7a0; }
        .trig-color-3 { background: #ffd3a8; }
        .trig-color-4 { background: #f4b8d1; }
        .trig-color-5 { background: #d5b3f7; }
        .trig-color-6 { background: #ffe066; }

        /* Trig option buttons - formula display */
        .option-btn.formula-option {
            font-size: 15px;
            padding: 14px 10px;
            line-height: 1.4;
            font-weight: 600;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .option-btn.value-option {
            font-size: 24px;
            padding: 20px 12px;
            font-weight: bold;
        }
        /* Question display for trig */
        .question-display.trig-q {
            font-size: 30px;
        }
        /* ===== PERCENTAGE CHART SPECIFIC ===== */
        .pct-group {
            background: #16213e;
            border-radius: 16px;
            margin: 0 12px 20px;
            overflow: hidden;
            border: 1px solid #0f3460;
        }
        .pct-group-title {
            background: #0f3460;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #FFE566;
            letter-spacing: 0.5px;
        }
        .pct-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(15,52,96,0.7);
            gap: 8px;
        }
        .pct-row:last-child { border-bottom: none; }
        .pct-row:nth-child(odd) { background: rgba(255,255,255,0.03); }
        .pct-frac {
            font-size: 22px;
            font-weight: 800;
            color: white;
            min-width: 64px;
            flex-shrink: 0;
        }
        .pct-exact {
            font-size: 17px;
            font-weight: 700;
            color: #00e5ff;
            text-align: center;
            flex: 1;
        }
        .pct-decimal {
            font-size: 13px;
            color: #8b949e;
            text-align: right;
            min-width: 56px;
            flex-shrink: 0;
        }

        /* ===== PYTHAGOREAN CHART SPECIFIC ===== */
        .pythag-group {
            background: #16213e;
            border-radius: 16px;
            margin: 0 12px 20px;
            overflow: hidden;
            border: 1px solid #0f3460;
        }
        .pythag-group-title {
            background: #0f3460;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #FFE566;
            letter-spacing: 0.5px;
        }
        .pythag-triplet-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 13px 18px;
            border-bottom: 1px solid rgba(15,52,96,0.7);
            gap: 10px;
        }
        .pythag-triplet-row:last-child { border-bottom: none; }
        .pythag-triplet-row:nth-child(odd) { background: rgba(255,255,255,0.03); }
        .pythag-values {
            font-size: 20px;
            font-weight: 800;
            color: #FFD700;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .pythag-eq {
            font-size: 14px;
            color: #88ccff;
            text-align: right;
            white-space: nowrap;
        }
        .pythag-eq sup { font-size: 10px; }

        /* Pythagorean quiz question display */
        .pythag-question-card {
            background: linear-gradient(135deg, #1a1a3e, #16213e);
            border: 2px solid #0f3460;
            border-radius: 18px;
            padding: 20px 16px;
            margin: 8px auto;
            max-width: 500px;
            text-align: center;
        }
        .pythag-q-label {
            font-size: 13px;
            color: #88ccff;
            margin-bottom: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .pythag-q-formula {
            font-size: 32px;
            font-weight: bold;
            color: white;
            letter-spacing: 2px;
        }
        .pythag-q-formula .missing {
            color: #ff4d6d;
            font-size: 36px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="app-icon">âš¡</div>
            <div class="app-title">
                <h1>Speed Math</h1>
                <p>By SarkariPravesh</p>
            </div>
        </div>
        <div class="header-icons">
            <span>ðŸ’¬</span>
            <span>ðŸ‘¤</span>
        </div>
    </div>

    <div class="progress-line"></div>

    <div class="main-content">
        <!-- Performance Section -->
        <div id="performance-section" class="section active">
            <div class="stats-card">
                <h3 style="margin-bottom: 15px; font-size: 18px;">ðŸ“Š Today's Performance</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">ðŸ“‹</div>
                        <div class="stat-value" id="today-attempted">0</div>
                        <div class="stat-label">Attempted</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ðŸ“ˆ</div>
                        <div class="stat-value" id="today-accuracy">0.00%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">â±ï¸</div>
                        <div class="stat-value" id="today-avgtime">0.00s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <h3 style="margin-bottom: 15px; font-size: 18px;">Weekly</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">ðŸ“‹</div>
                        <div class="stat-value" id="week-attempted">0</div>
                        <div class="stat-label">Attempted</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ðŸ“ˆ</div>
                        <div class="stat-value" id="week-accuracy">0.00%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">â±ï¸</div>
                        <div class="stat-value" id="week-avgtime">0.00s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
            </div>

            <div class="date-selector">
                <div class="date-buttons">
                    <button class="date-btn active" onclick="setDateRange('1week')">1 Week</button>
                    <button class="date-btn" onclick="setDateRange('1month')">1 Month</button>
                    <button class="date-btn" onclick="setDateRange('6months')">6 Months</button>
                    <button class="date-btn" onclick="setDateRange('1year')">1 Year</button>
                </div>
                <div class="date-range-display">
                    Date Range: <span id="date-range">Feb 07, 2026 - Feb 14, 2026</span>
                </div>
                <button class="select-date-btn" onclick="openCustomDateRange()">Select Date Range</button>
            </div>

            <h2>Summary</h2>
            <div class="stats-card">
                <div class="summary-item">
                    <span>Total Questions</span>
                    <span id="total-questions">0</span>
                </div>
                <div class="summary-item">
                    <span>Correct Answers</span>
                    <span id="correct-answers">0</span>
                </div>
                <div class="summary-item">
                    <span>Wrong Answers</span>
                    <span id="wrong-answers">0</span>
                </div>
                <div class="summary-item">
                    <span>Skipped Answers</span>
                    <span id="skipped-answers">0</span>
                </div>
                <div class="summary-item">
                    <span>Accuracy</span>
                    <span id="summary-accuracy">0.00%</span>
                </div>
                <div class="summary-item">
                    <span>Avg Time</span>
                    <span id="summary-avgtime">0 sec</span>
                </div>
            </div>

            <h2 style="margin-top: 30px;">ðŸ“œ Recent Sessions</h2>
            <div class="stats-card" id="recent-sessions-card">
                <button class="btn" onclick="loadRecentSessions()" style="margin: 10px auto; display: block;">
                    View Session History
                </button>
                <div id="sessions-list" style="display: none; max-height: 400px; overflow-y: auto; margin-top: 15px;"></div>
            </div>

            <h2 style="margin-top: 30px;">Module-wise Stats</h2>
            <div class="stats-card" id="module-stats-container">
                <!-- Module stats will be populated here -->
            </div>

            <h2 style="margin-top: 30px;">Performance Over Time</h2>
            <div class="stats-card" id="performance-chart-container">
                <!-- Performance chart will be populated here -->
            </div>
        </div>

        <!-- Practice Section -->
        <div id="practice-section" class="section">
            <div class="stats-card">
                <h3 style="margin-bottom: 15px; font-size: 16px;">ðŸ“Š Today's Performance</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">ðŸ“‹</div>
                        <div class="stat-value" id="practice-attempted">0</div>
                        <div class="stat-label">Attempted</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ðŸ“ˆ</div>
                        <div class="stat-value" id="practice-accuracy">0.00%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">â±ï¸</div>
                        <div class="stat-value" id="practice-avgtime">0.00s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
            </div>

            <div class="daily-quiz">
                <div class="daily-quiz-left">
                    <h3>ðŸ”´ Daily Quiz</h3>
                    <div class="daily-quiz-date">14 Feb</div>
                    <p style="margin-top: 10px;">Test Yourself with competition!</p>
                    <button class="btn-start" onclick="startQuiz('daily')">Start â–¶</button>
                </div>
                <div class="daily-quiz-right">
                    <div style="font-size: 60px;">ðŸ“Š</div>
                    <div class="not-attempted">âš ï¸ Not Attempted<br>Any Test</div>
                </div>
            </div>

            <div class="action-cards">
                <div class="action-card" onclick="startQuiz('workout')">
                    <h3>Workout</h3>
                    <p>Turn Effort into Excellence.</p>
                    <button class="btn-start">Start â–¶</button>
                </div>
                <div class="action-card" onclick="startQuiz('error')">
                    <h3>Error Practice</h3>
                    <p>Turn Errors into Excellence.</p>
                    <button class="btn-start">Start â–¶</button>
                </div>
            </div>

            <h3 class="section-header">ADVANCE</h3>
            <div class="topics-grid">
                <div class="topic-card" onclick="startQuiz('square')">
                    <div class="topic-icon">xÂ²</div>
                    <div class="topic-name">Square</div>
                </div>
                <div class="topic-card" onclick="startQuiz('cube')">
                    <div class="topic-icon">xÂ³</div>
                    <div class="topic-name">Cube</div>
                </div>
                <div class="topic-card" onclick="startQuiz('sqrt')">
                    <div class="topic-icon">âˆš</div>
                    <div class="topic-name">Square Root</div>
                </div>
                <div class="topic-card" onclick="startQuiz('cbrt')">
                    <div class="topic-icon">âˆ›</div>
                    <div class="topic-name">Cube Root</div>
                </div>
                <div class="topic-card expert-card" onclick="startQuiz('bodmas')">
                    <div class="topic-icon">ðŸ§®</div>
                    <div class="topic-name">BODMAS</div>
                </div>
            </div>
        </div>

        <!-- Error Practice Section -->
        <div id="error-practice-section" class="section">
            <div class="stats-card">
                <h2 style="margin-bottom: 15px;">ðŸŽ¯ Error Practice</h2>
                <p style="text-align: center; color: #8b949e; margin-bottom: 15px;">Turn Errors into Excellence</p>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">âŒ</div>
                        <div class="stat-value" id="error-total-errors">0</div>
                        <div class="stat-label">Total Errors</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ðŸ“</div>
                        <div class="stat-value" id="error-total-attempts">0</div>
                        <div class="stat-label">Attempts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-value" id="error-overall-accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
            </div>

            <h3 class="section-header">ðŸ“š Section-wise Errors</h3>
            <div id="errorSectionsContainer"></div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ðŸŽ‰</div>
                <p>Great job! You haven't made any errors yet.<br>Keep practicing to maintain your perfect record!</p>
            </div>
        </div>

        <!-- Revision Section -->
        <div id="revision-section" class="section">
            <h3 class="section-header">BASICS</h3>
            <div class="topics-grid">
                <div class="topic-card" onclick="startQuiz('table')">
                    <div class="topic-icon">âœ–ï¸</div>
                    <div class="topic-name">Table</div>
                </div>
                <div class="topic-card" onclick="startQuiz('trigonometry')">
                    <div class="topic-icon">ðŸ“</div>
                    <div class="topic-name">Trigonometry</div>
                </div>
                <div class="topic-card" onclick="startQuiz('square')">
                    <div class="topic-icon">xÂ²</div>
                    <div class="topic-name">Square</div>
                </div>
                <div class="topic-card" onclick="startQuiz('cube')">
                    <div class="topic-icon">xÂ³</div>
                    <div class="topic-name">Cube</div>
                </div>
                <div class="topic-card" onclick="startQuiz('fraction')">
                    <div class="topic-icon">â…“</div>
                    <div class="topic-name">Fraction</div>
                </div>
                <div class="topic-card" onclick="startQuiz('pythagorean')">
                    <div class="topic-icon">ðŸ“Š</div>
                    <div class="topic-name">Pythagorean</div>
                </div>
            </div>

            <h3 class="section-header" style="margin-top: 40px;">ADVANCE</h3>
            <div class="topics-grid">
                <div class="topic-card" onclick="startQuiz('square')">
                    <div class="topic-icon">xÂ²</div>
                    <div class="topic-name">Square</div>
                </div>
                <div class="topic-card" onclick="startQuiz('cube')">
                    <div class="topic-icon">xÂ³</div>
                    <div class="topic-name">Cube</div>
                </div>
                <div class="topic-card" onclick="startQuiz('sqrt')">
                    <div class="topic-icon">âˆš</div>
                    <div class="topic-name">Square Root</div>
                </div>
                <div class="topic-card" onclick="startQuiz('cbrt')">
                    <div class="topic-icon">âˆ›</div>
                    <div class="topic-name">Cube Root</div>
                </div>
                <div class="topic-card" onclick="startQuiz('trigonometry')">
                    <div class="topic-icon">ðŸ“</div>
                    <div class="topic-name">Trigonometry</div>
                </div>
                <div class="topic-card" onclick="startQuiz('table')">
                    <div class="topic-icon">âœ–ï¸</div>
                    <div class="topic-name">Table</div>
                </div>
                <div class="topic-card" onclick="startQuiz('di-addition')">
                    <div class="topic-icon">âž•</div>
                    <div class="topic-name">DI Addition</div>
                </div>
                <div class="topic-card" onclick="startQuiz('mixed')">
                    <div class="topic-icon">ðŸ”€</div>
                    <div class="topic-name">Mixed Question</div>
                </div>
                <div class="topic-card expert-card" onclick="startQuiz('bodmas')">
                    <div class="topic-icon">ðŸ§®</div>
                    <div class="topic-name">BODMAS</div>
                </div>
            </div>

            <h3 class="section-header" style="margin-top: 40px;">BASICS</h3>
            <div class="topics-grid">
                <div class="topic-card" onclick="startQuiz('addition')">
                    <div class="topic-icon">âž•</div>
                    <div class="topic-name">Addition</div>
                </div>
                <div class="topic-card" onclick="startQuiz('subtraction')">
                    <div class="topic-icon">âž–</div>
                    <div class="topic-name">Subtraction</div>
                </div>
                <div class="topic-card" onclick="startQuiz('multiplication')">
                    <div class="topic-icon">âœ–ï¸</div>
                    <div class="topic-name">Multiplication</div>
                </div>
                <div class="topic-card" onclick="startQuiz('division')">
                    <div class="topic-icon">âž—</div>
                    <div class="topic-name">Division</div>
                </div>
                <div class="topic-card" onclick="startQuiz('complexity')">
                    <div class="topic-icon">âš™ï¸</div>
                    <div class="topic-name">Complexity</div>
                </div>
                <div class="topic-card" onclick="startQuiz('percentage')">
                    <div class="topic-icon">%</div>
                    <div class="topic-name">Percentage</div>
                </div>
            </div>
        </div>

        <!-- Table Selection Section -->
        <div id="table-section" class="section">
            <div class="table-hero">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn">â†</button>
                    <h2 class="table-hero-title">Multiplication Tables</h2>
                    <span class="table-hero-spacer"></span>
                </div>
            </div>

            <!-- Config Card (purple) -->
            <div class="table-config-card">
                <div class="table-config-row">
                    <span class="table-config-label">From</span>
                    <span class="table-config-sep">:</span>
                    <input type="number" class="table-num-input" id="table-from" value="2" min="1" max="99" oninput="updateTablePreview()">
                    <span class="table-config-to">to</span>
                    <input type="number" class="table-num-input" id="table-to" value="20" min="1" max="99" oninput="updateTablePreview()">
                </div>
                <div class="table-config-row" style="margin-top:18px;">
                    <span class="table-config-label">Multiplied By :</span>
                    <input type="number" class="table-num-input" id="table-mult-from" value="1" min="1" max="99" oninput="updateTablePreview()">
                    <span class="table-config-to">to</span>
                    <input type="number" class="table-num-input" id="table-mult-to" value="10" min="1" max="99" oninput="updateTablePreview()">
                </div>
            </div>

            <!-- Tables Chart card - opens full chart -->
            <div class="table-type-card table-type-yellow" onclick="openTablesChart()" style="padding:16px 18px 18px;">
                <div class="table-chart-preview" id="table-chart-preview" style="font-size:20px; padding:20px; line-height:2;">
                    2 Ã— 1 = 2<br>2 Ã— 2 = 4<br>2 Ã— 3 = 6
                </div>
                <div class="table-type-label" style="color:#555; font-size:17px; font-weight:600;">ðŸ“Š View Tables Chart</div>
            </div>
        </div>

        <!-- Tables Chart Full Screen Section -->
        <div id="table-chart-section" class="section">
            <div class="table-chart-screen">
                <!-- Header -->
                <div class="table-chart-header">
                    <button onclick="closeTablesChart()" class="table-chart-back">â†</button>
                    <span class="table-chart-title">ðŸ“Š Tables Chart</span>
                    <span></span>
                </div>

                <!-- Range display -->
                <div class="table-chart-range-bar" id="table-chart-range-bar">
                    Table 2 to 20 &nbsp;|&nbsp; Ã— 1 to 10
                </div>

                <!-- Scrollable content -->
                <div class="table-chart-body" id="table-chart-body"></div>
            </div>
        </div>

        <!-- Addition Selection Section -->
        <div id="addition-section" class="section">
            <div class="table-hero" style="background:#FFE566;">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn">â†</button>
                    <h2 class="table-hero-title">Addition</h2>
                    <span class="table-hero-spacer"></span>
                </div>
            </div>

            <!-- Number of Digits Config -->
            <div class="table-config-card">
                <div class="table-config-row" style="justify-content:space-between; align-items:center;">
                    <span class="table-config-label" style="font-size:18px;">Number of Digits</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="add-digits-display" style="font-size:22px; font-weight:bold; color:#333; min-width:28px; text-align:center;">2</span>
                        <select id="add-digits-select" onchange="updateAdditionPreview()" style="
                            appearance:none; -webkit-appearance:none;
                            background:none; border:none; cursor:pointer;
                            font-size:22px; color:#7b5ea7; padding:4px;
                            outline:none;">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Addition card (pink) -->
            <div class="table-type-card table-type-pink" onclick="startAdditionQuiz('addition')">
                <div class="table-type-preview" id="add-preview-addition" style="font-size:40px; padding:22px;">+</div>
                <div class="table-type-label">Addition</div>
            </div>

            <!-- Subtraction card (green) -->
            <div class="table-type-card table-type-green" onclick="startAdditionQuiz('subtraction')">
                <div class="table-type-preview" id="add-preview-subtraction" style="font-size:40px; padding:22px;">âˆ’</div>
                <div class="table-type-label">Subtraction</div>
            </div>

            <!-- Both card (blue) -->
            <div class="table-type-card table-type-blue" onclick="startAdditionQuiz('add-sub-mixed')">
                <div class="table-type-preview" style="font-size:30px; padding:22px;">+ / âˆ’</div>
                <div class="table-type-label">Both (Mixed)</div>
            </div>
        </div>

        <!-- Pythagorean Selection Section -->
        <div id="pythagorean-section" class="section">
            <div class="table-hero" style="background: linear-gradient(135deg,#a18cd1,#fbc2eb);">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn" style="color:#333;background:rgba(0,0,0,0.12);">â†</button>
                    <h2 class="table-hero-title" style="color:#333;">ðŸ“ Pythagorean Triplets</h2>
                    <span class="table-hero-spacer"></span>
                </div>
                <div style="text-align:center;color:#555;font-size:13px;padding:8px 16px 0;">
                    aÂ² + bÂ² = cÂ² â€” Find the missing value!
                </div>
            </div>

            <!-- Guess missing A (smallest) -->
            <div class="table-type-card" style="background:#b3d9f7;" onclick="startPythagQuiz('find-a')">
                <div class="table-type-preview" style="font-size:24px;padding:16px;line-height:1.9;">
                    <b style="color:#e53935;">?</b>Â² + 24Â² = 25Â²<br>
                    <b style="color:#e53935;">?</b>Â² + 40Â² = 41Â²
                </div>
                <div class="table-type-label" style="color:#444;font-size:16px;font-weight:600;">Find the Smallest (a)</div>
                <div class="trig-cat-desc" style="margin-top:4px;">?Â² + bÂ² = cÂ²</div>
            </div>

            <!-- Guess missing B (middle) -->
            <div class="table-type-card" style="background:#b5e7a0;" onclick="startPythagQuiz('find-b')">
                <div class="table-type-preview" style="font-size:24px;padding:16px;line-height:1.9;">
                    7Â² + <b style="color:#e53935;">?</b>Â² = 25Â²<br>
                    9Â² + <b style="color:#e53935;">?</b>Â² = 41Â²
                </div>
                <div class="table-type-label" style="color:#444;font-size:16px;font-weight:600;">Find the Middle (b)</div>
                <div class="trig-cat-desc" style="margin-top:4px;">aÂ² + ?Â² = cÂ²</div>
            </div>

            <!-- Guess missing C (hypotenuse) -->
            <div class="table-type-card" style="background:#ffd3a8;" onclick="startPythagQuiz('find-c')">
                <div class="table-type-preview" style="font-size:24px;padding:16px;line-height:1.9;">
                    7Â² + 24Â² = <b style="color:#e53935;">?</b>Â²<br>
                    9Â² + 40Â² = <b style="color:#e53935;">?</b>Â²
                </div>
                <div class="table-type-label" style="color:#444;font-size:16px;font-weight:600;">Find the Hypotenuse (c)</div>
                <div class="trig-cat-desc" style="margin-top:4px;">aÂ² + bÂ² = ?Â²</div>
            </div>

            <!-- Mixed -->
            <div class="table-type-card" style="background:#d5b3f7;" onclick="startPythagQuiz('find-any')">
                <div class="table-type-preview" style="font-size:28px;padding:16px;">ðŸ”€ Mixed â€” Find Any</div>
                <div class="table-type-label" style="color:#444;font-size:16px;font-weight:600;">Random Missing Value</div>
            </div>

            <!-- View Chart -->
            <div class="table-type-card table-type-yellow" onclick="openPythagChart()" style="padding:16px 18px 18px;">
                <div class="table-chart-preview" style="font-size:18px;padding:12px;line-height:2;">
                    (7, 24, 25) &nbsp; (8, 15, 17)<br>
                    (9, 40, 41) &nbsp; (11, 60, 61)<br>
                    (12, 35, 37) &nbsp; (16, 63, 65)
                </div>
                <div class="table-type-label" style="color:#555;font-size:16px;font-weight:600;">ðŸ“Š View All Triplets</div>
            </div>
        </div>

        <!-- Pythagorean Chart Full Screen -->
        <div id="pythagorean-chart-section" class="section">
            <div class="table-chart-screen">
                <div class="table-chart-header">
                    <button onclick="closePythagChart()" class="table-chart-back">â†</button>
                    <span class="table-chart-title">ðŸ“ Pythagorean Triplets</span>
                    <span></span>
                </div>
                <div class="table-chart-range-bar">All triplets: aÂ² + bÂ² = cÂ²</div>
                <div class="table-chart-body" id="pythag-chart-body"></div>
            </div>
        </div>

        <!-- Percentage Selection Section -->
        <div id="percentage-section" class="section">
            <div class="table-hero" style="background:#FFE566;">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn">â†</button>
                    <h2 class="table-hero-title">% Percentage</h2>
                    <span class="table-hero-spacer"></span>
                </div>
            </div>

            <!-- Two Practice Modes -->
            <!-- Fraction â†’ % Card (pink) -->
            <div class="table-type-card" style="background:#f48fb1;" onclick="startPercentageQuiz('frac-to-pct')">
                <div class="table-type-preview" style="font-size:22px; padding:18px; line-height:1.8;">
                    1/6 = 16.67%<br>1/8 = 12.5%<br>3/8 = 37.5%
                </div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">Fraction â†’ % Practice</div>
                <div class="trig-cat-desc" style="margin-top:4px;">What is n/d as a percentage?</div>
            </div>

            <!-- % â†’ Fraction Card (green) -->
            <div class="table-type-card" style="background:#a5d6a7;" onclick="startPercentageQuiz('pct-to-frac')">
                <div class="table-type-preview" style="font-size:22px; padding:18px; line-height:1.8;">
                    16.67% = ?<br>62.5% = ?<br>44.44% = ?
                </div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">% â†’ Fraction Practice</div>
                <div class="trig-cat-desc" style="margin-top:4px;">Which fraction equals this percentage?</div>
            </div>

            <!-- Mixed Card (blue) -->
            <div class="table-type-card" style="background:#b3e5fc;" onclick="startPercentageQuiz('pct-mixed')">
                <div class="table-type-preview" style="font-size:28px; padding:18px;">% â‡„ Fraction</div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">Mixed Practice</div>
            </div>

            <!-- View Chart (yellow) -->
            <div class="table-type-card table-type-yellow" onclick="openPercentageChart()" style="padding:16px 18px 18px;">
                <div class="table-chart-preview" style="font-size:17px; padding:14px; line-height:2;">
                    1/6 = 16.67% &nbsp;|&nbsp; 1/8 = 12.5%<br>3/8 = 37.5% &nbsp;|&nbsp; 5/8 = 62.5%<br>1/12 = 8.33% &nbsp;|&nbsp; 5/12 = 41.67%
                </div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">ðŸ“Š View Full Chart</div>
            </div>
        </div>

        <!-- Percentage Chart Full Screen -->
        <div id="percentage-chart-section" class="section">
            <div class="table-chart-screen">
                <div class="table-chart-header">
                    <button onclick="closePercentageChart()" class="table-chart-back">â†</button>
                    <span class="table-chart-title">ðŸ“Š Fraction â†’ % Chart</span>
                    <span></span>
                </div>
                <div class="table-chart-range-bar">All important fraction-to-percentage conversions</div>
                <div class="table-chart-body" id="pct-chart-body"></div>
            </div>
        </div>

        <!-- Square Selection Section -->
        <div id="square-section" class="section">
            <div class="table-hero" style="background:#FFE566;">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn">â†</button>
                    <h2 class="table-hero-title">Squares</h2>
                    <span class="table-hero-spacer"></span>
                </div>
            </div>

            <!-- Config Card -->
            <div class="table-config-card" style="background:#d4b3e8;">
                <div class="table-config-row" style="align-items:center; gap:14px;">
                    <span class="table-config-label">From :</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <input type="number" class="table-num-input" id="sq-from" value="2" min="1" max="99" oninput="updateSquarePreview()">
                        <sup style="font-size:13px; font-weight:bold; color:#555;">2</sup>
                    </div>
                    <span class="table-config-to">To</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <input type="number" class="table-num-input" id="sq-to" value="99" min="1" max="999" oninput="updateSquarePreview()">
                        <sup style="font-size:13px; font-weight:bold; color:#555;">2</sup>
                    </div>
                </div>
            </div>

            <!-- Start Practice Card (pink) -->
            <div class="table-type-card" style="background:#f48fb1;" onclick="startSquareQuiz()">
                <div class="table-type-preview" id="sq-practice-preview" style="font-size:26px; padding:18px; font-weight:bold;">2Â² = ?</div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">Start Practice</div>
            </div>

            <!-- View Chart Card (yellow) -->
            <div class="table-type-card table-type-yellow" onclick="openSquareChart()" style="padding:16px 18px 18px;">
                <div class="table-chart-preview" id="sq-chart-preview" style="font-size:20px; padding:18px; line-height:2;">
                    2Â² = 4<br>3Â² = 9<br>4Â² = 16
                </div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">View Chart</div>
            </div>
        </div>

        <!-- Square Chart Full Screen -->
        <div id="square-chart-section" class="section">
            <div class="table-chart-screen">
                <div class="table-chart-header">
                    <button onclick="closeSquareChart()" class="table-chart-back">â†</button>
                    <span class="table-chart-title">ðŸ“Š Squares Chart</span>
                    <span></span>
                </div>
                <div class="table-chart-range-bar" id="sq-chart-range-bar">Square 2Â² to 99Â²</div>
                <div class="table-chart-body" id="sq-chart-body"></div>
            </div>
        </div>

        <!-- Cube Selection Section -->
        <div id="cube-section" class="section">
            <div class="table-hero" style="background:#FFE566;">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn">â†</button>
                    <h2 class="table-hero-title">Cubes</h2>
                    <span class="table-hero-spacer"></span>
                </div>
            </div>

            <!-- Config Card -->
            <div class="table-config-card" style="background:#d4b3e8;">
                <div class="table-config-row" style="align-items:center; gap:14px;">
                    <span class="table-config-label">From :</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <input type="number" class="table-num-input" id="cb-from" value="2" min="1" max="99" oninput="updateCubePreview()">
                        <sup style="font-size:13px; font-weight:bold; color:#555;">3</sup>
                    </div>
                    <span class="table-config-to">To</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <input type="number" class="table-num-input" id="cb-to" value="30" min="1" max="99" oninput="updateCubePreview()">
                        <sup style="font-size:13px; font-weight:bold; color:#555;">3</sup>
                    </div>
                </div>
            </div>

            <!-- Start Practice Card (pink) -->
            <div class="table-type-card" style="background:#f48fb1;" onclick="startCubeQuiz()">
                <div class="table-type-preview" id="cb-practice-preview" style="font-size:26px; padding:18px; font-weight:bold;">2Â³ = ?</div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">Start Practice</div>
            </div>

            <!-- View Chart Card (yellow) -->
            <div class="table-type-card table-type-yellow" onclick="openCubeChart()" style="padding:16px 18px 18px;">
                <div class="table-chart-preview" id="cb-chart-preview" style="font-size:20px; padding:18px; line-height:2;">
                    2Â³ = 8<br>3Â³ = 27<br>4Â³ = 64
                </div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">View Chart</div>
            </div>
        </div>

        <!-- Cube Chart Full Screen -->
        <div id="cube-chart-section" class="section">
            <div class="table-chart-screen">
                <div class="table-chart-header">
                    <button onclick="closeCubeChart()" class="table-chart-back">â†</button>
                    <span class="table-chart-title">ðŸ“Š Cubes Chart</span>
                    <span></span>
                </div>
                <div class="table-chart-range-bar" id="cb-chart-range-bar">Cube 2Â³ to 30Â³</div>
                <div class="table-chart-body" id="cb-chart-body"></div>
            </div>
        </div>

        <!-- Square Root Selection Section -->
        <div id="sqrt-section" class="section">
            <div class="table-hero" style="background:#FFE566;">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn">â†</button>
                    <h2 class="table-hero-title">Square Roots</h2>
                    <span class="table-hero-spacer"></span>
                </div>
            </div>

            <!-- Config Card -->
            <div class="table-config-card" style="background:#d4b3e8;">
                <div class="table-config-row" style="align-items:center; gap:14px;">
                    <span class="table-config-label">From :</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <span style="font-size:20px; font-weight:bold; color:#555;">âˆš</span>
                        <input type="number" class="table-num-input" id="sqrt-from" value="4" min="1" max="10000" oninput="updateSqrtPreview()">
                    </div>
                    <span class="table-config-to">To</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <span style="font-size:20px; font-weight:bold; color:#555;">âˆš</span>
                        <input type="number" class="table-num-input" id="sqrt-to" value="400" min="1" max="10000" oninput="updateSqrtPreview()">
                    </div>
                </div>
            </div>

            <!-- Start Practice Card (pink) -->
            <div class="table-type-card" style="background:#f48fb1;" onclick="startSqrtQuiz()">
                <div class="table-type-preview" id="sqrt-practice-preview" style="font-size:26px; padding:18px; font-weight:bold;">âˆš4 = ?</div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">Start Practice</div>
            </div>

            <!-- View Chart Card (yellow) -->
            <div class="table-type-card table-type-yellow" onclick="openSqrtChart()" style="padding:16px 18px 18px;">
                <div class="table-chart-preview" id="sqrt-chart-preview" style="font-size:20px; padding:18px; line-height:2;">
                    âˆš4 = 2<br>âˆš9 = 3<br>âˆš16 = 4
                </div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">View Chart</div>
            </div>
        </div>

        <!-- Square Root Chart Full Screen -->
        <div id="sqrt-chart-section" class="section">
            <div class="table-chart-screen">
                <div class="table-chart-header">
                    <button onclick="closeSqrtChart()" class="table-chart-back">â†</button>
                    <span class="table-chart-title">ðŸ“Š Square Roots Chart</span>
                    <span></span>
                </div>
                <div class="table-chart-range-bar" id="sqrt-chart-range-bar">Square Root âˆš4 to âˆš400</div>
                <div class="table-chart-body" id="sqrt-chart-body"></div>
            </div>
        </div>

        <!-- Cube Root Selection Section -->
        <div id="cbrt-section" class="section">
            <div class="table-hero" style="background:#FFE566;">
                <div class="table-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn">â†</button>
                    <h2 class="table-hero-title">Cube Roots</h2>
                    <span class="table-hero-spacer"></span>
                </div>
            </div>

            <!-- Config Card -->
            <div class="table-config-card" style="background:#d4b3e8;">
                <div class="table-config-row" style="align-items:center; gap:14px;">
                    <span class="table-config-label">From :</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <span style="font-size:20px; font-weight:bold; color:#555;">âˆ›</span>
                        <input type="number" class="table-num-input" id="cbrt-from" value="8" min="1" max="10000" oninput="updateCbrtPreview()">
                    </div>
                    <span class="table-config-to">To</span>
                    <div style="display:flex; align-items:baseline; gap:2px;">
                        <span style="font-size:20px; font-weight:bold; color:#555;">âˆ›</span>
                        <input type="number" class="table-num-input" id="cbrt-to" value="1000" min="1" max="100000" oninput="updateCbrtPreview()">
                    </div>
                </div>
            </div>

            <!-- Start Practice Card (pink) -->
            <div class="table-type-card" style="background:#f48fb1;" onclick="startCbrtQuiz()">
                <div class="table-type-preview" id="cbrt-practice-preview" style="font-size:26px; padding:18px; font-weight:bold;">âˆ›8 = ?</div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">Start Practice</div>
            </div>

            <!-- View Chart Card (yellow) -->
            <div class="table-type-card table-type-yellow" onclick="openCbrtChart()" style="padding:16px 18px 18px;">
                <div class="table-chart-preview" id="cbrt-chart-preview" style="font-size:20px; padding:18px; line-height:2;">
                    âˆ›8 = 2<br>âˆ›27 = 3<br>âˆ›64 = 4
                </div>
                <div class="table-type-label" style="color:#555; font-size:16px; font-weight:600;">View Chart</div>
            </div>
        </div>

        <!-- Cube Root Chart Full Screen -->
        <div id="cbrt-chart-section" class="section">
            <div class="table-chart-screen">
                <div class="table-chart-header">
                    <button onclick="closeCbrtChart()" class="table-chart-back">â†</button>
                    <span class="table-chart-title">ðŸ“Š Cube Roots Chart</span>
                    <span></span>
                </div>
                <div class="table-chart-range-bar" id="cbrt-chart-range-bar">Cube Root âˆ›8 to âˆ›1000</div>
                <div class="table-chart-body" id="cbrt-chart-body"></div>
            </div>
        </div>

        <!-- Trigonometry Selection Section -->
        <div id="trigonometry-section" class="section">
            <div class="trig-hero">
                <div class="trig-hero-nav">
                    <button onclick="goToPractice()" class="table-back-btn" style="color:white; background:rgba(255,255,255,0.2);">â†</button>
                    <h2 class="trig-hero-title">ðŸ“ Trigonometry</h2>
                    <span class="table-hero-spacer"></span>
                </div>
                <div class="trig-hero-subtitle">Choose a formula category to practice</div>
            </div>

            <!-- Common Angles card -->
            <div class="trig-category-card trig-color-1" onclick="startTrigQuiz('trig-common')">
                <div class="trig-cat-preview">sin 30Â° = ?<br>cos 45Â° = ?<br>tan 60Â° = ?</div>
                <div class="trig-cat-label">ðŸ”¢ Common Angles</div>
                <div class="trig-cat-desc">sin, cos, tan, cot, sec, cosec of 0Â°â€“360Â°</div>
            </div>

            <!-- Addition & Subtraction card -->
            <div class="trig-category-card trig-color-2" onclick="startTrigQuiz('trig-addition')">
                <div class="trig-cat-preview">sin(A+B) = ?<br>cos(Aâˆ’B) = ?</div>
                <div class="trig-cat-label">âž• Addition & Subtraction Formulas</div>
                <div class="trig-cat-desc">sin/cos/tan of (AÂ±B)</div>
            </div>

            <!-- Double Angle card -->
            <div class="trig-category-card trig-color-3" onclick="startTrigQuiz('trig-double')">
                <div class="trig-cat-preview">sin(2A) = ?<br>cos(2A) = ?</div>
                <div class="trig-cat-label">âœ–ï¸ Double Angle Formulas</div>
                <div class="trig-cat-desc">sin(2A), cos(2A), tan(2A)</div>
            </div>

            <!-- Multiple Angle card -->
            <div class="trig-category-card trig-color-4" onclick="startTrigQuiz('trig-multiple')">
                <div class="trig-cat-preview">sin(3A) = ?<br>cos(3A) = ?</div>
                <div class="trig-cat-label">âš¡ Multiple Angle Formulas</div>
                <div class="trig-cat-desc">sin(3A), cos(3A), tan(3A)</div>
            </div>

            <!-- Half Angle card -->
            <div class="trig-category-card trig-color-5" onclick="startTrigQuiz('trig-half')">
                <div class="trig-cat-preview">sin(A/2) = ?<br>cos(A/2) = ?</div>
                <div class="trig-cat-label">Â½ Half Angle Formulas</div>
                <div class="trig-cat-desc">sin(A/2), cos(A/2), tan(A/2)</div>
            </div>

            <!-- Mixed All card -->
            <div class="trig-category-card trig-color-6" onclick="startTrigQuiz('trig-mixed')">
                <div class="trig-cat-preview">ðŸ”€ All Topics Mixed</div>
                <div class="trig-cat-label">ðŸŽ¯ Mixed Practice</div>
                <div class="trig-cat-desc">All formula types combined</div>
            </div>
        </div>

        <!-- Account Section -->
        <!-- Achievement Section (BGMI Style - Replaces Account) -->
        <div id="achievement-section" class="section">
            <div class="account-section">
                <h2 style="text-align: center; color: #00bfff; margin-bottom: 25px;">ðŸ† Achievements</h2>

                <!-- Current Achievement Card - BGMI Style Enhanced -->
                <div class="achievement-card" style="background: linear-gradient(135deg, #1c2128, #2d333b); border-radius: 16px; padding: 30px 20px; margin-bottom: 25px; text-align: center; box-shadow: 0 8px 20px rgba(0, 191, 255, 0.15); position: relative; overflow: hidden;">
                    <div style="content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(0, 191, 255, 0.1) 0%, transparent 70%); animation: rotate 10s linear infinite;"></div>
                    
                    <!-- Level Badge with Animation -->
                    <div class="achievement-level-badge" id="achievement-level-badge" style="position: relative; z-index: 1; margin-bottom: 20px;">
                        <div class="level-icon" id="achievement-level" style="font-size: 48px; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 30px rgba(255, 215, 0, 0.6); animation: levelPulse 2s ease-in-out infinite;">
                            ðŸ¥‰
                        </div>
                        <div class="level-name" id="achievement-level-name" style="font-size: 24px; font-weight: bold; color: #FFD700; text-transform: uppercase; letter-spacing: 2px;">
                            Bronze
                        </div>
                        <div class="level-subtitle" id="achievement-level-subtitle" style="font-size: 12px; color: #8b949e; margin-top: 5px;">
                            Starting Level
                        </div>
                    </div>

                    <!-- XP System with Animated Progress -->
                    <div class="achievement-xp-system" style="margin: 25px 0; position: relative; z-index: 1;">
                        <div class="xp-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div class="xp-current" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">âš¡</span>
                                <span id="achievement-xp-current" style="font-size: 18px; font-weight: bold; color: #FFD700;">0 XP</span>
                            </div>
                            <div class="xp-target" style="display: flex; align-items: center; gap: 8px;">
                                <span id="achievement-xp-percent" style="font-size: 14px; font-weight: bold; color: #00bfff;">0%</span>
                                <span style="font-size: 20px;">ðŸŽ¯</span>
                                <span id="achievement-xp-target" style="font-size: 14px; color: #8b949e;">3000 XP</span>
                            </div>
                        </div>
                        
                        <!-- BGMI Style Animated Progress Bar -->
                        <div class="achievement-progress-bar-container" style="height: 24px; background: rgba(13, 17, 23, 0.9); border-radius: 12px; overflow: hidden; border: 2px solid #2d333b; position: relative; box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);">
                            <div class="achievement-progress-fill" id="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #FFD700 0%, #FFA500 25%, #ff4d6d 50%, #a855f7 75%, #00bfff 100%); background-size: 400% 100%; animation: bgmiGradientFlow 4s linear infinite; border-radius: 10px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); width: 0%; position: relative; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);">
                                <div class="progress-shine" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shine 3s infinite;"></div>
                                <div class="progress-particles" style="position: absolute; width: 100%; height: 100%; overflow: hidden;">
                                    <!-- Particle effects will be added dynamically -->
                                </div>
                            </div>
                            <div class="progress-level-markers" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                <!-- Level markers will be added dynamically -->
                            </div>
                        </div>
                        
                        <!-- Progress Text -->
                        <div class="xp-details" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 12px; color: #8b949e;">
                            <span id="achievement-progress-text">0 / 300 Questions</span>
                            <span id="achievement-xp-next">+300 XP to next level</span>
                        </div>
                    </div>

                    <!-- Monthly Reset Countdown - BGMI Style -->
                    <div class="season-reset-banner" style="background: linear-gradient(135deg, rgba(255, 77, 109, 0.15), rgba(138, 43, 226, 0.15)); border: 2px solid #ff4d6d; border-radius: 12px; padding: 15px; margin: 20px 0; position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 32px;">ðŸ“…</span>
                                <div>
                                    <div style="font-size: 13px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px;">Current Season</div>
                                    <div id="season-name" style="font-size: 16px; font-weight: bold; color: #fff; margin-top: 3px;">February 2026</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Resets In</div>
                                <div id="season-countdown" style="font-size: 24px; font-weight: bold; color: #ff4d6d; margin-top: 3px; animation: countdownPulse 2s ease-in-out infinite;">14 Days</div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="achievement-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 25px; position: relative; z-index: 1;">
                        <div class="achievement-stat" style="background: rgba(13, 17, 23, 0.8); padding: 15px; border-radius: 12px; border: 1px solid #2d333b; transition: all 0.3s;">
                            <div class="achievement-stat-icon" style="font-size: 24px; margin-bottom: 8px;">ðŸŽ¯</div>
                            <div class="achievement-stat-value" id="achievement-attempted" style="font-size: 24px; font-weight: bold; color: #00bfff;">0</div>
                            <div class="achievement-stat-label" style="font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px;">Attempted</div>
                        </div>
                        <div class="achievement-stat" style="background: rgba(13, 17, 23, 0.8); padding: 15px; border-radius: 12px; border: 1px solid #2d333b; transition: all 0.3s;">
                            <div class="achievement-stat-icon" style="font-size: 24px; margin-bottom: 8px;">âœ…</div>
                            <div class="achievement-stat-value" id="achievement-correct" style="font-size: 24px; font-weight: bold; color: #4caf50;">0</div>
                            <div class="achievement-stat-label" style="font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px;">Correct</div>
                        </div>
                        <div class="achievement-stat" style="background: rgba(13, 17, 23, 0.8); padding: 15px; border-radius: 12px; border: 1px solid #2d333b; transition: all 0.3s;">
                            <div class="achievement-stat-icon" style="font-size: 24px; margin-bottom: 8px;">ðŸ“Š</div>
                            <div class="achievement-stat-value" id="achievement-accuracy" style="font-size: 24px; font-weight: bold; color: #FFD700;">0%</div>
                            <div class="achievement-stat-label" style="font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px;">Accuracy</div>
                        </div>
                    </div>

                    <!-- Rewards Unlocked -->
                    <div class="achievement-rewards" style="margin-top: 25px; padding: 18px; background: rgba(0, 191, 255, 0.08); border: 1px solid rgba(0, 191, 255, 0.3); border-radius: 12px; position: relative; z-index: 1;">
                        <h4 style="color: #00bfff; font-size: 14px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">ðŸŽ Rewards Unlocked</h4>
                        <div class="reward-badges" style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                            <div class="reward-badge-container" style="position: relative;">
                                <span class="reward-badge" id="badge-bronze" style="font-size: 32px; opacity: 0.3; transition: all 0.5s; filter: grayscale(100%); cursor: pointer;">ðŸ¥‰</span>
                                <div class="badge-name" style="font-size: 9px; color: #8b949e; text-align: center; margin-top: 4px;">Bronze</div>
                            </div>
                            <div class="reward-badge-container" style="position: relative;">
                                <span class="reward-badge" id="badge-silver" style="font-size: 32px; opacity: 0.3; transition: all 0.5s; filter: grayscale(100%); cursor: pointer;">ðŸ¥ˆ</span>
                                <div class="badge-name" style="font-size: 9px; color: #8b949e; text-align: center; margin-top: 4px;">Silver</div>
                            </div>
                            <div class="reward-badge-container" style="position: relative;">
                                <span class="reward-badge" id="badge-gold" style="font-size: 32px; opacity: 0.3; transition: all 0.5s; filter: grayscale(100%); cursor: pointer;">ðŸ¥‡</span>
                                <div class="badge-name" style="font-size: 9px; color: #8b949e; text-align: center; margin-top: 4px;">Gold</div>
                            </div>
                            <div class="reward-badge-container" style="position: relative;">
                                <span class="reward-badge" id="badge-platinum" style="font-size: 32px; opacity: 0.3; transition: all 0.5s; filter: grayscale(100%); cursor: pointer;">ðŸ’Ž</span>
                                <div class="badge-name" style="font-size: 9px; color: #8b949e; text-align: center; margin-top: 4px;">Platinum</div>
                            </div>
                            <div class="reward-badge-container" style="position: relative;">
                                <span class="reward-badge" id="badge-ace" style="font-size: 32px; opacity: 0.3; transition: all 0.5s; filter: grayscale(100%); cursor: pointer;">ðŸ”¥</span>
                                <div class="badge-name" style="font-size: 9px; color: #8b949e; text-align: center; margin-top: 4px;">Ace</div>
                            </div>
                            <div class="reward-badge-container" style="position: relative;">
                                <span class="reward-badge" id="badge-conqueror" style="font-size: 32px; opacity: 0.3; transition: all 0.5s; filter: grayscale(100%); cursor: pointer;">ðŸ‘‘</span>
                                <div class="badge-name" style="font-size: 9px; color: #8b949e; text-align: center; margin-top: 4px;">Conqueror</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Level Requirements -->
                <div class="level-requirements" style="background: #1c2128; border-radius: 12px; padding: 20px; margin-top: 25px;">
                    <h4 style="color: #00bfff; font-size: 16px; margin-bottom: 15px;">ðŸ“‹ Level Requirements</h4>
                    <div class="level-req-item" id="req-bronze" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin: 8px 0; background: #0d1117; border-radius: 8px; border-left: 4px solid transparent;">
                        <div>
                            <div class="level-req-name" style="font-size: 14px; font-weight: bold;">ðŸ¥‰ Bronze</div>
                            <div class="level-req-questions" style="font-size: 12px; color: #8b949e;">Starting level</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: #8b949e;">0 questions</div>
                            <div style="font-size: 11px; color: #FFD700;">âš¡ 0 XP</div>
                        </div>
                    </div>
                    <div class="level-req-item" id="req-silver" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin: 8px 0; background: #0d1117; border-radius: 8px; border-left: 4px solid transparent;">
                        <div>
                            <div class="level-req-name" style="font-size: 14px; font-weight: bold;">ðŸ¥ˆ Silver</div>
                            <div class="level-req-questions" style="font-size: 12px; color: #8b949e;">Learner</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: #8b949e;">300 questions</div>
                            <div style="font-size: 11px; color: #FFD700;">âš¡ 3,000 XP</div>
                        </div>
                    </div>
                    <div class="level-req-item" id="req-gold" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin: 8px 0; background: #0d1117; border-radius: 8px; border-left: 4px solid transparent;">
                        <div>
                            <div class="level-req-name" style="font-size: 14px; font-weight: bold;">ðŸ¥‡ Gold</div>
                            <div class="level-req-questions" style="font-size: 12px; color: #8b949e;">Expert</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: #8b949e;">700 questions</div>
                            <div style="font-size: 11px; color: #FFD700;">âš¡ 7,000 XP</div>
                        </div>
                    </div>
                    <div class="level-req-item" id="req-platinum" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin: 8px 0; background: #0d1117; border-radius: 8px; border-left: 4px solid transparent;">
                        <div>
                            <div class="level-req-name" style="font-size: 14px; font-weight: bold;">ðŸ’Ž Platinum</div>
                            <div class="level-req-questions" style="font-size: 12px; color: #8b949e;">Master</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: #8b949e;">1500 questions</div>
                            <div style="font-size: 11px; color: #FFD700;">âš¡ 15,000 XP</div>
                        </div>
                    </div>
                    <div class="level-req-item" id="req-ace" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin: 8px 0; background: #0d1117; border-radius: 8px; border-left: 4px solid transparent;">
                        <div>
                            <div class="level-req-name" style="font-size: 14px; font-weight: bold;">ðŸ”¥ Ace</div>
                            <div class="level-req-questions" style="font-size: 12px; color: #8b949e;">Speed Demon</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: #8b949e;">3000 questions</div>
                            <div style="font-size: 11px; color: #FFD700;">âš¡ 30,000 XP</div>
                        </div>
                    </div>
                    <div class="level-req-item" id="req-conqueror" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin: 8px 0; background: #0d1117; border-radius: 8px; border-left: 4px solid transparent;">
                        <div>
                            <div class="level-req-name" style="font-size: 14px; font-weight: bold;">ðŸ‘‘ Conqueror</div>
                            <div class="level-req-questions" style="font-size: 12px; color: #8b949e;">Math King</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: #8b949e;">5000 questions</div>
                            <div style="font-size: 11px; color: #FFD700;">âš¡ 50,000 XP</div>
                        </div>
                    </div>
                </div>

                <!-- Monthly History - BGMI Style Enhanced -->
                <div class="history-section" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #00bfff; font-size: 18px; padding-left: 12px; border-left: 4px solid #00bfff; margin: 0;">ðŸ“… Season History</h3>
                        <span style="font-size: 12px; color: #8b949e;">Past Achievements</span>
                    </div>
                    <div id="achievement-history">
                        <div class="no-history" style="text-align: center; padding: 40px 20px; color: #8b949e; background: #1c2128; border-radius: 12px;">
                            <div class="no-history-icon" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">ðŸ“­</div>
                            <p style="font-size: 14px; line-height: 1.6;">No season history yet.<br>Complete the current season to build your record!</p>
                        </div>
                    </div>
                </div>

                <button style="background: #1c2128; border: 2px solid #00bfff; color: white; border-radius: 10px; padding: 15px 30px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; transition: transform 0.2s;" onclick="resetAchievements()">ðŸ”„ Reset Current Month</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="section">
            <!-- Result Header -->
            <div class="result-header">
                <button class="result-back-btn" onclick="backToHome()">â†</button>
                <span class="result-header-title">Result</span>
                <span></span>
            </div>

            <!-- Result Card -->
            <div class="result-card">
                <!-- Progress Bar -->
                <div class="result-progress-bar">
                    <div class="result-progress-correct" id="result-bar-correct"></div>
                    <div class="result-progress-wrong" id="result-bar-wrong"></div>
                </div>

                <!-- Stats Row -->
                <div class="result-stats-row">
                    <div class="result-stat">
                        <div class="result-stat-value correct-val" id="final-correct">0</div>
                        <div class="result-stat-label">Correct</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value wrong-val" id="final-wrong">0</div>
                        <div class="result-stat-label">Wrong</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value skipped-val" id="final-skipped">00</div>
                        <div class="result-stat-label">Skipped</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value accuracy-val" id="final-accuracy">0%</div>
                        <div class="result-stat-label">Accuracy</div>
                    </div>
                </div>

                <div class="result-divider"></div>

                <!-- Score & Duration -->
                <div class="result-score-row">
                    <div class="result-score-item">
                        <span class="result-score-icon">ðŸ“‹</span>
                        <div>
                            <div class="result-score-value"><span id="final-score">0</span><span style="color:#8b949e; font-size:16px;">/20.0</span></div>
                            <div class="result-score-label">Score</div>
                        </div>
                    </div>
                    <div class="result-score-item">
                        <span class="result-score-icon">â±</span>
                        <div>
                            <div class="result-score-value"><span id="final-time">0</span> <span style="font-size:16px; color:#fff;">sec</span></div>
                            <div class="result-score-label">Duration</div>
                        </div>
                    </div>
                </div>

                <div class="result-divider"></div>

                <!-- XP Gained Display -->
                <div class="result-xp-display" id="result-xp-display" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.15)); border: 2px solid #FFD700; border-radius: 12px; padding: 15px 20px; margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span style="font-size: 32px;">âš¡</span>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #FFD700;">+<span id="final-xp">0</span> XP</div>
                        <div style="font-size: 12px; color: #8b949e; margin-top: 3px;">Experience Gained</div>
                    </div>
                </div>

                <div class="result-divider"></div>

                <!-- Practise Again Button -->
                <button class="result-practise-btn" onclick="restartQuiz()">â†º Practise Again</button>
                <button class="btn" id="review-wrong-btn" onclick="startMemoryPractice()" style="background: #ff9500; display: none; width:100%; margin-top:10px; border-radius:12px;">ðŸ“š Review Wrong Answers</button>
            </div>

            <!-- Question Breakdown List -->
            <div id="history-list" style="margin-top: 12px; padding-bottom: 20px;"></div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div id="config-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Specify Practice Number Range:</h3>
            
            <div class="range-inputs">
                <div class="input-group">
                    <label>From</label>
                    <input type="number" id="range-from" value="5" min="1" max="100">
                </div>
                <div class="input-group">
                    <label>To</label>
                    <input type="number" id="range-to" value="25" min="1" max="100">
                </div>
            </div>

            <div class="divider" id="digits-divider" style="display: none;"></div>

            <div class="digits-selector" id="digits-selector" style="display: none;">
                <label>Digits To Add:</label>
                <div class="digits-dropdown">
                    <select id="digits-to-add" style="width: 150px;">
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5" selected>5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
            </div>

            <div class="divider"></div>

            <div class="questions-selector">
                <label>Number Of Questions:</label>
                <div class="slider-container">
                    <input type="range" id="questions-slider" min="5" max="50" value="10" step="5">
                    <span class="slider-value" id="slider-value">10</span>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfigModal()">Cancel</button>
                <button class="modal-btn modal-btn-start" onclick="startQuizFromModal()">Start â–¶</button>
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div id="errorDetailsModal" class="modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="modal-title" id="errorModalTitle" style="margin: 0;">Error Details</h3>
                <button style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 30px; height: 30px;" onclick="closeErrorDetailsModal()">&times;</button>
            </div>
            <div id="errorDetailsList"></div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-start" style="width: 100%;" id="practiceErrorTopicBtn">Start Practice</button>
            </div>
        </div>
    </div>

    <!-- Quiz Section -->
    <div id="quiz-section" class="section">
        <!-- Quiz Header -->
        <div class="quiz-top-bar">
            <button class="back-btn" onclick="exitQuiz()">â†</button>
            <div class="quiz-title" id="quiz-topic-title">Table</div>
            <button class="submit-btn" id="submit-btn-top" onclick="submitAnswer()">SUBMIT</button>
        </div>

        <!-- Score Bar -->
        <div class="score-bar">
            <div class="score-item">
                <span class="score-icon correct-icon">âœ“</span>
                <span class="score-count" id="correct-count">0</span>
            </div>
            <div class="score-item">
                <span class="score-icon wrong-icon">âœ—</span>
                <span class="score-count" id="wrong-count">0</span>
            </div>
            <div class="score-item">
                <span class="score-icon timer-icon">â³</span>
                <span class="score-count" id="quiz-timer">00:00:00</span>
            </div>
        </div>

        <!-- Question Progress Indicator -->
        <div class="question-progress-bar" id="question-progress-bar">
            <span class="progress-label" id="progress-label">Q 1 / 10</span>
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <span class="progress-pct" id="progress-pct">0%</span>
        </div>

        <!-- Quiz Content -->
        <div class="quiz-content">
            <div class="question-display" id="question">Loading...</div>
            
            <!-- Answer Display for DI Addition -->
            <div class="answer-display" id="answer-display" style="display: none;">
                <span style="color: #8b949e;">?</span>
            </div>

            <!-- Regular Input -->
            <input type="number" class="answer-input" id="answer-input" placeholder="Your answer" autocomplete="off" style="display: none;">
            
            <!-- Multiple Choice Options -->
            <div class="answer-options" id="answer-options" style="display: none;"></div>

            <!-- Number Pad -->
            <div class="number-pad" id="number-pad" style="display: none;">
                <button type="button" class="number-pad-btn" onclick="addDigit('1')">1</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('2')">2</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('3')">3</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('4')">4</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('5')">5</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('6')">6</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('7')">7</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('8')">8</button>
                <button type="button" class="number-pad-btn" onclick="addDigit('9')">9</button>
                <button type="button" class="number-pad-btn submit-tick" onclick="submitAnswer()">âœ“</button>
                <button type="button" class="number-pad-btn zero" onclick="addDigit('0')">0</button>
                <button type="button" class="number-pad-btn backspace" onclick="backspace()">âœ•</button>
            </div>

            <div class="feedback" id="feedback"></div>
            
            <!-- Input Mode Selector -->
            <div class="input-mode-selector" id="input-mode-selector" style="display: none;">
                <button type="button" class="mode-btn" id="numpad-mode-btn" onclick="switchToNumpad()">ðŸ”¢</button>
                <button type="button" class="mode-btn active" id="options-mode-btn" onclick="switchToOptions()">âŠž</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchSection('performance')">
            <div class="nav-icon">ðŸ“Š</div>
            <div class="nav-label">Performance</div>
        </button>
        <button class="nav-item" onclick="switchSection('practice')">
            <div class="nav-icon">âœï¸</div>
            <div class="nav-label">Practise</div>
        </button>
        <button class="nav-item" onclick="switchSection('revision')">
            <div class="nav-icon">ðŸ“š</div>
            <div class="nav-label">Revision</div>
        </button>
        <button class="nav-item" onclick="switchSection('achievement')">
            <div class="nav-icon">ðŸ†</div>
            <div class="nav-label">Achievement</div>
        </button>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // App State
        let currentTopic = '';
        let useMultipleChoice = false;
        let showingMultipleChoice = true;
        let quizConfig = {
            from: 5,
            to: 25,
            questions: 10,
            digitsToAdd: 5
        };
        
        let quizState = {
            topic: '',
            currentQuestion: 0,
            totalQuestions: 10,
            correctAnswers: 0,
            wrongAnswers: 0,
            skippedAnswers: 0,
            currentAnswer: 0,
            questionStartTime: 0,
            totalTime: 0,
            timerInterval: null,
            quizStartTime: 0,
            currentUserAnswer: '',
            multipleChoiceOptions: [],
            askedQuestions: new Set(), // Track asked questions to avoid repetition
            sessionHistory: [], // Store each question's data
            wrongQuestions: [] // Store wrong questions for memory practice
        };

        let stats = {
            totalQuestions: 0,
            correctAnswers: 0,
            wrongAnswers: 0,
            skippedAnswers: 0,
            totalTime: 0
        };

        // Optimized random number generator
        function fastRandom(from, to) {
            return (from + Math.random() * (to - from + 1)) | 0;
        }

        // Speed Rating System
        function getSpeedRating(timeInSeconds) {
            if (timeInSeconds < 1) return { text: 'Genius âš¡', color: '#FFD700', emoji: 'âš¡' };
            if (timeInSeconds < 2) return { text: 'Excellent â­', color: '#00ff9f', emoji: 'â­' };
            if (timeInSeconds < 3) return { text: 'Good ðŸ‘', color: '#00bfff', emoji: 'ðŸ‘' };
            return { text: 'Needs Practice ðŸ“š', color: '#ff9500', emoji: 'ðŸ“š' };
        }
        const topicRanges = {
            'table': { from: 5, to: 25 },
            'cube': { from: 5, to: 25 },
            'square': { from: 5, to: 50 },
            'sqrt': { from: 1, to: 400 },
            'cbrt': { from: 1, to: 1000 },
            'addition': { from: 1, to: 100 },
            'subtraction': { from: 1, to: 100 },
            'multiplication': { from: 1, to: 20 },
            'division': { from: 1, to: 100 },
            'fraction': { from: 1, to: 10 },
            'percentage': { from: 1, to: 100 },
            'di-addition': { from: 10, to: 99 },
            'bodmas': { from: 2, to: 25 }
        };

        // Load stats
        function loadStats() {
            const saved = localStorage.getItem('speedMathStats');
            if (saved) {
                stats = JSON.parse(saved);
                updateStatsDisplay();
            }
        }

        // Save stats
        function saveStats() {
            localStorage.setItem('speedMathStats', JSON.stringify(stats));
            
            // Save session history
            const allSessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            if (quizState.sessionHistory && quizState.sessionHistory.length > 0) {
                allSessions.push({
                    date: new Date().toISOString(),
                    timestamp: Date.now(),
                    topic: quizState.topic,
                    questions: quizState.totalQuestions,
                    correct: quizState.correctAnswers,
                    wrong: quizState.wrongAnswers,
                    totalTime: quizState.totalTime,
                    avgTime: (quizState.totalTime / quizState.totalQuestions).toFixed(2),
                    accuracy: ((quizState.correctAnswers / quizState.totalQuestions) * 100).toFixed(1),
                    history: quizState.sessionHistory
                });
                
                // Keep only last 100 sessions (increased from 50)
                if (allSessions.length > 100) {
                    allSessions.shift();
                }
                
                localStorage.setItem('speedMathSessions', JSON.stringify(allSessions));
                
                // Update performance displays after saving
                if (typeof updateAllPerformanceStats === 'function') {
                    updateAllPerformanceStats();
                }
                
                // Update account stats
                if (typeof updateAccountStats === 'function') {
                    updateAccountStats();
                }
            }
        }

        // Switch sections

        // ====== ACHIEVEMENT SYSTEM (BGMI STYLE) ======

        const ACHIEVEMENT_LEVELS = [
            { 
                name: 'Bronze', 
                icon: 'ðŸ¥‰', 
                required: 0, 
                xp: 0,
                class: 'bronze',
                subtitle: 'Starting Level',
                color: '#CD7F32'
            },
            { 
                name: 'Silver', 
                icon: 'ðŸ¥ˆ', 
                required: 300, 
                xp: 3000,
                class: 'silver',
                subtitle: 'Learner',
                color: '#C0C0C0'
            },
            { 
                name: 'Gold', 
                icon: 'ðŸ¥‡', 
                required: 700, 
                xp: 7000,
                class: 'gold',
                subtitle: 'Expert',
                color: '#FFD700'
            },
            { 
                name: 'Platinum', 
                icon: 'ðŸ’Ž', 
                required: 1500, 
                xp: 15000,
                class: 'platinum',
                subtitle: 'Master',
                color: '#E5E4E2'
            },
            { 
                name: 'Ace', 
                icon: 'ðŸ”¥', 
                required: 3000, 
                xp: 30000,
                class: 'ace',
                subtitle: 'Speed Demon',
                color: '#ff4d6d'
            },
            { 
                name: 'Conqueror', 
                icon: 'ðŸ‘‘', 
                required: 5000, 
                xp: 50000,
                class: 'conqueror',
                subtitle: 'Math King',
                color: '#FFD700'
            }
        ];

        // XP per question
        const XP_PER_QUESTION = 10;

        // Get current month key (YYYY-MM format)
        function getCurrentMonthKey() {
            const now = new Date();
            return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        }

        // Get achievement data with auto-reset
        function getAchievementData() {
            let data = JSON.parse(localStorage.getItem('achievementData') || '{}');
            const key = getCurrentMonthKey();

            if (!data[key]) {
                data[key] = {
                    attempted: 0,
                    correct: 0,
                    accuracy: 0,
                    level: 'Bronze',
                    levelIndex: 0
                };
                localStorage.setItem('achievementData', JSON.stringify(data));
            }

            return data;
        }

        // Update achievement after quiz
        function updateAchievementAfterQuiz(correct, attempted) {
            try {
                console.log('Updating achievements:', {correct, attempted});
                let data = getAchievementData();
                let key = getCurrentMonthKey();

                const beforeAttempted = data[key].attempted;
                const beforeLevel = data[key].level;

                data[key].attempted += attempted;
                data[key].correct += correct;
                // Fix: Handle division by zero when calculating accuracy
                data[key].accuracy = data[key].attempted > 0 
                    ? (data[key].correct / data[key].attempted * 100).toFixed(1)
                    : '0.0';
                
                // Calculate level
                const levelInfo = calculateAchievementLevel(data[key].attempted);
                data[key].level = levelInfo.name;
                data[key].levelIndex = levelInfo.index;

                localStorage.setItem('achievementData', JSON.stringify(data));
                
                console.log('Achievement updated:', {
                    beforeAttempted,
                    afterAttempted: data[key].attempted,
                    beforeLevel,
                    afterLevel: data[key].level,
                    levelIndex: data[key].levelIndex
                });
                
                // Show level up notification if level changed
                if (beforeLevel !== data[key].level) {
                    setTimeout(() => {
                        alert(`ðŸŽ‰ LEVEL UP!\n\nYou've reached ${levelInfo.icon} ${levelInfo.name}!\n\nTotal Questions: ${data[key].attempted}\nXP Earned: ${data[key].attempted * 10}`);
                    }, 1000);
                }
            } catch (error) {
                console.error('Error updating achievements:', error);
            }
        }

        // Calculate level based on questions attempted
        function calculateAchievementLevel(attempted) {
            for (let i = ACHIEVEMENT_LEVELS.length - 1; i >= 0; i--) {
                if (attempted >= ACHIEVEMENT_LEVELS[i].required) {
                    return {
                        name: ACHIEVEMENT_LEVELS[i].name,
                        index: i,
                        icon: ACHIEVEMENT_LEVELS[i].icon,
                        class: ACHIEVEMENT_LEVELS[i].class
                    };
                }
            }
            return {
                name: 'Bronze',
                index: 0,
                icon: 'ðŸ¥‰',
                class: 'bronze'
            };
        }

        // Load achievement UI - Enhanced BGMI Style
        function loadAchievement() {
            // Safety check - only run if achievement section exists and elements are present
            const achievementSection = document.getElementById('achievement-section');
            if (!achievementSection || !document.getElementById('achievement-level')) {
                return;
            }

            try {
                const data = getAchievementData();
                const key = getCurrentMonthKey();
                const month = data[key];

                // Get level info
                const currentLevel = calculateAchievementLevel(month.attempted);
                const nextLevel = ACHIEVEMENT_LEVELS[currentLevel.index + 1];

                // Calculate XP
                const currentXP = month.attempted * XP_PER_QUESTION;
                const currentLevelXP = ACHIEVEMENT_LEVELS[currentLevel.index].xp;
                const nextLevelXP = nextLevel ? nextLevel.xp : currentLevelXP;

                // Update level badge with icon and name
                const levelElement = document.getElementById('achievement-level');
                const levelNameElem = document.getElementById('achievement-level-name');
                const levelSubtitleElem = document.getElementById('achievement-level-subtitle');
                
                if (levelElement) {
                    levelElement.textContent = currentLevel.icon;
                }
                if (levelNameElem) {
                    levelNameElem.textContent = currentLevel.name;
                    levelNameElem.style.color = ACHIEVEMENT_LEVELS[currentLevel.index].color;
                }
                if (levelSubtitleElem) {
                    levelSubtitleElem.textContent = ACHIEVEMENT_LEVELS[currentLevel.index].subtitle;
                }

                // Update XP display
                const xpCurrentElem = document.getElementById('achievement-xp-current');
                const xpTargetElem = document.getElementById('achievement-xp-target');
                const xpPercentElem = document.getElementById('achievement-xp-percent');
                const xpNextElem = document.getElementById('achievement-xp-next');
                
                if (xpCurrentElem) xpCurrentElem.textContent = currentXP.toLocaleString() + ' XP';
                if (xpTargetElem) xpTargetElem.textContent = nextLevelXP.toLocaleString() + ' XP';

                // Update progress bar with XP
                if (nextLevel) {
                    const xpProgress = ((currentXP - currentLevelXP) / (nextLevelXP - currentLevelXP) * 100);
                    const progressPercent = Math.min(100, Math.max(0, xpProgress)).toFixed(0);
                    const xpNeeded = nextLevelXP - currentXP;
                    
                    const progressText = document.getElementById('achievement-progress-text');
                    const progressFill = document.getElementById('achievement-progress-fill');
                    
                    if (progressText) progressText.textContent = month.attempted + ' / ' + nextLevel.required + ' Questions';
                    if (xpPercentElem) xpPercentElem.textContent = progressPercent + '%';
                    if (xpNextElem) xpNextElem.textContent = '+' + xpNeeded.toLocaleString() + ' XP to ' + nextLevel.name;
                    if (progressFill) progressFill.style.width = progressPercent + '%';
                } else {
                    // Max level reached
                    const progressText = document.getElementById('achievement-progress-text');
                    const progressFill = document.getElementById('achievement-progress-fill');
                    
                    if (progressText) progressText.textContent = month.attempted + ' Questions (MAX LEVEL)';
                    if (xpPercentElem) xpPercentElem.textContent = '100%';
                    if (xpNextElem) xpNextElem.textContent = 'Maximum level achieved! ðŸ‘‘';
                    if (progressFill) progressFill.style.width = '100%';
                }

                // Update season name and countdown
                updateSeasonCountdown();

                // Update stats
                const attemptedElem = document.getElementById('achievement-attempted');
                const correctElem = document.getElementById('achievement-correct');
                const accuracyElem = document.getElementById('achievement-accuracy');
                
                if (attemptedElem) attemptedElem.textContent = month.attempted;
                if (correctElem) correctElem.textContent = month.correct;
                if (accuracyElem) accuracyElem.textContent = month.accuracy + '%';

                // Update reward badges with unlock animation
                updateRewardBadges(currentLevel.index);

                // Highlight current level requirement
                ACHIEVEMENT_LEVELS.forEach(function(level, index) {
                    const reqElement = document.getElementById('req-' + level.class);
                    if (reqElement) {
                        if (index === currentLevel.index) {
                            reqElement.style.borderLeftColor = '#00bfff';
                            reqElement.style.background = 'rgba(0, 191, 255, 0.1)';
                        } else {
                            reqElement.style.borderLeftColor = 'transparent';
                            reqElement.style.background = '#0d1117';
                        }
                    }
                });

                // Load monthly history
                loadAchievementHistory(data);
            } catch (error) {
                // Silently fail if elements don't exist
                console.log('Achievement UI not ready yet');
            }
        }
        
        // Update season countdown - BGMI Style
        function updateSeasonCountdown() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Get last day of current month
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysLeft = Math.ceil((lastDay - now) / (1000 * 60 * 60 * 24));
            
            // Get month name
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const seasonName = monthNames[currentMonth] + ' ' + currentYear;
            
            // Update UI
            const seasonNameElem = document.getElementById('season-name');
            const countdownElem = document.getElementById('season-countdown');
            
            if (seasonNameElem) seasonNameElem.textContent = seasonName;
            if (countdownElem) {
                if (daysLeft === 1) {
                    countdownElem.textContent = '1 Day';
                    countdownElem.style.color = '#ff4d6d';
                } else if (daysLeft <= 7) {
                    countdownElem.textContent = daysLeft + ' Days';
                    countdownElem.style.color = '#FFA500';
                } else {
                    countdownElem.textContent = daysLeft + ' Days';
                    countdownElem.style.color = '#ff4d6d';
                }
            }
        }
        
        function getLevelColor(levelClass) {
            const colors = {
                'bronze': '#CD7F32',
                'silver': '#C0C0C0',
                'gold': '#FFD700',
                'platinum': '#E5E4E2',
                'ace': '#ff4d6d',
                'conqueror': '#FFD700'
            };
            return colors[levelClass] || '#FFD700';
        }

        // Update reward badges with unlock animation
        function updateRewardBadges(currentLevelIndex) {
            const badges = ['bronze', 'silver', 'gold', 'platinum', 'ace', 'conqueror'];
            badges.forEach(function(badge, index) {
                const element = document.getElementById('badge-' + badge);
                if (element) {
                    if (index <= currentLevelIndex) {
                        element.style.opacity = '1';
                        element.style.filter = 'grayscale(0%)';
                        // Add unlock animation class if newly unlocked
                        if (!element.classList.contains('unlocked')) {
                            element.classList.add('unlocked');
                        }
                    } else {
                        element.style.opacity = '0.3';
                        element.style.filter = 'grayscale(100%)';
                        element.classList.remove('unlocked');
                    }
                }
            });
        }

        // Load achievement history - Enhanced BGMI Style
        function loadAchievementHistory(data) {
            const container = document.getElementById('achievement-history');
            if (!container) return;
            
            const months = Object.keys(data).sort().reverse();
            const currentKey = getCurrentMonthKey();

            if (months.length === 0 || (months.length === 1 && data[months[0]].attempted === 0)) {
                container.innerHTML = '<div class="no-history" style="text-align: center; padding: 40px 20px; color: #8b949e; background: #1c2128; border-radius: 12px;"><div class="no-history-icon" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">ðŸ“­</div><p style="font-size: 14px; line-height: 1.6;">No season history yet.<br>Complete the current season to build your record!</p></div>';
                return;
            }

            let html = '';
            months.forEach(function(monthKey) {
                const month = data[monthKey];
                if (month.attempted === 0) return;
                
                // Skip current month in history
                if (monthKey === currentKey) return;

                const levelInfo = calculateAchievementLevel(month.attempted);
                const parts = monthKey.split('-');
                const year = parts[0];
                const monthNum = parts[1];
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long' 
                });
                
                const totalXP = month.attempted * XP_PER_QUESTION;
                const levelColor = ACHIEVEMENT_LEVELS[levelInfo.index].color;

                html += '<div class="month-history-item" style="background: linear-gradient(135deg, #1c2128, #2d333b); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #2d333b; transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.borderColor=\'' + levelColor + '\'; this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,191,255,0.2)\';" onmouseout="this.style.borderColor=\'#2d333b\'; this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\';">' +
                    '<div style="content: \'\'; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, ' + levelColor + '20 0%, transparent 70%); pointer-events: none;"></div>' +
                    '<div class="month-history-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; position: relative; z-index: 1;">' +
                        '<div>' +
                            '<div class="month-history-season" style="font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Season</div>' +
                            '<div class="month-history-date" style="font-size: 16px; font-weight: bold; color: #ffffff;">' + monthName + '</div>' +
                        '</div>' +
                        '<div style="text-align: right;">' +
                            '<div class="month-history-level" style="font-size: 24px; font-weight: bold; color: ' + levelColor + '; text-shadow: 0 0 10px ' + levelColor + '40;">' +
                                levelInfo.icon +
                            '</div>' +
                            '<div class="month-history-level-name" style="font-size: 12px; font-weight: bold; color: ' + levelColor + '; margin-top: 3px;">' +
                                levelInfo.name +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="month-history-xp" style="background: rgba(0, 191, 255, 0.08); border-radius: 8px; padding: 10px; margin-bottom: 12px; position: relative; z-index: 1;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                            '<span style="font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px;">Total XP Earned</span>' +
                            '<span style="font-size: 16px; font-weight: bold; color: #FFD700;">âš¡ ' + totalXP.toLocaleString() + ' XP</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="month-history-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 13px; position: relative; z-index: 1;">' +
                        '<div class="month-history-stat" style="text-align: center; padding: 12px 8px; background: rgba(13, 17, 23, 0.8); border-radius: 10px; border: 1px solid #2d333b;">' +
                            '<div style="font-size: 20px; margin-bottom: 5px;">ðŸŽ¯</div>' +
                            '<span class="month-history-stat-value" style="font-weight: bold; color: #00bfff; display: block; font-size: 18px; margin-bottom: 3px;">' + month.attempted + '</span>' +
                            '<span class="month-history-stat-label" style="color: #8b949e; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Attempted</span>' +
                        '</div>' +
                        '<div class="month-history-stat" style="text-align: center; padding: 12px 8px; background: rgba(13, 17, 23, 0.8); border-radius: 10px; border: 1px solid #2d333b;">' +
                            '<div style="font-size: 20px; margin-bottom: 5px;">âœ…</div>' +
                            '<span class="month-history-stat-value" style="font-weight: bold; color: #4caf50; display: block; font-size: 18px; margin-bottom: 3px;">' + month.correct + '</span>' +
                            '<span class="month-history-stat-label" style="color: #8b949e; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Correct</span>' +
                        '</div>' +
                        '<div class="month-history-stat" style="text-align: center; padding: 12px 8px; background: rgba(13, 17, 23, 0.8); border-radius: 10px; border: 1px solid #2d333b;">' +
                            '<div style="font-size: 20px; margin-bottom: 5px;">ðŸ“Š</div>' +
                            '<span class="month-history-stat-value" style="font-weight: bold; color: #FFD700; display: block; font-size: 18px; margin-bottom: 3px;">' + month.accuracy + '%</span>' +
                            '<span class="month-history-stat-label" style="color: #8b949e; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Accuracy</span>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            if (html === '') {
                container.innerHTML = '<div class="no-history" style="text-align: center; padding: 40px 20px; color: #8b949e; background: #1c2128; border-radius: 12px;"><div class="no-history-icon" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">ðŸ“­</div><p style="font-size: 14px; line-height: 1.6;">No completed seasons yet.<br>Finish this season to see your history here!</p></div>';
            } else {
                container.innerHTML = html;
            }
        }

        // Reset achievements (current month only)
        function resetAchievements() {
            if (confirm('âš ï¸ Reset current month\'s achievements?\n\nThis will only reset this month\'s progress. Your history will be saved!')) {
                const data = getAchievementData();
                const key = getCurrentMonthKey();
                
                data[key] = {
                    attempted: 0,
                    correct: 0,
                    accuracy: 0,
                    level: 'Bronze',
                    levelIndex: 0
                };
                
                localStorage.setItem('achievementData', JSON.stringify(data));
                loadAchievement();
                alert('âœ… Current month reset! Start fresh!');
            }
        }

        function switchSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(section + '-section').classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            // Load achievement data when switching to achievement section
            if (section === 'achievement') {
                loadAchievement();
            }
        }

        // Start Quiz (shows modal or topic selector)
        function startQuiz(topic) {
            currentTopic = topic;

            // Error Practice gets its own section
            if (topic === 'error') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('error-practice-section').classList.add('active');
                renderErrorSections();
                return;
            }

            // Table AND Multiplication both get the Multiplication Tables screen
            if (topic === 'table' || topic === 'multiplication') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('table-section').classList.add('active');
                updateTablePreview();
                return;
            }

            // Addition & Subtraction get their own selection screen
            if (topic === 'addition' || topic === 'subtraction') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('addition-section').classList.add('active');
                updateAdditionPreview();
                return;
            }

            // Trigonometry gets its own selection screen
            if (topic === 'trigonometry') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('trigonometry-section').classList.add('active');
                return;
            }

            // Square gets its own selection screen
            if (topic === 'square') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('square-section').classList.add('active');
                updateSquarePreview();
                return;
            }

            // Cube gets its own selection screen
            if (topic === 'cube') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('cube-section').classList.add('active');
                updateCubePreview();
                return;
            }

            // Square Root gets its own selection screen
            if (topic === 'sqrt') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('sqrt-section').classList.add('active');
                updateSqrtPreview();
                return;
            }

            // Cube Root gets its own selection screen
            if (topic === 'cbrt') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('cbrt-section').classList.add('active');
                updateCbrtPreview();
                return;
            }

            // Percentage gets its own selection screen
            if (topic === 'percentage') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('percentage-section').classList.add('active');
                return;
            }

            // Pythagorean gets its own selection screen
            if (topic === 'pythagorean') {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('pythagorean-section').classList.add('active');
                return;
            }
            
            // Set default ranges for this topic
            const range = topicRanges[topic] || { from: 5, to: 25 };
            document.getElementById('range-from').value = range.from;
            document.getElementById('range-to').value = range.to;
            document.getElementById('questions-slider').value = 10;
            document.getElementById('slider-value').textContent = 10;
            
            // Show/hide digits selector for DI Addition
            if (topic === 'di-addition') {
                document.getElementById('digits-selector').style.display = 'block';
                document.getElementById('digits-divider').style.display = 'block';
            } else {
                document.getElementById('digits-selector').style.display = 'none';
                document.getElementById('digits-divider').style.display = 'none';
            }
            
            // Show modal
            document.getElementById('config-modal').classList.add('active');
        }

        // Restore main UI chrome (header, nav, content wrapper)
        function showMainContent() {
            document.querySelector('.main-content').style.display = 'block';
            document.querySelector('.header').style.display = 'flex';
            document.querySelector('.progress-line').style.display = 'block';
            document.querySelector('.bottom-nav').style.display = 'grid';
        }

        function goToPractice() {
            showMainContent();
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('practice-section').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[1].classList.add('active');
        }

        // Get table config values safely
        function getTableConfig() {
            const tFrom  = Math.max(1, parseInt(document.getElementById('table-from').value)    || 2);
            const tTo    = Math.max(1, parseInt(document.getElementById('table-to').value)      || 20);
            const mFrom  = Math.max(1, parseInt(document.getElementById('table-mult-from').value)|| 1);
            const mTo    = Math.max(1, parseInt(document.getElementById('table-mult-to').value) || 10);
            return {
                tFrom: Math.min(tFrom, tTo),
                tTo:   Math.max(tFrom, tTo),
                mFrom: Math.min(mFrom, mTo),
                mTo:   Math.max(mFrom, mTo)
            };
        }

        // Live-update chart preview
        function updateTablePreview() {
            const { tFrom, mFrom } = getTableConfig();
            const n = tFrom;
            const m = mFrom;

            // Show 3 lines of the chart preview
            let lines = '';
            for (let i = 0; i < 3; i++) {
                const mult = m + i;
                lines += `${n} Ã— ${mult} = ${n * mult}`;
                if (i < 2) lines += '<br>';
            }
            document.getElementById('table-chart-preview').innerHTML = lines;
        }

        // Start table quiz
        function startTableQuiz(type) {
            const cfg = getTableConfig();
            quizConfig.tableFrom = cfg.tFrom;
            quizConfig.tableTo   = cfg.tTo;
            quizConfig.multFrom  = cfg.mFrom;
            quizConfig.multTo    = cfg.mTo;
            quizConfig.tableType = type;
            quizConfig.questions = 10;
            currentTopic = 'table';
            initAndRunQuiz('table');
            // Add this line after creating quizState
quizState.currentQuestion = 0; // Ensure it starts at 0
quizState.correctAnswers = 0;
quizState.wrongAnswers = 0;
quizState.skippedAnswers = 0;
quizState.totalTime = 0;
quizState.sessionHistory = [];
quizState.wrongQuestions = [];
        }

        // Open Tables Chart full screen
        function openTablesChart() {
            const cfg = getTableConfig();
            const body = document.getElementById('table-chart-body');
            body.innerHTML = '';

            // Update range label
            document.getElementById('table-chart-range-bar').textContent =
                `Table ${cfg.tFrom} to ${cfg.tTo}  |  Ã— ${cfg.mFrom} to ${cfg.mTo}`;

            // Build one block per table number
            for (let n = cfg.tFrom; n <= cfg.tTo; n++) {
                const block = document.createElement('div');
                block.className = 'tbl-block';

                const title = document.createElement('div');
                title.className = 'tbl-block-title';
                title.textContent = `Table of ${n}`;
                block.appendChild(title);

                const rowsDiv = document.createElement('div');
                rowsDiv.className = 'tbl-block-rows';

                for (let m = cfg.mFrom; m <= cfg.mTo; m++) {
                    const row = document.createElement('div');
                    row.className = 'tbl-row';
                    row.innerHTML = `<span>${n} Ã— ${m}</span><span class="tbl-row-eq">= ${n * m}</span>`;
                    rowsDiv.appendChild(row);
                }

                block.appendChild(rowsDiv);
                body.appendChild(block);
            }

            // Switch to chart section
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('table-chart-section').classList.add('active');
        }

        // Go back from chart to table selection
        function closeTablesChart() {
            showMainContent();
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('table-section').classList.add('active');
        }

        // ===== ADDITION SECTION =====
        function updateAdditionPreview() {
            const digits = parseInt(document.getElementById('add-digits-select').value) || 2;
            document.getElementById('add-digits-display').textContent = digits;

            // Generate example numbers of correct digit count
            const min = Math.pow(10, digits - 1);
            const max = Math.pow(10, digits) - 1;
            const a = fastRandom(min, max);
            const b = fastRandom(min, max);

            document.getElementById('add-preview-addition').textContent = `${a} + ${b}`;
            document.getElementById('add-preview-subtraction').textContent = `${Math.max(a,b)} âˆ’ ${Math.min(a,b)}`;
        }

        function startAdditionQuiz(subtype) {
            const digits = parseInt(document.getElementById('add-digits-select').value) || 2;
            quizConfig.addDigits = digits;
            quizConfig.addSubtype = subtype;
            quizConfig.questions = 10;
            currentTopic = subtype;
            initAndRunQuiz(subtype);
        }

        // Shared quiz initializer

        // Shared quiz initializer used by table types and normal quizzes
        function initAndRunQuiz(topic) {
            // CRITICAL FIX: Ensure we have a valid question count
            if (!quizConfig.questions || quizConfig.questions <= 0) {
                console.error('Invalid question count:', quizConfig.questions);
                alert('âš ï¸ Error: Invalid quiz configuration.\n\nPlease select a valid number of questions.');
                return;
            }
            
            quizState = {
                topic: topic,
                currentQuestion: 0,
                totalQuestions: quizConfig.questions,
                correctAnswers: 0,
                wrongAnswers: 0,
                skippedAnswers: 0,
                currentAnswer: 0,
                questionStartTime: Date.now(),
                totalTime: 0,
                timerInterval: null,
                quizStartTime: Date.now(),
                currentUserAnswer: '',
                multipleChoiceOptions: [],
                askedQuestions: new Set(),
                sessionHistory: [],
                wrongQuestions: []
            };
            
            console.log('Quiz initialized:', {
                topic: topic,
                totalQuestions: quizState.totalQuestions,
                config: quizConfig
            });

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('quiz-section').classList.add('active');
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.progress-line').style.display = 'none';
            document.querySelector('.bottom-nav').style.display = 'none';

            const topicNames = {
                'table': `Table (Type ${quizConfig.tableType || 1})`,
                'multiplication': 'Multiplication',
                'addition': `Addition (${quizConfig.addDigits||2}-digit)`, 'subtraction': `Subtraction (${quizConfig.addDigits||2}-digit)`,
                'add-sub-mixed': `Mixed +/âˆ’ (${quizConfig.addDigits||2}-digit)`,
                'division': 'Division', 'square': 'Square', 'cube': 'Cube',
                'sqrt': 'Square Root', 'cbrt': 'Cube Root',
                'fraction': 'Fractions', 'percentage': 'Percentage',
                'trigonometry': 'Trigonometry', 'pythagorean': 'Pythagorean',
                'trig-common': 'Common Angles', 'trig-addition': 'Addition & Subtraction',
                'trig-double': 'Double Angle', 'trig-multiple': 'Multiple Angle',
                'trig-half': 'Half Angle', 'trig-mixed': 'Trigonometry Mixed',
                'di-addition': 'DI Addition', 'mixed': 'Mixed', 'complexity': 'Complexity',
                'daily': 'Daily Challenge', 'workout': 'Workout', 'error': 'Error Practice',
                'bodmas': 'ðŸ§® BODMAS â€” Multi-Step',
                'percentage': 'Fraction â†” Percentage',
                'pythagorean': 'Pythagorean Triplets'
            };
            document.getElementById('quiz-topic-title').textContent = topicNames[topic] || 'Math Quiz';

            document.getElementById('correct-count').textContent = '0';
            document.getElementById('wrong-count').textContent = '0';
            document.getElementById('quiz-timer').textContent = '00:00:00';

            // Reset progress indicator
            const pfill = document.getElementById('progress-fill');
            const plabel = document.getElementById('progress-label');
            const ppct = document.getElementById('progress-pct');
            if (pfill)  { pfill.style.width = '0%'; pfill.style.background = 'linear-gradient(90deg,#ff4d6d,#ff9500)'; }
            if (plabel) plabel.textContent = `Q 0 / ${quizConfig.questions}`;
            if (ppct)   ppct.textContent = '0%';

            useMultipleChoice = true;
            showingMultipleChoice = true;
            document.getElementById('answer-input').style.display = 'none';
            document.getElementById('answer-display').style.display = 'none';
            document.getElementById('answer-options').style.display = 'grid';
            document.getElementById('number-pad').style.display = 'none';
            document.getElementById('input-mode-selector').style.display = 'flex';
            document.getElementById('submit-btn-top').style.display = 'block';
            document.getElementById('numpad-mode-btn').classList.remove('active');
            document.getElementById('options-mode-btn').classList.add('active');

            loadQuestion();
            startQuizTimer();
        }

        // Close Modal
        function closeConfigModal() {
            document.getElementById('config-modal').classList.remove('active');
        }

        // Slider Update
        const slider = document.getElementById('questions-slider');
        const sliderValue = document.getElementById('slider-value');
        
        slider.addEventListener('input', function() {
            sliderValue.textContent = this.value;
        });

        // Start Quiz from Modal
        function startQuizFromModal() {
            quizConfig.from = parseInt(document.getElementById('range-from').value);
            quizConfig.to = parseInt(document.getElementById('range-to').value);
            quizConfig.questions = parseInt(document.getElementById('questions-slider').value);
            
            if (currentTopic === 'di-addition') {
                quizConfig.digitsToAdd = parseInt(document.getElementById('digits-to-add').value);
            }
            
            closeConfigModal();
            initAndRunQuiz(currentTopic);
        }

        // ===== SQUARE SECTION =====
        function getSqConfig() {
            const from = Math.max(1, parseInt(document.getElementById('sq-from').value) || 2);
            const to   = Math.max(1, parseInt(document.getElementById('sq-to').value)   || 99);
            return { from: Math.min(from, to), to: Math.max(from, to) };
        }

        function updateSquarePreview() {
            const { from } = getSqConfig();
            document.getElementById('sq-practice-preview').innerHTML =
                `${from}<sup>2</sup> = ?`;
            document.getElementById('sq-chart-preview').innerHTML =
                `${from}<sup>2</sup> = ${from*from}<br>${from+1}<sup>2</sup> = ${(from+1)*(from+1)}<br>${from+2}<sup>2</sup> = ${(from+2)*(from+2)}`;
        }

        function startSquareQuiz() {
            const { from, to } = getSqConfig();
            quizConfig.from = from;
            quizConfig.to   = to;
            quizConfig.questions = 15;
            currentTopic = 'square';
            initAndRunQuiz('square');
        }

        function openSquareChart() {
            const { from, to } = getSqConfig();
            const body = document.getElementById('sq-chart-body');
            body.innerHTML = '';
            document.getElementById('sq-chart-range-bar').textContent = `Square ${from}Â² to ${to}Â²`;

            // Group into rows of 2
            const rowsDiv = document.createElement('div');
            rowsDiv.className = 'tbl-block';
            const title = document.createElement('div');
            title.className = 'tbl-block-title';
            title.textContent = `Squares â€” ${from}Â² to ${to}Â²`;
            rowsDiv.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'tbl-block-rows';

            for (let n = from; n <= to; n++) {
                const row = document.createElement('div');
                row.className = 'tbl-row';
                row.innerHTML = `<span>${n}Â²</span><span class="tbl-row-eq">= ${n*n}</span>`;
                grid.appendChild(row);
            }
            rowsDiv.appendChild(grid);
            body.appendChild(rowsDiv);

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('square-chart-section').classList.add('active');
        }

        function closeSquareChart() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('square-section').classList.add('active');
        }

        // ===== CUBE SECTION =====
        function getCbConfig() {
            const from = Math.max(1, parseInt(document.getElementById('cb-from').value) || 2);
            const to   = Math.max(1, parseInt(document.getElementById('cb-to').value)   || 30);
            return { from: Math.min(from, to), to: Math.max(from, to) };
        }

        function updateCubePreview() {
            const { from } = getCbConfig();
            document.getElementById('cb-practice-preview').innerHTML =
                `${from}<sup>3</sup> = ?`;
            document.getElementById('cb-chart-preview').innerHTML =
                `${from}<sup>3</sup> = ${from**3}<br>${from+1}<sup>3</sup> = ${(from+1)**3}<br>${from+2}<sup>3</sup> = ${(from+2)**3}`;
        }

        function startCubeQuiz() {
            const { from, to } = getCbConfig();
            quizConfig.from = from;
            quizConfig.to   = to;
            quizConfig.questions = 15;
            currentTopic = 'cube';
            initAndRunQuiz('cube');
        }

        function openCubeChart() {
            const { from, to } = getCbConfig();
            const body = document.getElementById('cb-chart-body');
            body.innerHTML = '';
            document.getElementById('cb-chart-range-bar').textContent = `Cube ${from}Â³ to ${to}Â³`;

            const block = document.createElement('div');
            block.className = 'tbl-block';
            const title = document.createElement('div');
            title.className = 'tbl-block-title';
            title.textContent = `Cubes â€” ${from}Â³ to ${to}Â³`;
            block.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'tbl-block-rows';

            for (let n = from; n <= to; n++) {
                const row = document.createElement('div');
                row.className = 'tbl-row';
                row.innerHTML = `<span>${n}Â³</span><span class="tbl-row-eq">= ${n**3}</span>`;
                grid.appendChild(row);
            }
            block.appendChild(grid);
            body.appendChild(block);

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('cube-chart-section').classList.add('active');
        }

        function closeCubeChart() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('cube-section').classList.add('active');
        }

        // ===== SQUARE ROOT SECTION =====
        function getSqrtConfig() {
            const from = Math.max(1, parseInt(document.getElementById('sqrt-from').value) || 4);
            const to   = Math.max(1, parseInt(document.getElementById('sqrt-to').value) || 400);
            return { from: Math.min(from, to), to: Math.max(from, to) };
        }

        function updateSqrtPreview() {
            const { from } = getSqrtConfig();
            // Only show perfect squares for preview
            const sqrtVal = Math.sqrt(from);
            const nextPerfect = Math.ceil(sqrtVal) ** 2;
            const nextNext = (Math.ceil(sqrtVal) + 1) ** 2;
            const nextNextNext = (Math.ceil(sqrtVal) + 2) ** 2;
            
            document.getElementById('sqrt-practice-preview').textContent = `âˆš${from} = ?`;
            document.getElementById('sqrt-chart-preview').innerHTML = 
                `âˆš${nextPerfect} = ${Math.sqrt(nextPerfect)}<br>âˆš${nextNext} = ${Math.sqrt(nextNext)}<br>âˆš${nextNextNext} = ${Math.sqrt(nextNextNext)}`;
        }

        function startSqrtQuiz() {
            const { from, to } = getSqrtConfig();
            quizConfig.from = from;
            quizConfig.to   = to;
            quizConfig.questions = 15;
            currentTopic = 'sqrt';
            initAndRunQuiz('sqrt');
        }

        function openSqrtChart() {
            const { from, to } = getSqrtConfig();
            const body = document.getElementById('sqrt-chart-body');
            body.innerHTML = '';
            document.getElementById('sqrt-chart-range-bar').textContent = `Square Root âˆš${from} to âˆš${to}`;

            const block = document.createElement('div');
            block.className = 'tbl-block';
            const title = document.createElement('div');
            title.className = 'tbl-block-title';
            title.textContent = `Square Roots â€” âˆš${from} to âˆš${to}`;
            block.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'tbl-block-rows';

            // Generate perfect squares in the range
            const sqrtFrom = Math.ceil(Math.sqrt(from));
            const sqrtTo = Math.floor(Math.sqrt(to));

            for (let n = sqrtFrom; n <= sqrtTo; n++) {
                const square = n * n;
                if (square >= from && square <= to) {
                    const row = document.createElement('div');
                    row.className = 'tbl-row';
                    row.innerHTML = `<span>âˆš${square}</span><span class="tbl-row-eq">= ${n}</span>`;
                    grid.appendChild(row);
                }
            }

            // If no perfect squares in range, show a message
            if (grid.children.length === 0) {
                const msg = document.createElement('div');
                msg.style.padding = '20px';
                msg.style.textAlign = 'center';
                msg.style.color = '#8b949e';
                msg.textContent = 'No perfect squares in this range';
                grid.appendChild(msg);
            }

            block.appendChild(grid);
            body.appendChild(block);

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('sqrt-chart-section').classList.add('active');
        }

        function closeSqrtChart() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('sqrt-section').classList.add('active');
        }

        // ===== CUBE ROOT SECTION =====
        function getCbrtConfig() {
            const from = Math.max(1, parseInt(document.getElementById('cbrt-from').value) || 8);
            const to   = Math.max(1, parseInt(document.getElementById('cbrt-to').value) || 1000);
            return { from: Math.min(from, to), to: Math.max(from, to) };
        }

        function updateCbrtPreview() {
            const { from } = getCbrtConfig();
            // Only show perfect cubes for preview
            const cbrtVal = Math.cbrt(from);
            const nextPerfect = Math.ceil(cbrtVal) ** 3;
            const nextNext = (Math.ceil(cbrtVal) + 1) ** 3;
            const nextNextNext = (Math.ceil(cbrtVal) + 2) ** 3;
            
            document.getElementById('cbrt-practice-preview').textContent = `âˆ›${from} = ?`;
            document.getElementById('cbrt-chart-preview').innerHTML = 
                `âˆ›${nextPerfect} = ${Math.cbrt(nextPerfect)}<br>âˆ›${nextNext} = ${Math.cbrt(nextNext)}<br>âˆ›${nextNextNext} = ${Math.cbrt(nextNextNext)}`;
        }

        function startCbrtQuiz() {
            const { from, to } = getCbrtConfig();
            quizConfig.from = from;
            quizConfig.to   = to;
            quizConfig.questions = 15;
            currentTopic = 'cbrt';
            initAndRunQuiz('cbrt');
        }

        function openCbrtChart() {
            const { from, to } = getCbrtConfig();
            const body = document.getElementById('cbrt-chart-body');
            body.innerHTML = '';
            document.getElementById('cbrt-chart-range-bar').textContent = `Cube Root âˆ›${from} to âˆ›${to}`;

            const block = document.createElement('div');
            block.className = 'tbl-block';
            const title = document.createElement('div');
            title.className = 'tbl-block-title';
            title.textContent = `Cube Roots â€” âˆ›${from} to âˆ›${to}`;
            block.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'tbl-block-rows';

            // Generate perfect cubes in the range
            const cbrtFrom = Math.ceil(Math.cbrt(from));
            const cbrtTo = Math.floor(Math.cbrt(to));

            for (let n = cbrtFrom; n <= cbrtTo; n++) {
                const cube = n * n * n;
                if (cube >= from && cube <= to) {
                    const row = document.createElement('div');
                    row.className = 'tbl-row';
                    row.innerHTML = `<span>âˆ›${cube}</span><span class="tbl-row-eq">= ${n}</span>`;
                    grid.appendChild(row);
                }
            }

            // If no perfect cubes in range, show a message
            if (grid.children.length === 0) {
                const msg = document.createElement('div');
                msg.style.padding = '20px';
                msg.style.textAlign = 'center';
                msg.style.color = '#8b949e';
                msg.textContent = 'No perfect cubes in this range';
                grid.appendChild(msg);
            }

            block.appendChild(grid);
            body.appendChild(block);

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('cbrt-chart-section').classList.add('active');
        }

        function closeCbrtChart() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('cbrt-section').classList.add('active');
        }

        // ===== PERCENTAGE SECTION =====
        // Full fraction-to-percentage data from notebook
        const FRAC_PCT = [
            // Unit fractions
            { frac:'1/6',   pct:'16.67', exact:'16â…”%',    group:'Unit Fractions' },
            { frac:'1/7',   pct:'14.29', exact:'14Â²â„â‚‡%',  group:'Unit Fractions' },
            { frac:'1/8',   pct:'12.5',  exact:'12.5%',   group:'Unit Fractions' },
            { frac:'1/9',   pct:'11.11', exact:'11Â¹â„â‚‰%',  group:'Unit Fractions' },
            { frac:'1/11',  pct:'9.09',  exact:'9Â¹â„â‚â‚%', group:'Unit Fractions' },
            { frac:'1/12',  pct:'8.33',  exact:'8â…“%',     group:'Unit Fractions' },
            { frac:'1/13',  pct:'7.69',  exact:'7â¹â„â‚â‚ƒ%', group:'Unit Fractions' },
            { frac:'1/14',  pct:'7.14',  exact:'7Â¹â„â‚‡%',  group:'Unit Fractions' },
            { frac:'1/15',  pct:'6.67',  exact:'6â…”%',     group:'Unit Fractions' },
            { frac:'1/16',  pct:'6.25',  exact:'6.25%',   group:'Unit Fractions' },
            { frac:'1/17',  pct:'5.88',  exact:'5Â¹âµâ„â‚â‚‡%',group:'Unit Fractions' },
            { frac:'1/18',  pct:'5.56',  exact:'5âµâ„â‚‰%',  group:'Unit Fractions' },
            { frac:'1/19',  pct:'5.26',  exact:'5âµâ„â‚â‚‰%', group:'Unit Fractions' },
            { frac:'1/21',  pct:'4.76',  exact:'4Â¹â¶â„â‚‚â‚%',group:'Unit Fractions' },
            { frac:'1/22',  pct:'4.55',  exact:'4â¶â„â‚â‚%', group:'Unit Fractions' },
            { frac:'1/23',  pct:'4.35',  exact:'4â¸â„â‚‚â‚ƒ%', group:'Unit Fractions' },
            { frac:'1/24',  pct:'4.17',  exact:'4â…™%',     group:'Unit Fractions' },
            // /40 fractions
            { frac:'1/40',  pct:'2.5',   exact:'2.5%',    group:'Forties (/40)' },
            { frac:'3/40',  pct:'7.5',   exact:'7.5%',    group:'Forties (/40)' },
            { frac:'7/40',  pct:'17.5',  exact:'17.5%',   group:'Forties (/40)' },
            { frac:'9/40',  pct:'22.5',  exact:'22.5%',   group:'Forties (/40)' },
            { frac:'13/40', pct:'32.5',  exact:'32.5%',   group:'Forties (/40)' },
            { frac:'27/40', pct:'67.5',  exact:'67.5%',   group:'Forties (/40)' },
            // Eighths
            { frac:'3/8',   pct:'37.5',  exact:'37Â½%',    group:'Eighths (/8)' },
            { frac:'5/8',   pct:'62.5',  exact:'62.5%',   group:'Eighths (/8)' },
            // Sevenths
            { frac:'4/7',   pct:'57.14', exact:'57Â¹â„â‚‡%', group:'Sevenths (/7)' },
            { frac:'5/7',   pct:'71.43', exact:'71Â³â„â‚‡%', group:'Sevenths (/7)' },
            // Ninths
            { frac:'4/9',   pct:'44.44', exact:'44â´â„â‚‰%', group:'Ninths (/9)' },
            { frac:'7/9',   pct:'77.78', exact:'77â·â„â‚‰%', group:'Ninths (/9)' },
            // Elevenths
            { frac:'5/11',  pct:'45.45', exact:'45âµâ„â‚â‚%',group:'Elevenths (/11)' },
            // Twelfths
            { frac:'5/12',  pct:'41.67', exact:'41â…”%',   group:'Twelfths (/12)' },
            { frac:'7/12',  pct:'58.33', exact:'58â…“%',   group:'Twelfths (/12)' },
            // Thirties
            { frac:'11/30', pct:'36.67', exact:'36â…”%',   group:'Thirties (/30)' },
            { frac:'19/30', pct:'63.33', exact:'63â…“%',   group:'Thirties (/30)' },
            // Others
            { frac:'7/45',  pct:'15.56', exact:'15âµâ„â‚‰%', group:'Others' },
            { frac:'0.7625',pct:'76.25', exact:'61/80',   group:'Others' },
        ];

        const ALL_PCTS  = FRAC_PCT.map(f => f.pct + '%');
        const ALL_FRACS = FRAC_PCT.map(f => f.frac);

        function startPercentageQuiz(mode) {
            quizConfig.pctMode = mode;
            quizConfig.questions = 20;
            currentTopic = 'percentage';
            initAndRunQuiz('percentage');
        }

        function generatePercentageQuestion() {
            let idx, key, attempts = 0;
            do {
                idx = (Math.random() * FRAC_PCT.length) | 0;
                const m = quizConfig.pctMode || 'frac-to-pct';
                const dir = m === 'pct-mixed' ? (Math.random() < 0.5 ? 'f' : 'p') : (m === 'frac-to-pct' ? 'f' : 'p');
                key = 'pct_' + dir + '_' + idx;
                attempts++;
            } while (quizState.askedQuestions.has(key) && attempts < 40);

            const entry = FRAC_PCT[idx];
            const m = quizConfig.pctMode || 'frac-to-pct';
            const isFracQ = m === 'frac-to-pct' || (m === 'pct-mixed' && Math.random() < 0.5);
            quizState.askedQuestions.add(key);

            if (isFracQ) {
                // fraction â†’ % (what is 1/6 as a percentage?)
                const correct = entry.pct + '%';
                const pool = ALL_PCTS.filter(p => p !== correct);
                for (let i = pool.length - 1; i > 0; i--) { const j = (Math.random()*(i+1))|0; [pool[i],pool[j]]=[pool[j],pool[i]]; }
                const opts = [correct, ...pool.slice(0,3)];
                for (let i = opts.length - 1; i > 0; i--) { const j = (Math.random()*(i+1))|0; [opts[i],opts[j]]=[opts[j],opts[i]]; }
                return { question: entry.frac + ' = ?%', answer: correct, options: opts, isText: true };
            } else {
                // % â†’ fraction (which fraction equals 16.67%?)
                const correct = entry.frac;
                const pool = ALL_FRACS.filter(f => f !== correct);
                for (let i = pool.length - 1; i > 0; i--) { const j = (Math.random()*(i+1))|0; [pool[i],pool[j]]=[pool[j],pool[i]]; }
                const opts = [correct, ...pool.slice(0,3)];
                for (let i = opts.length - 1; i > 0; i--) { const j = (Math.random()*(i+1))|0; [opts[i],opts[j]]=[opts[j],opts[i]]; }
                return { question: entry.pct + '% = ?', answer: correct, options: opts, isText: true };
            }
        }

        function openPercentageChart() {
            const body = document.getElementById('pct-chart-body');
            body.innerHTML = '';
            body.style.padding = '16px 0 30px';

            // Group entries
            const groups = {};
            FRAC_PCT.forEach(e => {
                if (!groups[e.group]) groups[e.group] = [];
                groups[e.group].push(e);
            });

            const groupIcons = {
                'Unit Fractions': 'ðŸ”¢ Unit Fractions',
                'Forties (/40)':  '4ï¸âƒ£  Forties  ( /40 )',
                'Eighths (/8)':   '8ï¸âƒ£  Eighths  ( /8 )',
                'Sevenths (/7)':  '7ï¸âƒ£  Sevenths ( /7 )',
                'Ninths (/9)':    '9ï¸âƒ£  Ninths   ( /9 )',
                'Elevenths (/11)':'1ï¸âƒ£1ï¸âƒ£ Elevenths (/11)',
                'Twelfths (/12)': '1ï¸âƒ£2ï¸âƒ£ Twelfths (/12)',
                'Thirties (/30)': '3ï¸âƒ£0ï¸âƒ£ Thirties (/30)',
                'Others':         'â­ Others',
            };

            Object.entries(groups).forEach(([gName, entries]) => {
                const block = document.createElement('div');
                block.className = 'pct-group';

                // Header row with column labels
                const title = document.createElement('div');
                title.className = 'pct-group-title';
                title.textContent = groupIcons[gName] || gName;
                block.appendChild(title);

                // Column header
                const header = document.createElement('div');
                header.style.cssText = 'display:flex;justify-content:space-between;padding:6px 18px;font-size:11px;color:#4a5568;letter-spacing:0.8px;text-transform:uppercase;border-bottom:1px solid #0f3460;';
                header.innerHTML = '<span>FRACTION</span><span>EXACT %</span><span style="text-align:right;min-width:56px;">DECIMAL</span>';
                block.appendChild(header);

                entries.forEach(e => {
                    const row = document.createElement('div');
                    row.className = 'pct-row';
                    row.innerHTML = `
                        <div class="pct-frac">${e.frac}</div>
                        <div class="pct-exact">${e.exact}</div>
                        <div class="pct-decimal">${e.pct}%</div>
                    `;
                    block.appendChild(row);
                });

                body.appendChild(block);
            });

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('percentage-chart-section').classList.add('active');
        }

        function closePercentageChart() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('percentage-section').classList.add('active');
        }

        // ===== PYTHAGOREAN TRIPLETS =====
        const PYTHAG_TRIPLETS = [
            { a:3,  b:4,   c:5,   group:'Classics' },
            { a:5,  b:12,  c:13,  group:'Classics' },
            { a:6,  b:8,   c:10,  group:'Classics' },
            { a:7,  b:24,  c:25,  group:'Set 1' },
            { a:8,  b:15,  c:17,  group:'Set 1' },
            { a:9,  b:12,  c:15,  group:'Set 1' },
            { a:9,  b:40,  c:41,  group:'Set 2' },
            { a:10, b:24,  c:26,  group:'Set 2' },
            { a:11, b:60,  c:61,  group:'Set 1' },
            { a:12, b:16,  c:20,  group:'Set 1' },
            { a:12, b:35,  c:37,  group:'Set 2' },
            { a:13, b:84,  c:85,  group:'Set 2' },
            { a:15, b:20,  c:25,  group:'Set 3' },
            { a:15, b:36,  c:39,  group:'Set 3' },
            { a:15, b:112, c:113, group:'Set 3' },
            { a:16, b:30,  c:34,  group:'Set 1' },
            { a:16, b:63,  c:65,  group:'Set 2' },
            { a:18, b:24,  c:30,  group:'Set 1' },
            { a:20, b:21,  c:29,  group:'Set 2' },
            { a:20, b:48,  c:52,  group:'Set 3' },
            { a:20, b:99,  c:101, group:'Set 3' },
            { a:21, b:28,  c:35,  group:'Set 2' },
            { a:28, b:45,  c:53,  group:'Set 3' },
            { a:33, b:56,  c:65,  group:'Set 3' },
            { a:36, b:77,  c:85,  group:'Set 3' },
            { a:39, b:80,  c:89,  group:'Set 2' },
            { a:48, b:55,  c:73,  group:'Set 3' },
        ];

        function startPythagQuiz(mode) {
            quizConfig.pythagMode = mode;
            quizConfig.questions = 20;
            currentTopic = 'pythagorean';
            initAndRunQuiz('pythagorean');
        }

        function generatePythagQuestion() {
            const mode = quizConfig.pythagMode || 'find-any';
            let idx, key, attempts = 0;
            do {
                idx = (Math.random() * PYTHAG_TRIPLETS.length) | 0;
                key = 'pyth_' + mode + '_' + idx;
                attempts++;
            } while (quizState.askedQuestions.has(key) && attempts < 50);
            quizState.askedQuestions.add(key);

            const t = PYTHAG_TRIPLETS[idx];
            let hide;
            if      (mode === 'find-a') hide = 'a';
            else if (mode === 'find-b') hide = 'b';
            else if (mode === 'find-c') hide = 'c';
            else { const r = Math.random(); hide = r < 0.33 ? 'a' : r < 0.66 ? 'b' : 'c'; }

            let question, answer;
            if (hide === 'a') {
                question = '?Â² + ' + t.b + 'Â² = ' + t.c + 'Â²';
                answer = t.a;
            } else if (hide === 'b') {
                question = t.a + 'Â² + ?Â² = ' + t.c + 'Â²';
                answer = t.b;
            } else {
                question = t.a + 'Â² + ' + t.b + 'Â² = ?Â²';
                answer = t.c;
            }

            // Wrong options from other triplets
            const allVals = PYTHAG_TRIPLETS
                .map(x => hide === 'a' ? x.a : hide === 'b' ? x.b : x.c)
                .filter(v => v !== answer);
            for (let i = allVals.length - 1; i > 0; i--) {
                const j = (Math.random() * (i+1)) | 0;
                [allVals[i], allVals[j]] = [allVals[j], allVals[i]];
            }
            const uniqueWrong = [...new Set(allVals)].slice(0, 3);
            while (uniqueWrong.length < 3) {
                const v = answer + uniqueWrong.length + 1;
                if (!uniqueWrong.includes(v) && v !== answer) uniqueWrong.push(v);
            }
            const opts = [answer, ...uniqueWrong];
            for (let i = opts.length - 1; i > 0; i--) {
                const j = (Math.random() * (i+1)) | 0;
                [opts[i], opts[j]] = [opts[j], opts[i]];
            }
            return { question, answer, options: opts, isPythag: true };
        }

        function openPythagChart() {
            const body = document.getElementById('pythag-chart-body');
            body.innerHTML = '';
            body.style.padding = '16px 0 30px';

            const groups = {};
            PYTHAG_TRIPLETS.forEach(t => {
                if (!groups[t.group]) groups[t.group] = [];
                groups[t.group].push(t);
            });
            const groupLabels = {
                'Classics': 'â­ Classic Triplets',
                'Set 1': 'ðŸ““ Set 1',
                'Set 2': 'ðŸ““ Set 2',
                'Set 3': 'ðŸ““ Set 3'
            };

            Object.entries(groups).forEach(([gName, entries]) => {
                const block = document.createElement('div');
                block.className = 'pythag-group';

                const title = document.createElement('div');
                title.className = 'pythag-group-title';
                title.textContent = groupLabels[gName] || gName;
                block.appendChild(title);

                entries.forEach(t => {
                    const row = document.createElement('div');
                    row.className = 'pythag-triplet-row';
                    row.innerHTML = `
                        <div class="pythag-values">( ${t.a}, ${t.b}, ${t.c} )</div>
                        <div class="pythag-eq">${t.a}Â² + ${t.b}Â² = ${t.c}Â²</div>
                    `;
                    block.appendChild(row);
                });

                body.appendChild(block);
            });

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('pythagorean-chart-section').classList.add('active');
        }

        function closePythagChart() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('pythagorean-section').classList.add('active');
        }

        // ===== TRIGONOMETRY QUIZ =====
        function startTrigQuiz(subtype) {
            quizConfig.questions = 15;
            currentTopic = subtype;
            initAndRunQuiz(subtype);
        }

        // Trig question bank - Common Angles
        const TRIG_COMMON = (() => {
            const angles = [
                { deg: '0Â°',   sin:'0',      cos:'1',       tan:'0',      cot:'Undef', sec:'1',       csc:'Undef' },
                { deg: '30Â°',  sin:'1/2',    cos:'âˆš3/2',    tan:'1/âˆš3',   cot:'âˆš3',    sec:'2/âˆš3',    csc:'2'     },
                { deg: '45Â°',  sin:'1/âˆš2',   cos:'1/âˆš2',    tan:'1',      cot:'1',     sec:'âˆš2',      csc:'âˆš2'    },
                { deg: '60Â°',  sin:'âˆš3/2',   cos:'1/2',     tan:'âˆš3',     cot:'1/âˆš3',  sec:'2',       csc:'2/âˆš3'  },
                { deg: '90Â°',  sin:'1',      cos:'0',       tan:'Undef',  cot:'0',     sec:'Undef',   csc:'1'     },
                { deg: '120Â°', sin:'âˆš3/2',   cos:'-1/2',    tan:'-âˆš3',    cot:'-1/âˆš3', sec:'-2',      csc:'2/âˆš3'  },
                { deg: '135Â°', sin:'1/âˆš2',   cos:'-1/âˆš2',   tan:'-1',     cot:'-1',    sec:'-âˆš2',     csc:'âˆš2'    },
                { deg: '150Â°', sin:'1/2',    cos:'-âˆš3/2',   tan:'-1/âˆš3',  cot:'-âˆš3',   sec:'-2/âˆš3',   csc:'2'     },
                { deg: '180Â°', sin:'0',      cos:'-1',      tan:'0',      cot:'Undef', sec:'-1',      csc:'Undef' },
                { deg: '270Â°', sin:'-1',     cos:'0',       tan:'Undef',  cot:'0',     sec:'Undef',   csc:'-1'    },
                { deg: '360Â°', sin:'0',      cos:'1',       tan:'0',      cot:'Undef', sec:'1',       csc:'Undef' },
            ];
            const fns = ['sin','cos','tan','cot','sec','csc'];
            const allValues = ['0','1','-1','1/2','-1/2','âˆš3/2','-âˆš3/2','1/âˆš2','-1/âˆš2',
                               'âˆš3','-âˆš3','1/âˆš3','-1/âˆš3','âˆš2','-âˆš2','2','-2','2/âˆš3','-2/âˆš3','Undef'];
            const questions = [];
            angles.forEach(a => {
                fns.forEach(fn => {
                    const correct = a[fn];
                    const pool = allValues.filter(v => v !== correct);
                    // Shuffle pool and take 3 wrong options
                    for (let i = pool.length - 1; i > 0; i--) {
                        const j = (Math.random() * (i+1))|0;
                        [pool[i],pool[j]] = [pool[j],pool[i]];
                    }
                    const opts = [correct, ...pool.slice(0,3)];
                    // Shuffle final options
                    for (let i = opts.length - 1; i > 0; i--) {
                        const j = (Math.random() * (i+1))|0;
                        [opts[i],opts[j]] = [opts[j],opts[i]];
                    }
                    questions.push({ question: `${fn} ${a.deg} = ?`, answer: correct, options: opts, isText: true });
                });
            });
            return questions;
        })();

        // Trig question bank - Addition & Subtraction Formulas
        const TRIG_ADDITION = [
            { question:'sin(A+B) = ?', answer:'sinA cosB + cosA sinB',
              options:['sinA cosB + cosA sinB','sinA cosB - cosA sinB','cosA cosB - sinA sinB','cosA cosB + sinA sinB'] },
            { question:'sin(A-B) = ?', answer:'sinA cosB - cosA sinB',
              options:['sinA cosB - cosA sinB','sinA cosB + cosA sinB','cosA cosB + sinA sinB','cosA cosB - sinA sinB'] },
            { question:'cos(A+B) = ?', answer:'cosA cosB - sinA sinB',
              options:['cosA cosB - sinA sinB','cosA cosB + sinA sinB','sinA cosB + cosA sinB','sinA cosB - cosA sinB'] },
            { question:'cos(A-B) = ?', answer:'cosA cosB + sinA sinB',
              options:['cosA cosB + sinA sinB','cosA cosB - sinA sinB','sinA cosB - cosA sinB','sinA cosB + cosA sinB'] },
            { question:'tan(A+B) = ?', answer:'(tanA+tanB)/(1-tanA tanB)',
              options:['(tanA+tanB)/(1-tanA tanB)','(tanA-tanB)/(1+tanA tanB)','(tanA+tanB)/(1+tanA tanB)','(tanA-tanB)/(1-tanA tanB)'] },
            { question:'tan(A-B) = ?', answer:'(tanA-tanB)/(1+tanA tanB)',
              options:['(tanA-tanB)/(1+tanA tanB)','(tanA+tanB)/(1-tanA tanB)','(tanA-tanB)/(1-tanA tanB)','(tanA+tanB)/(1+tanA tanB)'] },
            { question:'cot(A+B) = ?', answer:'(cotA cotB-1)/(cotB+cotA)',
              options:['(cotA cotB-1)/(cotB+cotA)','(cotA cotB+1)/(cotB-cotA)','(cotA cotB+1)/(cotA+cotB)','(cotA cotB-1)/(cotA-cotB)'] },
            { question:'cot(A-B) = ?', answer:'(cotA cotB+1)/(cotB-cotA)',
              options:['(cotA cotB+1)/(cotB-cotA)','(cotA cotB-1)/(cotB+cotA)','(cotA cotB-1)/(cotB-cotA)','(cotA cotB+1)/(cotA+cotB)'] },
            { question:'sin C + sin D = ?', answer:'2 sin((C+D)/2) cos((C-D)/2)',
              options:['2 sin((C+D)/2) cos((C-D)/2)','2 cos((C+D)/2) sin((C-D)/2)','2 sin((C-D)/2) cos((C+D)/2)','2 cos((C+D)/2) cos((C-D)/2)'] },
            { question:'sin C - sin D = ?', answer:'2 cos((C+D)/2) sin((C-D)/2)',
              options:['2 cos((C+D)/2) sin((C-D)/2)','2 sin((C+D)/2) cos((C-D)/2)','2 sin((C+D)/2) sin((C-D)/2)','2 cos((C+D)/2) cos((C-D)/2)'] },
            { question:'cos C + cos D = ?', answer:'2 cos((C+D)/2) cos((C-D)/2)',
              options:['2 cos((C+D)/2) cos((C-D)/2)','2 sin((C+D)/2) sin((C-D)/2)','2 cos((C-D)/2) sin((C+D)/2)','2 sin((C+D)/2) cos((C-D)/2)'] },
            { question:'cos C - cos D = ?', answer:'-2 sin((C+D)/2) sin((C-D)/2)',
              options:['-2 sin((C+D)/2) sin((C-D)/2)','2 sin((C+D)/2) sin((C-D)/2)','2 cos((C+D)/2) sin((C-D)/2)','2 sin((C+D)/2) cos((C-D)/2)'] },
        ];

        // Trig question bank - Double Angle Formulas
        const TRIG_DOUBLE = [
            { question:'sin(2A) = ?', answer:'2 sinA cosA',
              options:['2 sinA cosA','sinÂ²A - cosÂ²A','2 cosÂ²A - 1','1 - 2 sinÂ²A'] },
            { question:'cos(2A) = ? (form 1)', answer:'cosÂ²A - sinÂ²A',
              options:['cosÂ²A - sinÂ²A','2 sinA cosA','2 cosÂ²A - 1','1 - 2 sinÂ²A'] },
            { question:'cos(2A) = ? (form 2)', answer:'1 - 2 sinÂ²A',
              options:['1 - 2 sinÂ²A','2 cosÂ²A - 1','cosÂ²A - sinÂ²A','2 sinA cosA'] },
            { question:'cos(2A) = ? (form 3)', answer:'2 cosÂ²A - 1',
              options:['2 cosÂ²A - 1','1 - 2 sinÂ²A','cosÂ²A - sinÂ²A','2 sinA cosA'] },
            { question:'tan(2A) = ?', answer:'2tanA/(1-tanÂ²A)',
              options:['2tanA/(1-tanÂ²A)','2tanA/(1+tanÂ²A)','tanA/(1-tanÂ²A)','(tanA)/(1+tanÂ²A)'] },
            { question:'sinÂ²A = ? (from double angle)', answer:'(1 - cos2A)/2',
              options:['(1 - cos2A)/2','(1 + cos2A)/2','(cos2A - 1)/2','(1 - sin2A)/2'] },
            { question:'cosÂ²A = ? (from double angle)', answer:'(1 + cos2A)/2',
              options:['(1 + cos2A)/2','(1 - cos2A)/2','(cos2A + 1)/2','(1 + sin2A)/2'] },
            { question:'sin(2A)Â·cos(2A) = ?', answer:'sin(4A)/2',
              options:['sin(4A)/2','cos(4A)/2','sin(2A)/2','2 sin(4A)'] },
            { question:'2 sinÂ²A = ?', answer:'1 - cos(2A)',
              options:['1 - cos(2A)','1 + cos(2A)','cos(2A) - 1','2 - cos(2A)'] },
            { question:'2 cosÂ²A = ?', answer:'1 + cos(2A)',
              options:['1 + cos(2A)','1 - cos(2A)','2 + cos(2A)','cos(2A) - 1'] },
        ];

        // Trig question bank - Multiple Angle Formulas
        const TRIG_MULTIPLE = [
            { question:'sin(3A) = ?', answer:'3sinA - 4sinÂ³A',
              options:['3sinA - 4sinÂ³A','4sinA - 3sinÂ³A','3sinA + 4sinÂ³A','4sinÂ³A - 3sinA'] },
            { question:'cos(3A) = ?', answer:'4cosÂ³A - 3cosA',
              options:['4cosÂ³A - 3cosA','3cosA - 4cosÂ³A','4cosÂ³A + 3cosA','3cosÂ³A - 4cosA'] },
            { question:'tan(3A) = ?', answer:'(3tanA-tanÂ³A)/(1-3tanÂ²A)',
              options:['(3tanA-tanÂ³A)/(1-3tanÂ²A)','(3tanA+tanÂ³A)/(1+3tanÂ²A)','(tanA-3tanÂ³A)/(1-3tanÂ²A)','(3tanA-tanÂ³A)/(1+3tanÂ²A)'] },
            { question:'sin(4A) = ?', answer:'4sinA cosA(1-2sinÂ²A)',
              options:['4sinA cosA(1-2sinÂ²A)','4sinA cosA(2sinÂ²A-1)','2sinA cosA(1-2sinÂ²A)','4sinÂ²A cos A(1-2sinÂ²A)'] },
            { question:'cos(4A) = ?', answer:'8cosâ´A - 8cosÂ²A + 1',
              options:['8cosâ´A - 8cosÂ²A + 1','8cosâ´A + 8cosÂ²A - 1','8sinâ´A - 8sinÂ²A + 1','8cosâ´A - 4cosÂ²A + 1'] },
            { question:'sin(nA) expansion uses?', answer:'Chebyshev polynomials of sin',
              options:['Chebyshev polynomials of sin','Taylor series of sin','Fourier expansion','Binomial theorem'] },
        ];

        // Trig question bank - Half Angle Formulas
        const TRIG_HALF = [
            { question:'sin(A/2) = ?', answer:'Â±âˆš((1-cosA)/2)',
              options:['Â±âˆš((1-cosA)/2)','Â±âˆš((1+cosA)/2)','(1-cosA)/sinA','sinA/(1+cosA)'] },
            { question:'cos(A/2) = ?', answer:'Â±âˆš((1+cosA)/2)',
              options:['Â±âˆš((1+cosA)/2)','Â±âˆš((1-cosA)/2)','(1+cosA)/sinA','sinA/(1-cosA)'] },
            { question:'tan(A/2) = ? (form 1)', answer:'Â±âˆš((1-cosA)/(1+cosA))',
              options:['Â±âˆš((1-cosA)/(1+cosA))','Â±âˆš((1+cosA)/(1-cosA))','sinA/(1+cosA)','(1-cosA)/sinA'] },
            { question:'tan(A/2) = ? (form 2)', answer:'sinA/(1+cosA)',
              options:['sinA/(1+cosA)','sinA/(1-cosA)','(1-cosA)/sinA','(1+cosA)/sinA'] },
            { question:'tan(A/2) = ? (form 3)', answer:'(1-cosA)/sinA',
              options:['(1-cosA)/sinA','(1+cosA)/sinA','sinA/(1+cosA)','sinA/(1-cosA)'] },
            { question:'sinÂ²(A/2) = ?', answer:'(1-cosA)/2',
              options:['(1-cosA)/2','(1+cosA)/2','(cosA-1)/2','(1+sinA)/2'] },
            { question:'cosÂ²(A/2) = ?', answer:'(1+cosA)/2',
              options:['(1+cosA)/2','(1-cosA)/2','(cosA+1)/2','(1-sinA)/2'] },
            { question:'tanÂ²(A/2) = ?', answer:'(1-cosA)/(1+cosA)',
              options:['(1-cosA)/(1+cosA)','(1+cosA)/(1-cosA)','(1-cosA)/(1-cosA)','(1+cosA)/(1+cosA)'] },
            { question:'cot(A/2) = ?', answer:'(1+cosA)/sinA',
              options:['(1+cosA)/sinA','(1-cosA)/sinA','sinA/(1+cosA)','sinA/(1-cosA)'] },
            { question:'1 - cos(A) = ?', answer:'2 sinÂ²(A/2)',
              options:['2 sinÂ²(A/2)','2 cosÂ²(A/2)','sinÂ²(A/2)','2 sin(A/2) cos(A/2)'] },
            { question:'1 + cos(A) = ?', answer:'2 cosÂ²(A/2)',
              options:['2 cosÂ²(A/2)','2 sinÂ²(A/2)','cosÂ²(A/2)','2 cos(A/2) sin(A/2)'] },
        ];

        // Generate trig question based on subtopic
        function generateTrigQuestion(subtopic) {
            let bank;
            if (subtopic === 'trig-common') {
                bank = TRIG_COMMON;
            } else if (subtopic === 'trig-addition') {
                bank = TRIG_ADDITION;
            } else if (subtopic === 'trig-double') {
                bank = TRIG_DOUBLE;
            } else if (subtopic === 'trig-multiple') {
                bank = TRIG_MULTIPLE;
            } else if (subtopic === 'trig-half') {
                bank = TRIG_HALF;
            } else {
                // Mixed: pick from all banks
                const allBanks = [TRIG_COMMON, TRIG_ADDITION, TRIG_DOUBLE, TRIG_MULTIPLE, TRIG_HALF];
                bank = allBanks[(Math.random() * allBanks.length)|0];
            }

            // Pick a random question, avoid repeats if possible
            let idx, questionKey, attempts = 0;
            do {
                idx = (Math.random() * bank.length)|0;
                questionKey = 'trig_' + bank[idx].question;
                attempts++;
            } while (quizState.askedQuestions.has(questionKey) && attempts < 30);
            quizState.askedQuestions.add(questionKey);

            const q = bank[idx];
            // Shuffle options
            const opts = [...q.options];
            for (let i = opts.length - 1; i > 0; i--) {
                const j = (Math.random() * (i+1))|0;
                [opts[i],opts[j]] = [opts[j],opts[i]];
            }
            return { question: q.question, answer: q.answer, options: opts, isText: true };
        }

        // Generate DI Addition Question
        function generateDIAdditionQuestion() {
            const digits = quizConfig.digitsToAdd;
            const numbers = [];
            let sum = 0;
            
            for (let i = 0; i < digits; i++) {
                const num = fastRandom(quizConfig.from, quizConfig.to);
                numbers.push(num);
                sum += num;
            }
            
            const question = numbers.join(' + ') + ' = ?';
            
            // Generate multiple choice options
            const options = [sum];
            while (options.length < 4) {
                const offset = fastRandom(-40, 40);
                const wrongAnswer = sum + offset;
                if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
                    options.push(wrongAnswer);
                }
            }
            
            // Shuffle options
            for (let i = options.length - 1; i > 0; i--) {
                const j = (Math.random() * (i + 1)) | 0;
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            return { question, answer: sum, options };
        }

        // ===== QUESTION PROGRESS INDICATOR =====
        function updateProgressIndicator() {
            const current = quizState.currentQuestion;
            const total   = quizState.totalQuestions;
            if (!total) return;

            const pct = Math.min(100, Math.round((current / total) * 100));
            const label = document.getElementById('progress-label');
            const fill  = document.getElementById('progress-fill');
            const pctEl = document.getElementById('progress-pct');

            if (label) label.textContent = `Q ${current} / ${total}`;
            if (fill)  fill.style.width = pct + '%';
            if (pctEl) pctEl.textContent = pct + '%';

            // Dynamic colour: redâ†’orangeâ†’green
            if (fill) {
                if (pct < 40)       fill.style.background = 'linear-gradient(90deg,#ff4d6d,#ff9500)';
                else if (pct < 75)  fill.style.background = 'linear-gradient(90deg,#ff9500,#00bfff)';
                else                fill.style.background = 'linear-gradient(90deg,#00bfff,#00ff9f)';
            }
        }

        // ===== BODMAS MULTI-STEP MENTAL MATH =====
        function generateBODMASQuestion() {
            // 10 distinct question types covering all BODMAS operators
            const type = fastRandom(1, 10);
            let question, answer, questionKey;

            switch (type) {
                case 1: {
                    // a Ã· b + c = ?   (division first)
                    const b = fastRandom(2, 9), q = fastRandom(2, 12);
                    const a = b * q, c = fastRandom(1, 30);
                    question = `${a} Ã· ${b} + ${c} = ?`;
                    answer = q + c;
                    questionKey = `bd1_${a}/${b}+${c}`;
                    break;
                }
                case 2: {
                    // a + b Ã· c = ?   (division before addition)
                    const c = fastRandom(2, 9), q = fastRandom(2, 12);
                    const b = c * q, a = fastRandom(1, 30);
                    question = `${a} + ${b} Ã· ${c} = ?`;
                    answer = a + q;
                    questionKey = `bd2_${a}+${b}/${c}`;
                    break;
                }
                case 3: {
                    // a Ã· b âˆ’ c = ?
                    const b = fastRandom(2, 9), q = fastRandom(3, 15);
                    const a = b * q, c = fastRandom(1, q - 1);
                    question = `${a} Ã· ${b} âˆ’ ${c} = ?`;
                    answer = q - c;
                    questionKey = `bd3_${a}/${b}-${c}`;
                    break;
                }
                case 4: {
                    // a Ã— b Ã· c + d = ?   (mult & div left to right, then add)
                    const c = fastRandom(2, 9), b = c * fastRandom(1, 5);
                    const a = fastRandom(2, 10), d = fastRandom(1, 20);
                    question = `${a} Ã— ${b} Ã· ${c} + ${d} = ?`;
                    answer = (a * b / c) + d;
                    questionKey = `bd4_${a}x${b}/${c}+${d}`;
                    break;
                }
                case 5: {
                    // (a + b) Ã· c = ?   (brackets first, then divide)
                    const c = fastRandom(2, 9), q = fastRandom(2, 12);
                    const sum = c * q;
                    const a = fastRandom(1, sum - 1), b = sum - a;
                    question = `(${a} + ${b}) Ã· ${c} = ?`;
                    answer = q;
                    questionKey = `bd5_(${a}+${b})/${c}`;
                    break;
                }
                case 6: {
                    // a Ã— b + c = ?
                    const a = fastRandom(2, 25), b = fastRandom(2, 12), c = fastRandom(1, 50);
                    question = `${a} Ã— ${b} + ${c} = ?`;
                    answer = a * b + c;
                    questionKey = `bd6_${a}x${b}+${c}`;
                    break;
                }
                case 7: {
                    // a Ã— b + c âˆ’ d = ?
                    const a = fastRandom(2, 20), b = fastRandom(2, 12),
                          c = fastRandom(5, 40),  d = fastRandom(1, c);
                    question = `${a} Ã— ${b} + ${c} âˆ’ ${d} = ?`;
                    answer = a * b + c - d;
                    questionKey = `bd7_${a}x${b}+${c}-${d}`;
                    break;
                }
                case 8: {
                    // a Ã— b + c Ã— d = ?
                    const a = fastRandom(2, 15), b = fastRandom(2, 9),
                          c = fastRandom(2, 10),  d = fastRandom(2, 9);
                    question = `${a} Ã— ${b} + ${c} Ã— ${d} = ?`;
                    answer = a * b + c * d;
                    questionKey = `bd8_${a}x${b}+${c}x${d}`;
                    break;
                }
                case 9: {
                    // (a + b) Ã— c âˆ’ d = ?
                    const a = fastRandom(2, 15), b = fastRandom(2, 15),
                          c = fastRandom(2, 10),  d = fastRandom(1, 30);
                    question = `(${a} + ${b}) Ã— ${c} âˆ’ ${d} = ?`;
                    answer = (a + b) * c - d;
                    questionKey = `bd9_(${a}+${b})x${c}-${d}`;
                    break;
                }
                case 10: {
                    // a Ã· b + c Ã— d = ?   (expert: two ops, BODMAS order)
                    const b = fastRandom(2, 9), q = fastRandom(2, 10);
                    const a = b * q;
                    const c = fastRandom(2, 10), d = fastRandom(2, 9);
                    question = `${a} Ã· ${b} + ${c} Ã— ${d} = ?`;
                    answer = q + c * d;
                    questionKey = `bd10_${a}/${b}+${c}x${d}`;
                    break;
                }
            }

            // Guard: if answer â‰¤ 0 or undefined, fall back to safe type
            if (!answer || answer <= 0) {
                const a = fastRandom(2, 20), b = fastRandom(2, 12), c = fastRandom(1, 40);
                question = `${a} Ã— ${b} + ${c} = ?`;
                answer = a * b + c;
                questionKey = `bd_safe_${a}x${b}+${c}`;
            }

            quizState.askedQuestions.add(questionKey);

            // Realistic trap answers
            const traps = [
                () => answer + fastRandom(5, 20),
                () => answer - fastRandom(5, 20),
                () => answer + fastRandom(1, 5),
                () => Math.round(answer * 1.1),
                () => Math.round(answer * 0.9),
                () => answer + fastRandom(20, 50),
                () => answer - fastRandom(1, 5),
            ];
            const options = [answer];
            for (const trap of traps) {
                if (options.length >= 4) break;
                const w = trap();
                if (w > 0 && w !== answer && !options.includes(w)) options.push(w);
            }
            while (options.length < 4) {
                const w = answer + fastRandom(-40, 40);
                if (w > 0 && !options.includes(w)) options.push(w);
            }
            for (let i = options.length - 1; i > 0; i--) {
                const j = (Math.random() * (i + 1)) | 0;
                [options[i], options[j]] = [options[j], options[i]];
            }

            return { question, answer, options, isBODMAS: true };
        }

        // Generate question â€” main dispatcher
        function generateQuestion(topic) {
            let result;

            // BODMAS multi-step
            if (topic === 'bodmas') {
                result = generateBODMASQuestion();
                return result;
            }
            
            // Handle trigonometry sub-topics
            if (topic === 'trigonometry' || topic.startsWith('trig-')) {
                result = generateTrigQuestion(topic === 'trigonometry' ? 'trig-mixed' : topic);
                return result;
            }

            // Handle fraction-percentage quiz
            if (topic === 'percentage') {
                result = generatePercentageQuestion();
                return result;
            }

            // Handle Pythagorean quiz
            if (topic === 'pythagorean') {
                result = generatePythagQuestion();
                return result;
            }
            
            if (topic === 'di-addition') {
                result = generateDIAdditionQuestion();
            } else {
                result = generateStandardQuestion(topic);
            }
            
            // Generate multiple choice options for ALL quiz types
            if (!result.options) {
                const correctAnswer = result.answer;
                const options = [correctAnswer];
                
                // Generate 3 wrong answers
                while (options.length < 4) {
                    let wrongAnswer;
                    
                    // Generate plausible wrong answers based on the correct answer
                    if (correctAnswer < 10) {
                        wrongAnswer = fastRandom(1, 20);
                    } else if (correctAnswer < 100) {
                        const offset = fastRandom(-20, 20);
                        wrongAnswer = correctAnswer + offset;
                    } else {
                        const offset = fastRandom(-40, 40);
                        wrongAnswer = correctAnswer + offset;
                    }
                    
                    if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
                        options.push(wrongAnswer);
                    }
                }
                
                // Shuffle options with optimized algorithm
                for (let i = options.length - 1; i > 0; i--) {
                    const j = (Math.random() * (i + 1)) | 0;
                    [options[i], options[j]] = [options[j], options[i]];
                }
                
                result.options = options;
            }
            
            return result;
        }
        
        // Generate standard question (non-DI Addition)
        function generateStandardQuestion(topic) {
            let num1, num2, question, answer;
            const from = quizConfig.from;
            const to = quizConfig.to;
            let questionKey;
            let attempts = 0;
            const maxAttempts = 50;

            // TABLE topic: handle entirely here with its own dedup loop
            if (topic === 'table') {
                const tFrom  = quizConfig.tableFrom  || 2;
                const tTo    = quizConfig.tableTo    || 20;
                const mFrom  = quizConfig.multFrom   || 1;
                const mTo    = quizConfig.multTo     || 10;
                const tType  = quizConfig.tableType  || 1;

                do {
                    num1 = fastRandom(tFrom, tTo);
                    num2 = fastRandom(mFrom, mTo);
                    questionKey = `t${tType}_${num1}x${num2}`;
                    attempts++;
                } while (quizState.askedQuestions.has(questionKey) && attempts < maxAttempts);

                quizState.askedQuestions.add(questionKey);

                const product = num1 * num2;
                let tableOptions = [];

                if (tType === 1) {
                    // A Ã— B = ?   answer = product, wrong = nearby products
                    question = `${num1} Ã— ${num2} = ?`;
                    answer = product;
                    tableOptions = [answer];
                    const usedM = new Set([num2]);
                    let safetyNet = 0;
                    while (tableOptions.length < 4 && safetyNet++ < 100) {
                        const altM = fastRandom(mFrom, mTo);
                        if (!usedM.has(altM)) {
                            const candidate = num1 * altM;
                            if (!tableOptions.includes(candidate)) {
                                tableOptions.push(candidate);
                                usedM.add(altM);
                            }
                        }
                    }
                    // fallback if range too narrow
                    let pad = 1;
                    while (tableOptions.length < 4) {
                        const c = product + pad * num1;
                        if (!tableOptions.includes(c)) tableOptions.push(c);
                        pad++;
                    }

                } else if (tType === 2) {
                    // A Ã— ? = C   answer = num2 (multiplier)
                    question = `${num1} Ã— ? = ${product}`;
                    answer = num2;
                    const mPool = [];
                    for (let m = mFrom; m <= mTo; m++) { if (m !== num2) mPool.push(m); }
                    for (let i = mPool.length - 1; i > 0; i--) {
                        const j = (Math.random() * (i + 1)) | 0;
                        [mPool[i], mPool[j]] = [mPool[j], mPool[i]];
                    }
                    tableOptions = [answer];
                    tableOptions.push(...mPool.slice(0, 3));
                    // fallback padding if range too narrow
                    let pad = 1;
                    while (tableOptions.length < 4) {
                        const c = num2 + pad;
                        if (!tableOptions.includes(c) && c > 0) tableOptions.push(c);
                        pad++;
                    }

                } else {
                    // ? Ã— ? = C   answer = num1 (table base)
                    question = `? Ã— ? = ${product}`;
                    answer = num1;
                    const tPool = [];
                    for (let t = tFrom; t <= tTo; t++) { if (t !== num1) tPool.push(t); }
                    for (let i = tPool.length - 1; i > 0; i--) {
                        const j = (Math.random() * (i + 1)) | 0;
                        [tPool[i], tPool[j]] = [tPool[j], tPool[i]];
                    }
                    tableOptions = [answer];
                    tableOptions.push(...tPool.slice(0, 3));
                    // fallback padding if range too narrow
                    let pad = 1;
                    while (tableOptions.length < 4) {
                        const c = num1 + pad;
                        if (!tableOptions.includes(c) && c > 0) tableOptions.push(c);
                        pad++;
                    }
                }

                // Shuffle final options
                for (let i = tableOptions.length - 1; i > 0; i--) {
                    const j = (Math.random() * (i + 1)) | 0;
                    [tableOptions[i], tableOptions[j]] = [tableOptions[j], tableOptions[i]];
                }

                return { question, answer, options: tableOptions };
            }

            // Keep generating until we get a unique question
            do {
                switch(topic) {
                    case 'multiplication':
                        num1 = fastRandom(from, to);
                        num2 = fastRandom(from, to);
                        question = `${num1} Ã— ${num2}`;
                        answer = num1 * num2;
                        questionKey = `${num1}*${num2}`;
                        break;

                    case 'square':
                        num1 = fastRandom(from, to);
                        question = `${num1}Â²`;
                        answer = num1 * num1;
                        questionKey = `${num1}^2`;
                        break;

                    case 'cube':
                        num1 = fastRandom(from, to);
                        question = `${num1}Â³`;
                        answer = num1 * num1 * num1;
                        questionKey = `${num1}^3`;
                        break;

                    case 'sqrt':
                        const sqrtMax = Math.floor(Math.sqrt(to));
                        const sqrtMin = Math.ceil(Math.sqrt(from));
                        answer = fastRandom(sqrtMin, sqrtMax);
                        num1 = answer * answer;
                        question = `âˆš${num1}`;
                        questionKey = `sqrt${num1}`;
                        break;

                    case 'cbrt':
                        const cbrtMax = Math.floor(Math.cbrt(to));
                        const cbrtMin = Math.ceil(Math.cbrt(from));
                        answer = fastRandom(cbrtMin, cbrtMax);
                        num1 = answer * answer * answer;
                        question = `âˆ›${num1}`;
                        questionKey = `cbrt${num1}`;
                        break;

                    case 'addition':
                    case 'daily':
                    case 'workout': {
                        const digits = quizConfig.addDigits || 2;
                        const dMin = Math.pow(10, digits - 1);
                        const dMax = Math.pow(10, digits) - 1;
                        num1 = fastRandom(dMin, dMax);
                        num2 = fastRandom(dMin, dMax);
                        question = `${num1} + ${num2}`;
                        answer = num1 + num2;
                        questionKey = `${num1}+${num2}`;
                        break;
                    }

                    case 'add-sub-mixed': {
                        const digits = quizConfig.addDigits || 2;
                        const dMin = Math.pow(10, digits - 1);
                        const dMax = Math.pow(10, digits) - 1;
                        num1 = fastRandom(dMin, dMax);
                        num2 = fastRandom(dMin, dMax);
                        if (Math.random() < 0.5) {
                            question = `${num1} + ${num2}`;
                            answer = num1 + num2;
                            questionKey = `mix+${num1}+${num2}`;
                        } else {
                            const big = Math.max(num1, num2);
                            const small = Math.min(num1, num2);
                            question = `${big} âˆ’ ${small}`;
                            answer = big - small;
                            questionKey = `mix-${big}-${small}`;
                        }
                        break;
                    }

                    case 'subtraction': {
                        const digits = quizConfig.addDigits || 2;
                        const dMin = Math.pow(10, digits - 1);
                        const dMax = Math.pow(10, digits) - 1;
                        num1 = fastRandom(dMin, dMax);
                        num2 = fastRandom(dMin, num1); // ensure non-negative
                        question = `${num1} âˆ’ ${num2}`;
                        answer = num1 - num2;
                        questionKey = `${num1}-${num2}`;
                        break;
                    }

                    case 'division':
                        num2 = fastRandom(from, to);
                        answer = fastRandom(1, 20);
                        num1 = num2 * answer;
                        question = `${num1} Ã· ${num2}`;
                        questionKey = `${num1}/${num2}`;
                        break;

                    case 'fraction':
                        num1 = fastRandom(1, 10);
                        num2 = fastRandom(1, 10);
                        const den = fastRandom(2, 10);
                        question = `${num1}/${den} + ${num2}/${den}`;
                        answer = parseFloat(((num1 + num2) / den).toFixed(2));
                        questionKey = `${num1}/${den}+${num2}/${den}`;
                        break;

                    case 'percentage':
                        num1 = fastRandom(from, to);
                        num2 = fastRandom(50, 150);
                        question = `${num1}% of ${num2}`;
                        answer = Math.round(num1 * num2 / 100);
                        questionKey = `${num1}%${num2}`;
                        break;

                    default:
                        num1 = fastRandom(from, to);
                        num2 = fastRandom(from, to);
                        question = `${num1} + ${num2}`;
                        answer = num1 + num2;
                        questionKey = `${num1}+${num2}`;
                }
                
                attempts++;
            } while (quizState.askedQuestions.has(questionKey) && attempts < maxAttempts);

            // Add to asked questions
            quizState.askedQuestions.add(questionKey);

            return { question, answer };
        }

        // Memory-Based Practice Mode - Review wrong answers
        function startMemoryPractice() {
            if (quizState.wrongQuestions.length === 0) {
                alert('No wrong answers to review! Great job! ðŸŽ‰');
                return;
            }
            
            // Create a special quiz from wrong questions
            const wrongQuestionsCopy = [...quizState.wrongQuestions];
            
            // Start a new quiz session
            closeConfigModal();
            
            quizState = {
                topic: 'memory-practice',
                currentQuestion: 0,
                totalQuestions: wrongQuestionsCopy.length,
                correctAnswers: 0,
                wrongAnswers: 0,
                skippedAnswers: 0,
                currentAnswer: 0,
                questionStartTime: Date.now(),
                totalTime: 0,
                timerInterval: null,
                quizStartTime: Date.now(),
                currentUserAnswer: '',
                multipleChoiceOptions: [],
                askedQuestions: new Set(),
                sessionHistory: [],
                wrongQuestions: [],
                memoryQuestions: wrongQuestionsCopy,
                memoryIndex: 0
            };
            
            // Hide main content, show quiz
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('quiz-section').classList.add('active');
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.progress-line').style.display = 'none';
            document.querySelector('.bottom-nav').style.display = 'none';
            
            document.getElementById('quiz-topic-title').textContent = 'Memory Practice';
            
            // Reset scores
            document.getElementById('correct-count').textContent = '0';
            document.getElementById('wrong-count').textContent = '0';
            document.getElementById('quiz-timer').textContent = '00:00:00';
            
            // Setup UI
            document.getElementById('answer-input').style.display = 'none';
            document.getElementById('answer-display').style.display = 'none';
            document.getElementById('answer-options').style.display = 'grid';
            document.getElementById('number-pad').style.display = 'none';
            document.getElementById('input-mode-selector').style.display = 'flex';
            document.getElementById('submit-btn-top').style.display = 'block';
            
            document.getElementById('numpad-mode-btn').classList.remove('active');
            document.getElementById('options-mode-btn').classList.add('active');
            
            loadMemoryQuestion();
            startQuizTimer();
        }
        
        // Load memory practice question
        function loadMemoryQuestion() {
            // Check if quiz is complete BEFORE incrementing
            if (quizState.memoryIndex >= quizState.memoryQuestions.length) {
                endQuiz();
                return;
            }
            
            // Increment counters
            quizState.currentQuestion++;
            quizState.memoryIndex++;
            
            const memQ = quizState.memoryQuestions[quizState.memoryIndex - 1]; // Use previous index since we just incremented
            document.getElementById('question').textContent = memQ.question;
            quizState.currentAnswer = memQ.answer;
            quizState.currentUserAnswer = '';
            
            updateAnswerDisplay();
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback';
            feedback.style.display = 'none';
            
            // Generate options for memory question
            const correctAnswer = memQ.answer;
            const options = [correctAnswer];
            
            while (options.length < 4) {
                let wrongAnswer;
                if (correctAnswer < 10) {
                    wrongAnswer = fastRandom(1, 20);
                } else if (correctAnswer < 100) {
                    wrongAnswer = correctAnswer + fastRandom(-20, 20);
                } else {
                    wrongAnswer = correctAnswer + fastRandom(-40, 40);
                }
                
                if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
                    options.push(wrongAnswer);
                }
            }
            
            // Shuffle
            for (let i = options.length - 1; i > 0; i--) {
                const j = (Math.random() * (i + 1)) | 0;
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            quizState.multipleChoiceOptions = options;
            
            const optionsContainer = document.getElementById('answer-options');
            optionsContainer.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.disabled = false;
                btn.onclick = () => selectOption(opt, btn);
                optionsContainer.appendChild(btn);
            });
            
            if (showingMultipleChoice) {
                optionsContainer.style.display = 'grid';
                document.getElementById('number-pad').style.display = 'none';
                document.getElementById('answer-display').style.display = 'none';
            } else {
                optionsContainer.style.display = 'none';
                document.getElementById('number-pad').style.display = 'grid';
                document.getElementById('answer-display').style.display = 'flex';
            }
            
            quizState.questionStartTime = Date.now();
            updateProgressIndicator();
        }
       // Load Question - FIXED VERSION
function loadQuestion() {
    console.log('loadQuestion called - FIXED VERSION');
    console.log('Current state:', {
        currentQuestion: quizState.currentQuestion,
        totalQuestions: quizState.totalQuestions,
        correctAnswers: quizState.correctAnswers,
        wrongAnswers: quizState.wrongAnswers
    });
    
    // Handle memory practice mode
    if (quizState.topic === 'memory-practice') {
        loadMemoryQuestion();
        return;
    }
    
    // SAFETY CHECK: If totalQuestions is invalid, don't proceed
    if (!quizState.totalQuestions || quizState.totalQuestions <= 0) {
        console.error('Invalid totalQuestions:', quizState.totalQuestions);
        alert('âš ï¸ Quiz Error\n\nInvalid quiz configuration. Please restart the quiz.');
        return;
    }
    
    // Check if quiz is complete
    if (quizState.currentQuestion >= quizState.totalQuestions) {
        console.log('Quiz complete! Showing results...');
        endQuiz();
        return;
    }
    
    // Increment counter for this question
    quizState.currentQuestion++;
    console.log(`Loading question ${quizState.currentQuestion} of ${quizState.totalQuestions}`);

    const qa = generateQuestion(quizState.topic);

    // Update question display
    const qEl = document.getElementById('question');
    if (qa.isPythag) {
        const htmlQ = qa.question
            .replace('?Â²', '<span style="color:#ff4d6d;font-size:1.15em;font-weight:900;">?</span><sup style="color:#ff4d6d;font-size:0.55em;">2</sup>')
            .replace(/(\d+)Â²/g, '$1<sup style="font-size:0.55em;color:#aad4ff;">2</sup>');
        qEl.innerHTML = htmlQ;
        qEl.className = 'question-display';
    } else {
        qEl.textContent = qa.question;
    }

    quizState.currentAnswer = qa.answer;
    quizState.currentUserAnswer = '';
    
    // Clear and update answer display
    updateAnswerDisplay();
    
    const feedback = document.getElementById('feedback');
    if (feedback) {
        feedback.className = 'feedback';
        feedback.style.display = 'none';
    }
    
    // Handle options
    if (qa.options) {
        quizState.multipleChoiceOptions = qa.options;
        
        const isTrigText = qa.isText === true;
        const optionsContainer = document.getElementById('answer-options');
        if (optionsContainer) {
            optionsContainer.innerHTML = '';

            // Adjust grid for formula options
            if (isTrigText) {
                const maxLen = Math.max(...qa.options.map(o => o.length));
                if (maxLen > 12) {
                    optionsContainer.style.gridTemplateColumns = '1fr 1fr';
                } else {
                    optionsContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
                }
                if (qEl) qEl.className = 'question-display trig-q';
            } else if (qa.isBODMAS) {
                optionsContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
                if (qEl) qEl.className = 'question-display bodmas-q';
            } else {
                optionsContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
                if (qEl) qEl.className = 'question-display';
            }
            
            qa.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = isTrigText ? 'option-btn formula-option' : 'option-btn';
                btn.textContent = opt;
                btn.disabled = false;
                btn.onclick = () => selectOption(opt, btn);
                optionsContainer.appendChild(btn);
            });
            
            // Set visibility based on current mode
            if (showingMultipleChoice) {
                optionsContainer.style.display = 'grid';
                const numPad = document.getElementById('number-pad');
                const answerDisplay = document.getElementById('answer-display');
                if (numPad) numPad.style.display = 'none';
                if (answerDisplay) answerDisplay.style.display = 'none';
            } else {
                optionsContainer.style.display = 'none';
                const numPad = document.getElementById('number-pad');
                const answerDisplay = document.getElementById('answer-display');
                if (numPad) numPad.style.display = 'grid';
                if (answerDisplay) answerDisplay.style.display = 'flex';
            }
        }
    }
    
    // Set question start time for timing
    quizState.questionStartTime = Date.now();
    updateProgressIndicator();
}
        function updateAnswerDisplay() {
            const display = document.getElementById('answer-display');
            if (!display) return; // Safety check
            
            display.innerHTML = '';
            
            if (quizState.currentUserAnswer && quizState.currentUserAnswer.length > 0) {
                // Show each digit
                quizState.currentUserAnswer.split('').forEach(digit => {
                    const span = document.createElement('span');
                    span.textContent = digit;
                    span.style.color = '#00bfff';
                    display.appendChild(span);
                });
            } else {
                // Show placeholder when empty
                const span = document.createElement('span');
                span.textContent = '?';
                span.style.color = '#8b949e';
                display.appendChild(span);
            }
        }

        function switchToNumpad() {
            const optionsDiv = document.getElementById('answer-options');
            const numPadDiv = document.getElementById('number-pad');
            const numpadBtn = document.getElementById('numpad-mode-btn');
            const optionsBtn = document.getElementById('options-mode-btn');
            const submitBtn = document.getElementById('submit-btn-top');
            const answerDisplay = document.getElementById('answer-display');
            
            // Update mode flag
            showingMultipleChoice = false;
            
            // Update button states
            numpadBtn.classList.add('active');
            optionsBtn.classList.remove('active');
            
            // Hide options, show numpad
            optionsDiv.style.display = 'none';
            numPadDiv.style.display = 'grid';
            
            // Show answer display where numbers will appear
            answerDisplay.style.display = 'flex';
            
            // Clear and reset answer
            quizState.currentUserAnswer = '';
            updateAnswerDisplay();
            
            // Ensure submit button is visible
            submitBtn.style.display = 'block';
            
            // Clear any feedback from previous answer
            const feedback = document.getElementById('feedback');
            feedback.style.display = 'none';
        }

        function switchToOptions() {
            const optionsDiv = document.getElementById('answer-options');
            const numPadDiv = document.getElementById('number-pad');
            const numpadBtn = document.getElementById('numpad-mode-btn');
            const optionsBtn = document.getElementById('options-mode-btn');
            const submitBtn = document.getElementById('submit-btn-top');
            const answerDisplay = document.getElementById('answer-display');
            
            showingMultipleChoice = true;
            
            // Update button states
            numpadBtn.classList.remove('active');
            optionsBtn.classList.add('active');
            
            // Show multiple choice, hide number pad
            optionsDiv.style.display = 'grid';
            numPadDiv.style.display = 'none';
            answerDisplay.style.display = 'none';
            
            // Clear answer
            quizState.currentUserAnswer = '';
            
            // Keep submit button visible
            submitBtn.style.display = 'block';
            
            // Recreate options with fresh state
            const optionsContainer = document.getElementById('answer-options');
            optionsContainer.innerHTML = '';
            
            const isTrigText = typeof quizState.currentAnswer === 'string';
            
            quizState.multipleChoiceOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = isTrigText ? 'option-btn formula-option' : 'option-btn';
                btn.textContent = opt;
                btn.disabled = false; // Make sure buttons are enabled
                btn.onclick = () => selectOption(opt, btn);
                optionsContainer.appendChild(btn);
            });
        }

        // Select Multiple Choice Option
       // Select Multiple Choice Option - FIXED VERSION
function selectOption(value, btn) {
    console.log('Option selected:', value);
    
    // SAFETY CHECK: Ensure quiz is properly initialized
    if (!quizState || !quizState.totalQuestions || quizState.totalQuestions <= 0) {
        console.error('selectOption called with invalid quiz state:', quizState);
        return;
    }
    
    // Prevent double-clicking
    const allButtons = document.querySelectorAll('.option-btn');
    if (btn.disabled || Array.from(allButtons).some(b => b.disabled)) {
        return;
    }
    
    // Remove previous selection
    allButtons.forEach(b => {
        b.classList.remove('selected', 'submitting');
    });
    
    btn.classList.add('selected', 'submitting');
    quizState.currentUserAnswer = value.toString();
    updateAnswerDisplay();
    
    // Disable all buttons to prevent double-clicking
    allButtons.forEach(b => b.disabled = true);
    
    console.log('Option selected:', value, 'Auto-submitting...');
    
    // Auto-submit after a short delay
    setTimeout(() => {
        submitAnswer();
    }, 500);
}

        // Quiz Timer
        function startQuizTimer() {
            quizState.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - quizState.quizStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('quiz-timer').textContent = timeStr;
            }, 1000);
        }

        function stopQuizTimer() {
            clearInterval(quizState.timerInterval);
        }

        // Submit Answer
        // Submit Answer - COMPLETE FIX
function submitAnswer() {
    console.log('submitAnswer called - FIXED VERSION');
    
    // Check if we have a user answer
    if (!quizState || quizState.currentUserAnswer === undefined || quizState.currentUserAnswer === '') {
        console.warn('No answer entered, ignoring submit');
        // Show feedback to user
        const feedback = document.getElementById('feedback');
        if (feedback) {
            feedback.className = 'feedback incorrect';
            feedback.innerHTML = 'âš ï¸ Please enter an answer first!';
            feedback.style.display = 'block';
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 1500);
        }
        return;
    }
    
    console.log(`Submitting answer: "${quizState.currentUserAnswer}" for question ${quizState.currentQuestion}`);
    
    // Parse user answer
    let userAnswer;
    const isTrigTextQuestion = typeof quizState.currentAnswer === 'string';
    
    if (isTrigTextQuestion) {
        userAnswer = quizState.currentUserAnswer;
    } else {
        userAnswer = parseFloat(quizState.currentUserAnswer);
        if (isNaN(userAnswer)) {
            console.warn('Invalid number answer');
            return;
        }
    }
    
    // Calculate question time
    const questionTime = (Date.now() - quizState.questionStartTime) / 1000;
    quizState.totalTime += questionTime;

    const feedback = document.getElementById('feedback');
    const isCorrect = isTrigTextQuestion
        ? (userAnswer === quizState.currentAnswer)
        : (Math.abs(userAnswer - quizState.currentAnswer) < 0.01);
    
    // Get speed rating
    const speedRating = getSpeedRating(questionTime);
    
    // Get question text safely
    const questionEl = document.getElementById('question');
    const questionText = questionEl ? (questionEl.textContent || questionEl.innerText) : 'Unknown question';
    
    // Store session history
    const questionData = {
        question: questionText,
        userAnswer: userAnswer,
        correctAnswer: quizState.currentAnswer,
        isCorrect: isCorrect,
        time: questionTime,
        speedRating: speedRating.text,
        timestamp: new Date().toISOString()
    };
    
    if (!quizState.sessionHistory) quizState.sessionHistory = [];
    quizState.sessionHistory.push(questionData);
    
    if (isCorrect) {
        quizState.correctAnswers = (quizState.correctAnswers || 0) + 1;
        if (feedback) {
            feedback.className = 'feedback correct';
            feedback.innerHTML = `âœ“ Correct! <span style="color: ${speedRating.color}; margin-left: 10px;">${speedRating.text}</span> <span style="font-size: 14px; opacity: 0.8;">(${questionTime.toFixed(2)}s)</span>`;
            feedback.style.display = 'block';
        }
        
        const correctCount = document.getElementById('correct-count');
        if (correctCount) correctCount.textContent = quizState.correctAnswers;
        
        // Highlight correct option if in multiple choice mode
        if (showingMultipleChoice) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                if (isTrigTextQuestion) {
                    if (btn.textContent === quizState.currentAnswer) {
                        btn.classList.add('correct');
                    }
                } else {
                    if (parseInt(btn.textContent) === quizState.currentAnswer) {
                        btn.classList.add('correct');
                    }
                }
            });
        }
    } else {
        quizState.wrongAnswers = (quizState.wrongAnswers || 0) + 1;
        
        // Store wrong question for memory practice
        if (!quizState.wrongQuestions) quizState.wrongQuestions = [];
        quizState.wrongQuestions.push({
            question: questionText,
            answer: quizState.currentAnswer,
            userAnswer: userAnswer,
            topic: quizState.topic
        });
        
        if (feedback) {
            feedback.className = 'feedback incorrect';
            feedback.innerHTML = `âœ— Wrong! Answer: ${quizState.currentAnswer} <span style="font-size: 14px; opacity: 0.8;">(${questionTime.toFixed(2)}s)</span>`;
            feedback.style.display = 'block';
        }
        
        const wrongCount = document.getElementById('wrong-count');
        if (wrongCount) wrongCount.textContent = quizState.wrongAnswers;
        
        // Highlight wrong and correct options if in multiple choice mode
        if (showingMultipleChoice) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                if (isTrigTextQuestion) {
                    if (btn.textContent === quizState.currentUserAnswer) {
                        btn.classList.add('incorrect');
                    }
                    if (btn.textContent === quizState.currentAnswer) {
                        btn.classList.add('correct');
                    }
                } else {
                    const val = parseInt(btn.textContent);
                    if (val === parseInt(quizState.currentUserAnswer)) {
                        btn.classList.add('incorrect');
                    }
                    if (val === quizState.currentAnswer) {
                        btn.classList.add('correct');
                    }
                }
            });
        }
    }

    // Clear current user answer
    quizState.currentUserAnswer = '';
    
    // Update answer display
    updateAnswerDisplay();

    // Load next question after brief delay
    setTimeout(() => {
        console.log('Loading next question...');
        console.log('Current progress:', {
            current: quizState.currentQuestion,
            total: quizState.totalQuestions,
            correct: quizState.correctAnswers,
            wrong: quizState.wrongAnswers
        });
        
        // Check if quiz is complete
        if (quizState.currentQuestion >= quizState.totalQuestions) {
            console.log('Quiz complete!');
            endQuiz();
        } else {
            loadQuestion();
        }
    }, 800);
}
        // Exit Quiz
        function exitQuiz() {
            stopQuizTimer();
            
            if (confirm('Are you sure you want to exit the quiz?')) {
                document.getElementById('quiz-section').classList.remove('active');
                showMainContent();
                document.getElementById('practice-section').classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            } else {
                startQuizTimer();
            }
        }

        // End Quiz
       // End Quiz - FIXED VERSION
// End Quiz - ULTRA DEFENSIVE VERSION (COPY THIS ENTIRE FUNCTION)
// End Quiz - ULTIMATE FIX (COPY THIS ENTIRE FUNCTION)
// End Quiz â€“ ULTIMATE FIX with bulletproof achievement update
function endQuiz() {
    try {
        stopQuizTimer();
        
        // --- Capture values directly from quizState ---
        const finalCorrect = quizState.correctAnswers || 0;
        const finalWrong = quizState.wrongAnswers || 0;
        const finalSkipped = quizState.skippedAnswers || 0;
        const finalTotal = finalCorrect + finalWrong + finalSkipped;
       const finalXP = finalCorrect * 10;              // âœ… new: only correct answers

        console.log('endQuiz â€“ final values:', { finalCorrect, finalWrong, finalSkipped, finalTotal, finalXP });

        // --- Immediately update XP display (ensures it's never missed) ---
        const xpElement = document.getElementById('final-xp');
        if (xpElement) xpElement.textContent = finalXP.toLocaleString();

        // --- Recalculate from history if counters are zero but history exists ---
        let actualCorrect = finalCorrect;
        let actualWrong = finalWrong;
        let actualSkipped = finalSkipped;

        if (actualCorrect === 0 && actualWrong === 0 && quizState.sessionHistory && quizState.sessionHistory.length > 0) {
            actualCorrect = quizState.sessionHistory.filter(h => h.isCorrect).length;
            actualWrong = quizState.sessionHistory.filter(h => !h.isCorrect).length;
            // update quizState to match
            quizState.correctAnswers = actualCorrect;
            quizState.wrongAnswers = actualWrong;
        }

        const actualTotal = actualCorrect + actualWrong + actualSkipped;
        const actualXP = actualCorrect * 10;             // âœ… new

        // --- Update achievement data DIRECTLY (bypassing the faulty function) ---
        if (actualTotal > 0) {
            try {
                let data = JSON.parse(localStorage.getItem('achievementData') || '{}');
                const key = getCurrentMonthKey();

                if (!data[key]) {
                    data[key] = {
                        attempted: 0,
                        correct: 0,
                        accuracy: 0,
                        level: 'Bronze',
                        levelIndex: 0
                    };
                }

                // Increment totals
                data[key].attempted += actualCorrect;           // âœ… new: only correct answers
                data[key].correct += actualCorrect;
                data[key].accuracy = data[key].attempted > 0
                    ? (data[key].correct / data[key].attempted * 100).toFixed(1)
                    : '0.0';

                // Recalculate level
                const levelInfo = calculateAchievementLevel(data[key].attempted);
                data[key].level = levelInfo.name;
                data[key].levelIndex = levelInfo.index;

                localStorage.setItem('achievementData', JSON.stringify(data));
                console.log('âœ… Achievement data updated manually:', data[key]);

                // Show level-up notification if level changed
                const oldLevel = data[key].level; // we don't have old level here, but we can check later
                // Optional: trigger loadAchievement to reflect changes
                setTimeout(() => loadAchievement(), 100);
            } catch (achErr) {
                console.error('âŒ Failed to update achievement data:', achErr);
            }
        }

        // --- Update global stats ---
        if (actualTotal > 0) {
            stats.totalQuestions += actualTotal;
            stats.correctAnswers += actualCorrect;
            stats.wrongAnswers += actualWrong;
            stats.skippedAnswers += actualSkipped;
            stats.totalTime += quizState.totalTime || 0;
            saveStats();
            updateStatsDisplay();
        }

        // --- Hide quiz, show results ---
        document.getElementById('quiz-section').classList.remove('active');
        document.getElementById('results-section').classList.add('active');
        document.querySelector('.main-content').style.display = 'block';
        document.querySelector('.header').style.display = 'flex';
        document.querySelector('.progress-line').style.display = 'block';
        document.querySelector('.bottom-nav').style.display = 'grid';

        // --- Calculate and display results ---
        const total = actualTotal > 0 ? actualTotal : 1;
        const accuracy = actualTotal > 0 ? ((actualCorrect / actualTotal) * 100).toFixed(1) : '0.0';
        const totalDuration = (quizState.totalTime || 0).toFixed(1);
        const score = actualTotal > 0 ? (actualCorrect * (20 / actualTotal)).toFixed(2) : '0.00';

        const pad = n => String(n).padStart(2, '0');

        const setText = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        };

        setText('final-correct', pad(actualCorrect));
        setText('final-wrong', pad(actualWrong));
        setText('final-skipped', pad(actualSkipped));
        setText('final-accuracy', accuracy + '%');
        setText('final-score', score);
        setText('final-time', totalDuration);
        setText('final-xp', actualXP.toLocaleString()); // XP set again for safety

        // --- Update progress bars ---
        const correctPct = actualTotal > 0 ? (actualCorrect / actualTotal) * 100 : 0;
        const correctBar = document.getElementById('result-bar-correct');
        const wrongBar = document.getElementById('result-bar-wrong');
        if (correctBar) correctBar.style.width = correctPct + '%';
        if (wrongBar) wrongBar.style.width = (100 - correctPct) + '%';

        // --- Display session history ---
        try { displaySessionHistory(); } catch (e) { console.error('History error:', e); }

        // --- Show/hide review wrong answers button ---
        const reviewBtn = document.getElementById('review-wrong-btn');
        if (reviewBtn) {
            if (quizState.wrongQuestions && quizState.wrongQuestions.length > 0) {
                reviewBtn.style.display = 'block';
                reviewBtn.textContent = `ðŸ“š Review ${quizState.wrongQuestions.length} Wrong Answer${quizState.wrongQuestions.length > 1 ? 's' : ''}`;
            } else {
                reviewBtn.style.display = 'none';
            }
        }

        // --- Save session to localStorage ---
        try { saveSessionToHistory(); } catch (e) { console.error('Save error:', e); }

        console.log('âœ… Quiz ended successfully â€“ XP awarded:', actualXP);

    } catch (error) {
        console.error('âŒ Fatal error in endQuiz:', error);

        // --- CATCH BLOCK â€“ try to recover values from history ---
        let correct = 0, wrong = 0;
        if (quizState && quizState.sessionHistory) {
            correct = quizState.sessionHistory.filter(h => h.isCorrect).length;
            wrong = quizState.sessionHistory.filter(h => !h.isCorrect).length;
        }
        const total = correct + wrong;
        const xp = total * 10;

        // Force show results with recovered values
        document.getElementById('quiz-section').classList.remove('active');
        document.getElementById('results-section').classList.add('active');
        document.querySelector('.main-content').style.display = 'block';
        document.querySelector('.header').style.display = 'flex';
        document.querySelector('.progress-line').style.display = 'block';
        document.querySelector('.bottom-nav').style.display = 'grid';

        const setText = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        };

        setText('final-correct', String(correct).padStart(2, '0'));
        setText('final-wrong', String(wrong).padStart(2, '0'));
        setText('final-skipped', '00');
        setText('final-accuracy', (total > 0 ? ((correct / total) * 100).toFixed(1) : '0') + '%');
        setText('final-score', (total > 0 ? (correct * (20 / total)).toFixed(2) : '0.00'));
        setText('final-time', (quizState && quizState.totalTime ? quizState.totalTime.toFixed(1) : '0.0'));
        setText('final-xp', xp.toLocaleString());

        alert('Quiz completed! Your progress has been saved.');
    }
}
        
        // Save session to history
        function saveSessionToHistory() {
            // Calculate actual questions answered
            const actualAnswered = quizState.correctAnswers + quizState.wrongAnswers + (quizState.skippedAnswers || 0);
            
            // Don't save sessions with 0 questions answered
            if (actualAnswered <= 0) {
                console.warn('Session not saved - no questions were answered');
                return;
            }
            
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            const session = {
                topic: quizState.topic,
                questions: actualAnswered, // Use actual answered count
                correct: quizState.correctAnswers,
                wrong: quizState.wrongAnswers,
                skipped: quizState.skippedAnswers || 0,
                accuracy: ((quizState.correctAnswers / actualAnswered) * 100).toFixed(1),
                time: quizState.totalTime.toFixed(1),
                avgTime: (quizState.totalTime / actualAnswered).toFixed(2),
                date: new Date().toISOString(),
                history: quizState.sessionHistory || []
            };
            sessions.push(session);
            localStorage.setItem('speedMathSessions', JSON.stringify(sessions));
        }

        // Display Session History
        function displaySessionHistory() {
            const historyList = document.getElementById('history-list'); if (!historyList) return; historyList.innerHTML = '';
            
            if (!quizState.sessionHistory || quizState.sessionHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #8b949e;">No history available</p>';
                return;
            }
            
            quizState.sessionHistory.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = `result-question-row ${item.isCorrect ? '' : 'wrong-row'}`;

                const iconClass = item.isCorrect ? 'correct-icon' : 'wrong-icon';
                const iconSymbol = item.isCorrect ? 'âœ“' : 'âœ—';

                let answerHtml = '';
                if (item.isCorrect) {
                    answerHtml = `= <span class="result-q-answer-correct">${item.correctAnswer}</span>`;
                } else {
                    answerHtml = `= <span class="result-q-answer-wrong">${item.userAnswer}</span>`
                              + `<span style="color:#666;"> (</span><span class="result-q-answer-correct">${item.correctAnswer}</span><span style="color:#666;">)</span>`;
                }

                row.innerHTML = `
                    <div class="result-q-icon ${iconClass}">${iconSymbol}</div>
                    <div class="result-q-content">
                        ${item.question} ${answerHtml}
                    </div>
                    <div class="result-q-time">${item.time.toFixed(1)} sec</div>
                `;
                
                historyList.appendChild(row);
            });
        }

        // Load and display recent sessions from localStorage
        function loadRecentSessions() {
            const sessionsList = document.getElementById('sessions-list');
            const allSessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            
            if (allSessions.length === 0) {
                sessionsList.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 20px;">No sessions found. Complete a quiz to see your history!</p>';
                sessionsList.style.display = 'block';
                return;
            }
            
            sessionsList.innerHTML = '';
            sessionsList.style.display = 'block';
            
            // Show sessions in reverse order (newest first)
            allSessions.reverse().forEach((session, index) => {
                const sessionCard = document.createElement('div');
                sessionCard.className = 'stats-card';
                sessionCard.style.marginBottom = '15px';
                sessionCard.style.cursor = 'pointer';
                sessionCard.style.transition = 'all 0.2s';
                
                const date = new Date(session.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                // Determine session rating color
                const accuracy = parseFloat(session.accuracy);
                let acColor = '#ff9500';
                if (accuracy >= 90) acColor = '#4caf50';
                else if (accuracy >= 75) acColor = '#00ff9f';
                else if (accuracy >= 60) acColor = '#00bfff';
                
                sessionCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 18px; font-weight: bold; color: #00bfff;">${session.topic.toUpperCase()}</div>
                            <div style="font-size: 12px; color: #8b949e;">${dateStr}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; font-weight: bold; color: ${acColor};">${session.accuracy}%</div>
                            <div style="font-size: 12px; color: #8b949e;">Accuracy</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 13px;">
                        <div style="text-align: center;">
                            <div style="color: #4caf50; font-weight: bold;">${session.correct}</div>
                            <div style="color: #8b949e;">Correct</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #f44336; font-weight: bold;">${session.wrong}</div>
                            <div style="color: #8b949e;">Wrong</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #00bfff; font-weight: bold;">${session.questions}</div>
                            <div style="color: #8b949e;">Questions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #ff9500; font-weight: bold;">${session.avgTime}s</div>
                            <div style="color: #8b949e;">Avg Time</div>
                        </div>
                    </div>
                `;
                
                sessionCard.onmouseover = () => sessionCard.style.background = '#252d38';
                sessionCard.onmouseout = () => sessionCard.style.background = '#1c2128';
                
                // Click to expand and show detailed history
                sessionCard.onclick = () => toggleSessionDetails(session, sessionCard);
                
                sessionsList.appendChild(sessionCard);
            });
        }

        // Toggle session details view
        function toggleSessionDetails(session, card) {
            const existingDetails = card.querySelector('.session-details');
            
            if (existingDetails) {
                existingDetails.remove();
                return;
            }
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'session-details';
            detailsDiv.style.marginTop = '15px';
            detailsDiv.style.paddingTop = '15px';
            detailsDiv.style.borderTop = '1px solid #30363d';
            
            if (session.history && session.history.length > 0) {
                detailsDiv.innerHTML = '<div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #00bfff;">Question Breakdown:</div>';
                
                session.history.forEach((item, idx) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.padding = '8px';
                    itemDiv.style.margin = '5px 0';
                    itemDiv.style.background = '#0d1117';
                    itemDiv.style.borderRadius = '6px';
                    itemDiv.style.fontSize = '13px';
                    itemDiv.style.borderLeft = `3px solid ${item.isCorrect ? '#4caf50' : '#f44336'}`;
                    
                    let ratingColor = '#ff9500';
                    if (item.speedRating.includes('Genius')) ratingColor = '#FFD700';
                    else if (item.speedRating.includes('Excellent')) ratingColor = '#00ff9f';
                    else if (item.speedRating.includes('Good')) ratingColor = '#00bfff';
                    
                    itemDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${item.isCorrect ? 'âœ“' : 'âœ—'} ${item.question}</span>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                ${!item.isCorrect ? `<span style="color: #f44336;">${item.userAnswer}</span> â†’ <span style="color: #4caf50;">${item.correctAnswer}</span>` : ''}
                                <span style="color: ${ratingColor}; font-weight: bold;">${item.time.toFixed(2)}s</span>
                            </div>
                        </div>
                    `;
                    
                    detailsDiv.appendChild(itemDiv);
                });
            } else {
                detailsDiv.innerHTML = '<p style="color: #8b949e; text-align: center;">No detailed history available for this session.</p>';
            }
            
            card.appendChild(detailsDiv);
        }

        // Restart Quiz
        function restartQuiz() {
            if (currentTopic === 'table' && quizConfig.tableType) {
                startTableQuiz(quizConfig.tableType);
            } else if (['addition','subtraction','add-sub-mixed'].includes(currentTopic)) {
                startAdditionQuiz(currentTopic);
            } else if (currentTopic && currentTopic.startsWith('trig-')) {
                startTrigQuiz(currentTopic);
            } else if (currentTopic === 'square') {
                startSquareQuiz();
            } else if (currentTopic === 'cube') {
                startCubeQuiz();
            } else if (currentTopic === 'percentage') {
                startPercentageQuiz(quizConfig.pctMode || 'frac-to-pct');
            } else if (currentTopic === 'pythagorean') {
                startPythagQuiz(quizConfig.pythagMode || 'find-any');
            } else {
                startQuiz(quizState.topic);
            }
        }

        // Back to Home
        function backToHome() {
            showMainContent();
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            if (currentTopic === 'table' && quizConfig.tableType) {
                document.getElementById('table-section').classList.add('active');
                updateTablePreview();
            } else if (['addition','subtraction','add-sub-mixed'].includes(currentTopic)) {
                document.getElementById('addition-section').classList.add('active');
                updateAdditionPreview();
            } else if (currentTopic && currentTopic.startsWith('trig-')) {
                document.getElementById('trigonometry-section').classList.add('active');
            } else if (currentTopic === 'square') {
                document.getElementById('square-section').classList.add('active');
                updateSquarePreview();
            } else if (currentTopic === 'cube') {
                document.getElementById('cube-section').classList.add('active');
                updateCubePreview();
            } else if (currentTopic === 'sqrt') {
                document.getElementById('sqrt-section').classList.add('active');
                updateSqrtPreview();
            } else if (currentTopic === 'cbrt') {
                document.getElementById('cbrt-section').classList.add('active');
                updateCbrtPreview();
            } else if (currentTopic === 'percentage') {
                document.getElementById('percentage-section').classList.add('active');
            } else if (currentTopic === 'pythagorean') {
                document.getElementById('pythagorean-section').classList.add('active');
            } else {
                document.getElementById('practice-section').classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            }
        }

        // Update Stats Display
        function updateStatsDisplay() {
            const accuracy = stats.totalQuestions > 0 
                ? ((stats.correctAnswers / stats.totalQuestions) * 100).toFixed(2)
                : '0.00';
            const avgTime = stats.totalQuestions > 0 
                ? (stats.totalTime / stats.totalQuestions).toFixed(2)
                : '0.00';

            ['today', 'week', 'practice'].forEach(prefix => {
                const attemptedEl = document.getElementById(`${prefix}-attempted`);
                const accuracyEl = document.getElementById(`${prefix}-accuracy`);
                const avgtimeEl = document.getElementById(`${prefix}-avgtime`);
                
                if (attemptedEl) attemptedEl.textContent = stats.totalQuestions;
                if (accuracyEl) accuracyEl.textContent = accuracy + '%';
                if (avgtimeEl) avgtimeEl.textContent = avgTime + 's';
            });

            document.getElementById('total-questions').textContent = stats.totalQuestions;
            document.getElementById('correct-answers').textContent = stats.correctAnswers;
            document.getElementById('wrong-answers').textContent = stats.wrongAnswers;
            document.getElementById('skipped-answers').textContent = stats.skippedAnswers;
            document.getElementById('summary-accuracy').textContent = accuracy + '%';
            document.getElementById('summary-avgtime').textContent = avgTime + ' sec';
        }

        // Keyboard Support - CRITICAL for speed
        document.addEventListener('keydown', (e) => {
            // Only handle keys when quiz is active
            if (!document.getElementById('quiz-section').classList.contains('active')) {
                return;
            }
            
            // Prevent default for keys we handle
            if (['0','1','2','3','4','5','6','7','8','9','Enter','Backspace','Delete'].includes(e.key)) {
                e.preventDefault();
            }
            
            // Number keys 0-9
            if (e.key >= '0' && e.key <= '9') {
                // If in options mode, switch to numpad mode automatically
                if (showingMultipleChoice) {
                    switchToNumpad();
                }
                addDigit(e.key);
            }
            
            // Enter key - Submit answer
            else if (e.key === 'Enter') {
                submitAnswer();
            }
            
            // Backspace/Delete - Remove last digit
            else if (e.key === 'Backspace' || e.key === 'Delete') {
                backspace();
            }
            
            // Tab - Toggle between numpad and options (if available)
            else if (e.key === 'Tab' && document.getElementById('input-mode-selector').style.display === 'flex') {
                e.preventDefault();
                if (showingMultipleChoice) {
                    switchToNumpad();
                } else {
                    switchToOptions();
                }
            }
            
            // Arrow keys for multiple choice navigation
            else if (showingMultipleChoice && ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
                const buttons = Array.from(document.querySelectorAll('.option-btn:not([disabled])'));
                if (buttons.length === 0) return;
                
                let currentIndex = buttons.findIndex(btn => btn.classList.contains('selected'));
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    currentIndex = (currentIndex + 1) % buttons.length;
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    currentIndex = currentIndex <= 0 ? buttons.length - 1 : currentIndex - 1;
                }
                
                const selectedBtn = buttons[currentIndex];
                if (selectedBtn) {
                    selectOption(parseInt(selectedBtn.textContent), selectedBtn);
                }
            }
        });

        // Original Enter key support (kept for compatibility)
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.getElementById('quiz-section').classList.contains('active')) {
                submitAnswer();
            }
        });

        // Click outside modal to close
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('config-modal');
            if (e.target === modal) {
                closeConfigModal();
            }
        });

        // ========================================
        // ERROR PRACTICE SECTION FUNCTIONS
        // ========================================

        // Topic/Section Configuration for Error Practice
        const ERROR_SECTIONS = {
            'square': { name: 'Square (xÂ²)', icon: 'ðŸ“' },
            'cube': { name: 'Cube (xÂ³)', icon: 'ðŸ§Š' },
            'sqrt': { name: 'Square Root (âˆš)', icon: 'âˆš' },
            'cbrt': { name: 'Cube Root (âˆ›)', icon: 'âˆ›' },
            'addition': { name: 'Addition (+)', icon: 'âž•' },
            'subtraction': { name: 'Subtraction (âˆ’)', icon: 'âž–' },
            'multiplication': { name: 'Multiplication (Ã—)', icon: 'âœ–ï¸' },
            'division': { name: 'Division (Ã·)', icon: 'âž—' },
            'fraction': { name: 'Fractions', icon: 'ðŸ”¢' },
            'percentage': { name: 'Percentage (%)', icon: '%' },
            'table': { name: 'Tables', icon: 'ðŸ“‹' },
            'pythagorean': { name: 'Pythagorean', icon: 'ðŸ“' },
            'trigonometry': { name: 'Trigonometry', icon: 'ðŸ“' },
            'bodmas': { name: 'BODMAS Multi-Step', icon: 'ðŸ§®' }
        };

        // Load error statistics from quiz history
        function loadErrorStatistics() {
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            const errorStats = {};

            // Initialize all sections
            Object.keys(ERROR_SECTIONS).forEach(key => {
                errorStats[key] = {
                    totalErrors: 0,
                    totalAttempts: 0,
                    errors: []
                };
            });

            // Parse sessions and collect errors
            sessions.forEach(session => {
                const topic = session.topic || 'unknown';
                const history = session.history || [];

                history.forEach(item => {
                    // Determine section from question type or topic
                    let section = mapTopicToSection(topic, item);

                    if (errorStats[section]) {
                        errorStats[section].totalAttempts++;

                        if (!item.isCorrect) {
                            errorStats[section].totalErrors++;
                            errorStats[section].errors.push({
                                question: item.question,
                                userAnswer: item.userAnswer,
                                correctAnswer: item.correctAnswer,
                                time: item.time,
                                timestamp: session.timestamp
                            });
                        }
                    }
                });
            });

            return errorStats;
        }

        // Map topic/question to section
        function mapTopicToSection(topic, item) {
            // Direct topic mappings
            if (topic === 'square') return 'square';
            if (topic === 'cube') return 'cube';
            if (topic === 'sqrt') return 'sqrt';
            if (topic === 'cbrt') return 'cbrt';
            if (topic === 'addition' || topic.includes('add')) return 'addition';
            if (topic === 'subtraction' || topic.includes('sub')) return 'subtraction';
            if (topic === 'multiplication' || topic.includes('mult')) return 'multiplication';
            if (topic === 'division' || topic.includes('div')) return 'division';
            if (topic === 'fraction') return 'fraction';
            if (topic === 'percentage') return 'percentage';
            if (topic === 'table') return 'table';
            if (topic === 'pythagorean') return 'pythagorean';
            if (topic.includes('trig')) return 'trigonometry';

            // Try to detect from question pattern
            const q = item.question || '';
            if (q.includes('Â²')) return 'square';
            if (q.includes('Â³')) return 'cube';
            if (q.includes('âˆš') && !q.includes('âˆ›')) return 'sqrt';
            if (q.includes('âˆ›')) return 'cbrt';
            if (q.includes('+')) return 'addition';
            if (q.includes('âˆ’') || (q.includes('-') && !q.includes('='))) return 'subtraction';
            if (q.includes('Ã—') || (q.includes('*') && !q.includes('='))) return 'multiplication';
            if (q.includes('Ã·') || q.includes('/')) return 'division';
            if (q.includes('%')) return 'percentage';
            if (q.includes('sin') || q.includes('cos') || q.includes('tan')) return 'trigonometry';

            return 'multiplication'; // default fallback
        }

        // Render error sections in the Error Practice page
        function renderErrorSections() {
            const errorStats = loadErrorStatistics();
            const container = document.getElementById('errorSectionsContainer');
            const emptyState = document.getElementById('emptyState');

            // Calculate overall stats
            let totalErrors = 0;
            let totalAttempts = 0;
            Object.values(errorStats).forEach(stat => {
                totalErrors += stat.totalErrors;
                totalAttempts += stat.totalAttempts;
            });

            // Update overall stats display
            document.getElementById('error-total-errors').textContent = totalErrors;
            document.getElementById('error-total-attempts').textContent = totalAttempts;
            document.getElementById('error-overall-accuracy').textContent = 
                totalAttempts > 0 ? ((totalAttempts - totalErrors) / totalAttempts * 100).toFixed(1) + '%' : '0%';

            // Show empty state if no errors
            if (totalErrors === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            emptyState.style.display = 'none';

            // Render sections with errors
            const sectionsWithErrors = Object.entries(errorStats)
                .filter(([key, stat]) => stat.totalErrors > 0)
                .sort((a, b) => b[1].totalErrors - a[1].totalErrors); // Sort by error count

            if (sectionsWithErrors.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #8b949e;">No errors found in any section!</div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'error-sections-grid';

            sectionsWithErrors.forEach(([sectionKey, stat]) => {
                const section = ERROR_SECTIONS[sectionKey];
                if (!section) return;

                const accuracy = ((stat.totalAttempts - stat.totalErrors) / stat.totalAttempts * 100).toFixed(1);

                const card = document.createElement('div');
                card.className = 'error-section-card has-errors';
                card.innerHTML = `
                    <div class="error-section-icon">${section.icon}</div>
                    <div class="error-section-name">${section.name}</div>
                    <div class="error-count">
                        <span class="error-count-badge">${stat.totalErrors} error${stat.totalErrors !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="error-accuracy">${accuracy}% accuracy</div>
                `;

                card.onclick = () => showErrorDetails(sectionKey, section, stat);
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        // Show error details modal
        function showErrorDetails(sectionKey, section, stat) {
            const modal = document.getElementById('errorDetailsModal');
            const modalTitle = document.getElementById('errorModalTitle');
            const errorDetailsList = document.getElementById('errorDetailsList');
            const practiceBtn = document.getElementById('practiceErrorTopicBtn');

            modalTitle.textContent = `${section.icon} ${section.name} Errors`;

            // Add info about practice mode
            const infoBox = document.createElement('div');
            infoBox.style.background = 'rgba(0, 191, 255, 0.1)';
            infoBox.style.border = '1px solid rgba(0, 191, 255, 0.3)';
            infoBox.style.borderRadius = '8px';
            infoBox.style.padding = '12px';
            infoBox.style.marginBottom = '15px';
            infoBox.style.fontSize = '13px';
            infoBox.style.color = '#00bfff';
            infoBox.innerHTML = `ðŸ’¡ <strong>Error Practice Mode:</strong> You'll practice ${Math.min(10, stat.errors.length)} questions based on your mistakes.`;

            // Render error list (show last 20 errors)
            errorDetailsList.innerHTML = '';
            errorDetailsList.appendChild(infoBox);
            const errorsToShow = stat.errors.slice(-20).reverse(); // Show most recent first

            errorsToShow.forEach(error => {
                const div = document.createElement('div');
                div.className = 'error-detail-item';
                div.innerHTML = `
                    <div class="error-question">${error.question}</div>
                    <div class="error-answers">
                        <span class="user-answer">Your: ${error.userAnswer || 'Skipped'}</span>
                        <span class="arrow">â†’</span>
                        <span class="correct-answer">Correct: ${error.correctAnswer}</span>
                    </div>
                    <div style="font-size: 11px; color: #8b949e; margin-top: 5px;">
                        Time: ${error.time ? error.time.toFixed(2) + 's' : 'N/A'}
                    </div>
                `;
                errorDetailsList.appendChild(div);
            });

            if (stat.errors.length > 20) {
                const moreDiv = document.createElement('div');
                moreDiv.style.textAlign = 'center';
                moreDiv.style.color = '#8b949e';
                moreDiv.style.fontSize = '12px';
                moreDiv.style.marginTop = '10px';
                moreDiv.textContent = `... and ${stat.errors.length - 20} more errors`;
                errorDetailsList.appendChild(moreDiv);
            }

            // Setup practice button to practice ONLY wrong questions
            practiceBtn.onclick = () => {
                closeErrorDetailsModal();
                // Start error-focused quiz with only the wrong questions
                startErrorPracticeQuiz(sectionKey, stat.errors);
            };

            modal.classList.add('active');
        }

        // Close error details modal
        function closeErrorDetailsModal() {
            document.getElementById('errorDetailsModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('errorDetailsModal');
            if (e.target === modal) {
                closeErrorDetailsModal();
            }
        });

        // ========================================
        // START ERROR PRACTICE QUIZ (WRONG QUESTIONS ONLY)
        // ========================================
        function startErrorPracticeQuiz(sectionKey, errors) {
            // Prepare the quiz with questions from errors
            currentTopic = sectionKey;
            quizState.topic = sectionKey;
            quizState.questions = [];
            quizState.currentQuestion = 0;
            quizState.correctAnswers = 0;
            quizState.wrongAnswers = 0;
            quizState.skippedAnswers = 0;
            quizState.questionHistory = [];

            // Extract unique questions from errors and shuffle them
            const uniqueQuestions = [...new Set(errors.map(e => e.question))];
            const shuffledQuestions = uniqueQuestions.sort(() => Math.random() - 0.5);
            
            // Take up to 10 questions (or all if less than 10)
            const practiceQuestions = shuffledQuestions.slice(0, Math.min(10, shuffledQuestions.length));

            // Parse each question to extract the problem and answer
            practiceQuestions.forEach(questionText => {
                const parsed = parseQuestionFromText(questionText, sectionKey);
                if (parsed) {
                    quizState.questions.push(parsed);
                }
            });

            // If no questions could be parsed, generate similar questions based on error patterns
            if (quizState.questions.length === 0) {
                // Fall back to generating similar questions
                generateSimilarQuestionsFromErrors(sectionKey, errors);
            }

            // Start the quiz
            if (quizState.questions.length > 0) {
                // Update quiz title to show it's error practice
                const sectionName = ERROR_SECTIONS[sectionKey]?.name || sectionKey;
                document.getElementById('quiz-topic-title').textContent = `ðŸŽ¯ Error Practice: ${sectionName}`;
                document.getElementById('quiz-topic-title').style.color = '#ff4d6d';
                
                showQuizSection();
                loadQuestion();
            } else {
                alert('No practice questions available for this section.');
            }
        }

        // Parse question text back into question object
        function parseQuestionFromText(questionText, topic) {
            try {
                // Remove the "= ?" part and split
                const parts = questionText.replace('= ?', '').trim().split(/[\+\-\Ã—\Ã·\Â²\Â³âˆšâˆ›%]/);
                
                if (topic === 'square') {
                    const match = questionText.match(/(\d+)Â²/);
                    if (match) {
                        const num = parseInt(match[1]);
                        return { num1: num, num2: null, question: questionText, answer: num * num };
                    }
                } else if (topic === 'cube') {
                    const match = questionText.match(/(\d+)Â³/);
                    if (match) {
                        const num = parseInt(match[1]);
                        return { num1: num, num2: null, question: questionText, answer: num * num * num };
                    }
                } else if (topic === 'sqrt') {
                    const match = questionText.match(/âˆš(\d+)/);
                    if (match) {
                        const num = parseInt(match[1]);
                        return { num1: num, num2: null, question: questionText, answer: Math.sqrt(num) };
                    }
                } else if (topic === 'cbrt') {
                    const match = questionText.match(/âˆ›(\d+)/);
                    if (match) {
                        const num = parseInt(match[1]);
                        return { num1: num, num2: null, question: questionText, answer: Math.cbrt(num) };
                    }
                } else if (topic === 'addition') {
                    const match = questionText.match(/(\d+)\s*\+\s*(\d+)/);
                    if (match) {
                        const num1 = parseInt(match[1]);
                        const num2 = parseInt(match[2]);
                        return { num1, num2, question: questionText, answer: num1 + num2 };
                    }
                } else if (topic === 'subtraction') {
                    const match = questionText.match(/(\d+)\s*[âˆ’\-]\s*(\d+)/);
                    if (match) {
                        const num1 = parseInt(match[1]);
                        const num2 = parseInt(match[2]);
                        return { num1, num2, question: questionText, answer: num1 - num2 };
                    }
                } else if (topic === 'multiplication' || topic === 'table') {
                    const match = questionText.match(/(\d+)\s*[Ã—\*]\s*(\d+)/);
                    if (match) {
                        const num1 = parseInt(match[1]);
                        const num2 = parseInt(match[2]);
                        return { num1, num2, question: questionText, answer: num1 * num2 };
                    }
                } else if (topic === 'division') {
                    const match = questionText.match(/(\d+)\s*[Ã·\/]\s*(\d+)/);
                    if (match) {
                        const num1 = parseInt(match[1]);
                        const num2 = parseInt(match[2]);
                        return { num1, num2, question: questionText, answer: Math.floor(num1 / num2) };
                    }
                } else if (topic === 'percentage') {
                    const match = questionText.match(/(\d+)%\s*of\s*(\d+)/);
                    if (match) {
                        const percent = parseInt(match[1]);
                        const num = parseInt(match[2]);
                        return { num1: percent, num2: num, question: questionText, answer: (percent * num) / 100 };
                    }
                }
                
                return null;
            } catch (e) {
                console.error('Error parsing question:', e);
                return null;
            }
        }

        // Generate similar questions based on error patterns
        function generateSimilarQuestionsFromErrors(topic, errors) {
            // Extract number ranges from errors
            const numbers = [];
            errors.forEach(error => {
                const nums = error.question.match(/\d+/g);
                if (nums) {
                    numbers.push(...nums.map(n => parseInt(n)));
                }
            });

            if (numbers.length === 0) return;

            const min = Math.min(...numbers);
            const max = Math.max(...numbers);
            const count = Math.min(10, errors.length * 2);

            // Generate questions in similar range
            for (let i = 0; i < count; i++) {
                const num1 = Math.floor(Math.random() * (max - min + 1)) + min;
                const num2 = topic !== 'square' && topic !== 'cube' && topic !== 'sqrt' && topic !== 'cbrt'
                    ? Math.floor(Math.random() * (max - min + 1)) + min
                    : null;

                let question, answer;

                switch(topic) {
                    case 'square':
                        question = `${num1}Â² = ?`;
                        answer = num1 * num1;
                        break;
                    case 'cube':
                        question = `${num1}Â³ = ?`;
                        answer = num1 * num1 * num1;
                        break;
                    case 'sqrt':
                        const sq = num1 * num1;
                        question = `âˆš${sq} = ?`;
                        answer = num1;
                        break;
                    case 'cbrt':
                        const cb = num1 * num1 * num1;
                        question = `âˆ›${cb} = ?`;
                        answer = num1;
                        break;
                    case 'addition':
                        question = `${num1} + ${num2} = ?`;
                        answer = num1 + num2;
                        break;
                    case 'subtraction':
                        question = `${Math.max(num1, num2)} âˆ’ ${Math.min(num1, num2)} = ?`;
                        answer = Math.max(num1, num2) - Math.min(num1, num2);
                        break;
                    case 'multiplication':
                    case 'table':
                        question = `${num1} Ã— ${num2} = ?`;
                        answer = num1 * num2;
                        break;
                    case 'division':
                        const dividend = num1 * num2;
                        question = `${dividend} Ã· ${num2} = ?`;
                        answer = num1;
                        break;
                    case 'percentage':
                        question = `${num1}% of ${num2} = ?`;
                        answer = Math.round((num1 * num2) / 100);
                        break;
                    default:
                        continue;
                }

                quizState.questions.push({ num1, num2, question, answer });
            }
        }

        // Show quiz section
        function showQuizSection() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('quiz-section').classList.add('active');
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.progress-line').style.display = 'none';
            document.querySelector('.bottom-nav').style.display = 'none';
        }

        // ========================================
        // PERFORMANCE SECTION IMPROVEMENTS
        // ========================================

        // Global variable to track current date range
        let currentDateRange = {
            type: '1week',
            startDate: null,
            endDate: null
        };

        // Initialize date range on page load
        function initializeDateRange() {
            const now = new Date();
            currentDateRange.endDate = now;
            currentDateRange.startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            updateDateRangeDisplay();
        }

        // Set date range and update all stats
        function setDateRange(rangeType) {
            currentDateRange.type = rangeType;
            const now = new Date();
            currentDateRange.endDate = now;

            // Calculate start date based on range type
            switch(rangeType) {
                case '1week':
                    currentDateRange.startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '1month':
                    currentDateRange.startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case '6months':
                    currentDateRange.startDate = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
                    break;
                case '1year':
                    currentDateRange.startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
            }

            // Update UI
            updateDateRangeDisplay();
            updateAllPerformanceStats();

            // Update button active state
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Update date range display
        function updateDateRangeDisplay() {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            const startStr = currentDateRange.startDate.toLocaleDateString('en-US', options);
            const endStr = currentDateRange.endDate.toLocaleDateString('en-US', options);
            document.getElementById('date-range').textContent = `${startStr} - ${endStr}`;
        }

        // Open custom date range picker
        function openCustomDateRange() {
            const start = prompt('Enter start date (YYYY-MM-DD):', currentDateRange.startDate.toISOString().split('T')[0]);
            if (!start) return;

            const end = prompt('Enter end date (YYYY-MM-DD):', currentDateRange.endDate.toISOString().split('T')[0]);
            if (!end) return;

            currentDateRange.type = 'custom';
            currentDateRange.startDate = new Date(start);
            currentDateRange.endDate = new Date(end);

            // Remove active class from all buttons
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));

            updateDateRangeDisplay();
            updateAllPerformanceStats();
        }

        // Calculate stats for today only
        function getTodayStats() {
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todaySessions = sessions.filter(s => {
                const sessionDate = new Date(s.date);
                sessionDate.setHours(0, 0, 0, 0);
                return sessionDate.getTime() === today.getTime();
            });

            return calculateStatsFromSessions(todaySessions);
        }

        // Calculate stats for this week
        function getWeekStats() {
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            const weekSessions = sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= weekAgo && sessionDate <= now;
            });

            return calculateStatsFromSessions(weekSessions);
        }

        // Calculate stats from selected date range
        function getDateRangeStats() {
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');

            const rangeSessions = sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= currentDateRange.startDate && sessionDate <= currentDateRange.endDate;
            });

            return calculateStatsFromSessions(rangeSessions);
        }

        // Calculate stats from array of sessions
        function calculateStatsFromSessions(sessions) {
            if (sessions.length === 0) {
                return {
                    totalQuestions: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    totalTime: 0,
                    accuracy: 0,
                    avgTime: 0
                };
            }

            let totalQuestions = 0;
            let correctAnswers = 0;
            let wrongAnswers = 0;
            let skippedAnswers = 0;
            let totalTime = 0;

            sessions.forEach(session => {
                totalQuestions += parseInt(session.questions) || 0;
                correctAnswers += parseInt(session.correct) || 0;
                wrongAnswers += parseInt(session.wrong) || 0;
                totalTime += parseFloat(session.totalTime) || (parseFloat(session.avgTime) * parseInt(session.questions)) || 0;
                
                // Calculate skipped if available in history
                if (session.history) {
                    const skipped = session.history.filter(h => h.userAnswer === '' || h.userAnswer === null).length;
                    skippedAnswers += skipped;
                }
            });

            const accuracy = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(2) : 0;
            const avgTime = totalQuestions > 0 ? (totalTime / totalQuestions).toFixed(2) : 0;

            return {
                totalQuestions,
                correctAnswers,
                wrongAnswers,
                skippedAnswers,
                totalTime,
                accuracy,
                avgTime
            };
        }

        // Update all performance stats
        function updateAllPerformanceStats() {
            // Update Today stats
            const todayStats = getTodayStats();
            document.getElementById('today-attempted').textContent = todayStats.totalQuestions;
            document.getElementById('today-accuracy').textContent = todayStats.accuracy + '%';
            document.getElementById('today-avgtime').textContent = todayStats.avgTime + 's';
            document.getElementById('practice-attempted').textContent = todayStats.totalQuestions;
            document.getElementById('practice-accuracy').textContent = todayStats.accuracy + '%';
            document.getElementById('practice-avgtime').textContent = todayStats.avgTime + 's';

            // Update Weekly stats
            const weekStats = getWeekStats();
            document.getElementById('week-attempted').textContent = weekStats.totalQuestions;
            document.getElementById('week-accuracy').textContent = weekStats.accuracy + '%';
            document.getElementById('week-avgtime').textContent = weekStats.avgTime + 's';

            // Update Summary (based on selected date range)
            const rangeStats = getDateRangeStats();
            document.getElementById('total-questions').textContent = rangeStats.totalQuestions;
            document.getElementById('correct-answers').textContent = rangeStats.correctAnswers;
            document.getElementById('wrong-answers').textContent = rangeStats.wrongAnswers;
            document.getElementById('skipped-answers').textContent = rangeStats.skippedAnswers;
            document.getElementById('summary-accuracy').textContent = rangeStats.accuracy + '%';
            document.getElementById('summary-avgtime').textContent = rangeStats.avgTime + ' sec';

            // Update module-wise stats
            updateModuleStats();

            // Update performance chart
            updatePerformanceChart();
        }

        // Update module-wise stats
        function updateModuleStats() {
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            const rangeSessions = sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= currentDateRange.startDate && sessionDate <= currentDateRange.endDate;
            });

            if (rangeSessions.length === 0) {
                document.getElementById('module-stats-container').innerHTML = 
                    '<div style="padding: 40px; text-align: center; color: #8b949e;">No data available for the selected date range.</div>';
                return;
            }

            // Group sessions by topic
            const moduleData = {};
            rangeSessions.forEach(session => {
                const topic = session.topic || 'unknown';
                if (!moduleData[topic]) {
                    moduleData[topic] = {
                        totalQuestions: 0,
                        correct: 0,
                        wrong: 0,
                        totalTime: 0,
                        sessions: 0
                    };
                }
                moduleData[topic].totalQuestions += parseInt(session.questions) || 0;
                moduleData[topic].correct += parseInt(session.correct) || 0;
                moduleData[topic].wrong += parseInt(session.wrong) || 0;
                moduleData[topic].totalTime += parseFloat(session.totalTime) || (parseFloat(session.avgTime) * parseInt(session.questions)) || 0;
                moduleData[topic].sessions += 1;
            });

            // Sort by total questions (most practiced first)
            const sortedModules = Object.entries(moduleData).sort((a, b) => b[1].totalQuestions - a[1].totalQuestions);

            // Generate HTML
            let html = '<div style="display: grid; gap: 15px;">';
            sortedModules.forEach(([topic, data]) => {
                const accuracy = data.totalQuestions > 0 ? ((data.correct / data.totalQuestions) * 100).toFixed(1) : 0;
                const avgTime = data.totalQuestions > 0 ? (data.totalTime / data.totalQuestions).toFixed(2) : 0;
                
                let acColor = '#ff9500';
                if (accuracy >= 90) acColor = '#4caf50';
                else if (accuracy >= 75) acColor = '#00ff9f';
                else if (accuracy >= 60) acColor = '#00bfff';

                html += `
                    <div style="background: #0d1117; padding: 18px; border-radius: 12px; border-left: 4px solid ${acColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 16px; font-weight: bold; color: #00bfff; text-transform: capitalize;">${topic}</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${acColor};">${accuracy}%</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 13px;">
                            <div style="text-align: center;">
                                <div style="color: white; font-weight: bold;">${data.totalQuestions}</div>
                                <div style="color: #8b949e;">Questions</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #4caf50; font-weight: bold;">${data.correct}</div>
                                <div style="color: #8b949e;">Correct</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #f44336; font-weight: bold;">${data.wrong}</div>
                                <div style="color: #8b949e;">Wrong</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #ff9500; font-weight: bold;">${avgTime}s</div>
                                <div style="color: #8b949e;">Avg Time</div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #8b949e; text-align: center;">
                            ${data.sessions} session${data.sessions !== 1 ? 's' : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('module-stats-container').innerHTML = html;
        }

        // Update performance over time chart
        function updatePerformanceChart() {
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            const rangeSessions = sessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate >= currentDateRange.startDate && sessionDate <= currentDateRange.endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (rangeSessions.length === 0) {
                document.getElementById('performance-chart-container').innerHTML = 
                    '<div style="padding: 40px; text-align: center; color: #8b949e;">No data available for the selected date range.</div>';
                return;
            }

            // Group sessions by date
            const dailyData = {};
            rangeSessions.forEach(session => {
                const date = new Date(session.date);
                const dateKey = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = {
                        totalQuestions: 0,
                        correct: 0,
                        wrong: 0
                    };
                }
                dailyData[dateKey].totalQuestions += parseInt(session.questions) || 0;
                dailyData[dateKey].correct += parseInt(session.correct) || 0;
                dailyData[dateKey].wrong += parseInt(session.wrong) || 0;
            });

            // Generate simple bar chart
            let html = '<div style="padding: 20px;">';
            html += '<div style="font-size: 14px; color: #8b949e; margin-bottom: 20px;">Daily Activity Overview</div>';
            
            const maxQuestions = Math.max(...Object.values(dailyData).map(d => d.totalQuestions));
            
            Object.entries(dailyData).forEach(([date, data]) => {
                const accuracy = data.totalQuestions > 0 ? ((data.correct / data.totalQuestions) * 100).toFixed(0) : 0;
                const barHeight = (data.totalQuestions / maxQuestions) * 100;
                
                let barColor = '#ff9500';
                if (accuracy >= 90) barColor = '#4caf50';
                else if (accuracy >= 75) barColor = '#00ff9f';
                else if (accuracy >= 60) barColor = '#00bfff';

                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 13px;">
                            <span style="color: #8b949e;">${date}</span>
                            <span style="color: white; font-weight: bold;">${data.totalQuestions} questions â€¢ ${accuracy}% accuracy</span>
                        </div>
                        <div style="background: #0d1117; height: 25px; border-radius: 6px; overflow: hidden;">
                            <div style="background: ${barColor}; height: 100%; width: ${barHeight}%; transition: width 0.3s ease; border-radius: 6px;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('performance-chart-container').innerHTML = html;
        }

        // Initialize
        loadStats();
        updateStatsDisplay();
        initializeDateRange();
        updateAllPerformanceStats();
        loadUserProfile();
        loadAppSettings();
        updateAccountStats();

        // ========================================
        // ACCOUNT SECTION FUNCTIONS
        // ========================================

        // User profile management
        function loadUserProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{"name":"Speed Math User","email":"user@speedmath.app","photo":""}');
            
            document.getElementById('profile-display-name').textContent = profile.name;
            document.getElementById('profile-display-email').textContent = profile.email;
            
            if (profile.photo) {
                document.getElementById('profile-photo-img').src = profile.photo;
            }
        }

        function saveUserProfile(profile) {
            localStorage.setItem('userProfile', JSON.stringify(profile));
        }

        function editProfile() {
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{"name":"Speed Math User","email":"user@speedmath.app"}');
            
            const newName = prompt('Enter your name:', profile.name);
            if (newName === null) return; // User cancelled
            
            const newEmail = prompt('Enter your email:', profile.email);
            if (newEmail === null) return; // User cancelled
            
            profile.name = newName.trim() || 'Speed Math User';
            profile.email = newEmail.trim() || 'user@speedmath.app';
            
            saveUserProfile(profile);
            loadUserProfile();
            
            alert('âœ… Profile updated successfully!');
        }

        function changeProfilePhoto() {
            alert('ðŸ“· Profile Photo Feature\n\nTo change your profile photo:\n1. Use an image hosting service\n2. Copy the image URL\n3. Paste it when prompted\n\nOr you can use emojis as your avatar!');
            
            const choice = prompt('Choose option:\n1. Enter image URL\n2. Choose emoji\n\nEnter 1 or 2:');
            
            if (choice === '1') {
                const imageUrl = prompt('Enter image URL:');
                if (imageUrl) {
                    const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    profile.photo = imageUrl;
                    saveUserProfile(profile);
                    document.getElementById('profile-photo-img').src = imageUrl;
                    alert('âœ… Profile photo updated!');
                }
            } else if (choice === '2') {
                const emoji = prompt('Enter your favorite emoji:', 'ðŸ˜Š');
                if (emoji) {
                    const svgPhoto = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%2300bfff' width='120' height='120'/%3E%3Ctext x='50%25' y='50%25' font-size='60' text-anchor='middle' dy='.3em'%3E${emoji}%3C/text%3E%3C/svg%3E`;
                    const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    profile.photo = svgPhoto;
                    saveUserProfile(profile);
                    document.getElementById('profile-photo-img').src = svgPhoto;
                    alert('âœ… Profile photo updated!');
                }
            }
        }

        // App settings management
        function loadAppSettings() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{"sound":false,"vibration":false,"autoNext":true}');
            
            // Update toggle switches
            if (settings.sound) document.getElementById('sound-toggle').classList.add('active');
            if (settings.vibration) document.getElementById('vibration-toggle').classList.add('active');
            if (settings.autoNext) document.getElementById('auto-next-toggle').classList.add('active');
        }

        function toggleSetting(setting) {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{"sound":false,"vibration":false,"autoNext":true}');
            
            settings[setting] = !settings[setting];
            localStorage.setItem('appSettings', JSON.stringify(settings));
            
            // Update UI
            const toggleId = setting + '-toggle';
            const toggle = document.getElementById(toggleId);
            if (settings[setting]) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            // Provide feedback
            if (settings.sound && setting === 'sound') {
                // Play a test sound
                alert('ðŸ”Š Sound enabled!');
            }
            
            if (settings.vibration && setting === 'vibration') {
                // Trigger vibration if supported
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
        }

        // Update account statistics
        function updateAccountStats() {
            const sessions = JSON.parse(localStorage.getItem('speedMathSessions') || '[]');
            
            let totalQuestions = 0;
            let correctAnswers = 0;
            
            sessions.forEach(session => {
                totalQuestions += parseInt(session.questions) || 0;
                correctAnswers += parseInt(session.correct) || 0;
            });
            
            const accuracy = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(1) : 0;
            
            document.getElementById('account-total-sessions').textContent = sessions.length;
            document.getElementById('account-total-questions').textContent = totalQuestions;
            document.getElementById('account-overall-accuracy').textContent = accuracy + '%';
        }

        // Export data
        function exportData() {
            const data = {
                profile: JSON.parse(localStorage.getItem('userProfile') || '{}'),
                settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
                stats: JSON.parse(localStorage.getItem('speedMathStats') || '{}'),
                sessions: JSON.parse(localStorage.getItem('speedMathSessions') || '[]'),
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `speed-math-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('âœ… Data exported successfully!\n\nYour backup file has been downloaded.');
        }

        // Import data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Validate data
                        if (!data.version || !data.sessions) {
                            alert('âŒ Invalid backup file format.');
                            return;
                        }
                        
                        // Confirm before overwriting
                        const confirm = window.confirm('âš ï¸ This will replace all your current data with the backup.\n\nDo you want to continue?');
                        if (!confirm) return;
                        
                        // Restore data
                        if (data.profile) localStorage.setItem('userProfile', JSON.stringify(data.profile));
                        if (data.settings) localStorage.setItem('appSettings', JSON.stringify(data.settings));
                        if (data.stats) localStorage.setItem('speedMathStats', JSON.stringify(data.stats));
                        if (data.sessions) localStorage.setItem('speedMathSessions', JSON.stringify(data.sessions));
                        
                        alert('âœ… Data imported successfully!\n\nThe page will now reload.');
                        location.reload();
                    } catch (error) {
                        alert('âŒ Error reading backup file:\n' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Clear all data
        function clearAllData() {
            const confirm1 = window.confirm('âš ï¸ WARNING: This will delete ALL your progress, stats, and sessions.\n\nAre you absolutely sure?');
            if (!confirm1) return;
            
            const confirm2 = window.confirm('âš ï¸ LAST CHANCE: This action CANNOT be undone!\n\nType YES in the next prompt to confirm.');
            if (!confirm2) return;
            
            const finalConfirm = prompt('Type "DELETE" to permanently erase all data:');
            if (finalConfirm !== 'DELETE') {
                alert('âŒ Deletion cancelled.');
                return;
            }
            
            // Clear all localStorage
            localStorage.removeItem('speedMathStats');
            localStorage.removeItem('speedMathSessions');
            // Keep user profile and settings
            
            alert('âœ… All quiz data has been deleted.\n\nThe page will now reload.');
            location.reload();
        }

        // Sign out
        function signOut() {
            const confirm = window.confirm('Are you sure you want to sign out?\n\nYour data will remain saved locally.');
            if (!confirm) return;
            
            alert('ðŸ‘‹ Signed out successfully!\n\nThank you for using Speed Math!');
            
            // In a real app, this would clear session tokens
            // For now, we'll just reload the page
            location.reload();
        }

        // Show help
        function showHelp() {
            alert('ðŸ“š SPEED MATH HELP\n\n' +
                  'ðŸŽ¯ PRACTICE: Choose topics and difficulty\n' +
                  'ðŸ“Š PERFORMANCE: Track your progress\n' +
                  'ðŸ“– REVISION: Review concepts\n' +
                  'ðŸ‘¤ ACCOUNT: Manage profile & data\n\n' +
                  'ðŸ’¡ TIPS:\n' +
                  'â€¢ Practice daily for best results\n' +
                  'â€¢ Use Error Practice for weak areas\n' +
                  'â€¢ Review your stats regularly\n' +
                  'â€¢ Export data for backup\n\n' +
                  'For more help, visit our website!');
        }

        // Show privacy policy
        function showPrivacyPolicy() {
            alert('ðŸ”’ PRIVACY POLICY\n\n' +
                  'Speed Math respects your privacy:\n\n' +
                  'âœ… All data stored locally on your device\n' +
                  'âœ… No data sent to external servers\n' +
                  'âœ… No tracking or analytics\n' +
                  'âœ… No account required\n' +
                  'âœ… Export/delete data anytime\n\n' +
                  'Your progress belongs to YOU!\n\n' +
                  'Data stored:\n' +
                  'â€¢ Quiz results & history\n' +
                  'â€¢ Settings & preferences\n' +
                  'â€¢ Profile information\n\n' +
                  'We never collect personal data!\n' +
                  'Last updated: February 2026');
        }


    </script>
</body>
